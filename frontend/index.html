<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omnix AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Crimson+Text:wght@400;600&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.opendyslexic.org/css/opendyslexic-regular.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Monaco Editor for Code Canvas -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background: linear-gradient(135deg, #f7f7f5 0%, #f0f0ed 50%, #f7f7f5 100%);
            color: #1a1a1a;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            display: flex;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main Content Container */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .main-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(193, 123, 71, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .main-content.sidebar-open {
            margin-left: 260px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: -260px;
            top: 0;
            width: 260px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px) saturate(1.1);
            -webkit-backdrop-filter: blur(20px) saturate(1.1);
            border-right: 1px solid rgba(229, 229, 229, 0.8);
            z-index: 1000;
            transition: left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.12), inset -1px 0 0 rgba(255, 255, 255, 0.5);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-close {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: #666;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .sidebar-close:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        .new-chat-btn {
            background: linear-gradient(135deg, #c17b47 0%, #d18759 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            margin: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(193, 123, 71, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.025em;
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, #d18759 0%, #c17b47 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(193, 123, 71, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .new-chat-btn:hover::before {
            left: 100%;
        }

        .new-chat-btn:active {
            transform: translateY(-1px) scale(1.01);
        }

        .chat-history-section {
            flex: 1;
            overflow-y: auto;
            padding: 0 1rem;
        }

        .chat-history-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            margin: 1rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chat-item {
            padding: 0.875rem 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            margin-bottom: 0.375rem;
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(193, 123, 71, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .chat-item:hover {
            background: rgba(248, 248, 248, 0.8);
            backdrop-filter: blur(10px);
            border-left-color: #c17b47;
            transform: translateX(4px);
            box-shadow: 0 2px 12px rgba(193, 123, 71, 0.15);
        }

        .chat-item:hover::before {
            left: 100%;
        }

        .chat-item.active {
            background: linear-gradient(135deg, rgba(193, 123, 71, 0.1) 0%, rgba(209, 135, 89, 0.1) 100%);
            border-left-color: #c17b47;
            box-shadow: 0 2px 16px rgba(193, 123, 71, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .chat-item-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-item-time {
            font-size: 0.75rem;
            color: #666;
        }

        /* Sidebar Mini Version */
        .sidebar-mini {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(229, 229, 229, 0.8);
            border-radius: 16px;
            padding: 0.875rem 0.5rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            backdrop-filter: blur(20px) saturate(1.2);
            -webkit-backdrop-filter: blur(20px) saturate(1.2);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.875rem;
            width: 56px;
        }

        .sidebar-mini:hover {
            background: rgba(255, 255, 255, 0.98);
            border-color: rgba(193, 123, 71, 0.6);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(193, 123, 71, 0.2), 0 8px 24px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .sidebar-mini.sidebar-open {
            left: 271px;
        }

        .mini-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .mini-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(193, 123, 71, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
        }

        .mini-icon:hover {
            transform: scale(1.15);
            color: #c17b47;
        }

        .mini-icon:hover::before {
            opacity: 1;
        }

        .mini-settings {
            background: #f8f8f8;
            color: #666;
            border: 1px solid #e5e5e5;
            font-size: 0.7rem;
        }

        .mini-settings:hover {
            background: #f0f0f0;
            color: #c17b47;
        }

        .mini-new-chat {
            background: #c17b47;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mini-new-chat:hover {
            background: #a66939;
        }

        .mini-profile {
            background: #e5e5e5;
            color: #666;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .mini-profile:hover {
            background: #d5d5d5;
        }

        .mini-expand {
            background: transparent;
            color: #666;
            font-size: 0.8rem;
            border: none;
            margin-top: 0.25rem;
        }

        .mini-expand:hover {
            color: #c17b47;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            max-width: 840px;
            margin: 0 auto;
            padding: 2.5rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .welcome-screen::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(193, 123, 71, 0.05) 0%, rgba(193, 123, 71, 0.02) 40%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: gentle-pulse 8s ease-in-out infinite;
        }

        @keyframes gentle-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }

        .welcome-header {
            margin-bottom: 3.5rem;
            position: relative;
        }

        .welcome-header::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #c17b47, transparent);
            border-radius: 1px;
        }

        .omnix-icon {
            font-size: 1.75rem;
            margin-bottom: 1.75rem;
            color: #c17b47;
            filter: drop-shadow(0 2px 8px rgba(193, 123, 71, 0.3));
            animation: icon-glow 4s ease-in-out infinite;
        }

        @keyframes icon-glow {
            0%, 100% { filter: drop-shadow(0 2px 8px rgba(193, 123, 71, 0.3)); }
            50% { filter: drop-shadow(0 4px 16px rgba(193, 123, 71, 0.5)); }
        }

        .welcome-title {
            font-size: clamp(2.5rem, 6vw, 3.75rem);
            font-weight: 800;
            color: #2c2c2c;
            margin-bottom: 1.5rem;
            text-align: center;
            letter-spacing: -0.025em;
            line-height: 1.1;
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 50%, #1a1a1a 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: title-gradient 4s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes title-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: #666;
            font-weight: 300;
        }

        /* Input Container */
        .welcome-input-container {
            width: 100%;
            max-width: 640px;
            margin: 2.5rem 0;
            position: relative;
        }

        .welcome-input-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(135deg, rgba(193, 123, 71, 0.1) 0%, rgba(209, 135, 89, 0.1) 100%);
            border-radius: 20px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .welcome-input-container:hover::before {
            opacity: 1;
        }

        .input-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(1.1);
            -webkit-backdrop-filter: blur(20px) saturate(1.1);
            border: 1px solid rgba(229, 229, 229, 0.8);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: visible;
        }

        .input-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(193, 123, 71, 0.05), transparent);
            transition: left 0.6s ease;
        }

        .input-wrapper:hover {
            border-color: rgba(193, 123, 71, 0.6);
            box-shadow: 0 8px 32px rgba(193, 123, 71, 0.12), 0 4px 20px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transform: translateY(-2px) scale(1.01);
        }

        .input-wrapper:hover::before {
            left: 100%;
        }

        .input-wrapper:focus-within {
            border-color: #c17b47;
            box-shadow: 0 0 0 4px rgba(193, 123, 71, 0.15), 0 8px 32px rgba(193, 123, 71, 0.2), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-3px) scale(1.02);
        }

        #welcome-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background: transparent;
            min-height: 60px;
            padding: 8px 12px;
            margin-bottom: 45px;
            text-align: left;
            display: block;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #welcome-input::placeholder {
            color: #999;
        }

        .welcome-left-controls {
            position: absolute;
            left: 8px;
            bottom: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .welcome-right-controls {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .welcome-control-btn {
            background: rgba(248, 248, 248, 0.95);
            border: 1px solid rgba(229, 229, 229, 0.8);
            border-radius: 8px;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
            font-size: 0.95rem;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .welcome-control-btn:hover {
            background: rgba(240, 240, 240, 0.98);
            border-color: rgba(193, 123, 71, 0.6);
            color: #c17b47;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .welcome-control-btn i {
            transition: transform 0.2s ease;
        }


        .send-button {
            background: #c17b47;
            color: white;
            border: 1px solid #c17b47;
        }

        .send-button:hover {
            background: #a66939;
        }

        .send-button:disabled {
            background: #ddd;
            cursor: not-allowed;
        }

        /* Mode Buttons */
        .mode-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px) saturate(1.1);
            -webkit-backdrop-filter: blur(12px) saturate(1.1);
            border: 1px solid rgba(229, 229, 229, 0.8);
            border-radius: 12px;
            padding: 0.875rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            text-decoration: none;
            min-width: 120px;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(193, 123, 71, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .mode-btn:hover {
            border-color: rgba(193, 123, 71, 0.6);
            background: rgba(254, 252, 250, 0.95);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 24px rgba(193, 123, 71, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        .mode-btn:hover::before {
            left: 100%;
        }

        .mode-btn:active {
            transform: translateY(-1px) scale(1.01);
        }

        .mode-btn.selected {
            background: linear-gradient(135deg, #c17b47 0%, #d18759 100%);
            color: white;
            border-color: #c17b47;
            box-shadow: 0 4px 20px rgba(193, 123, 71, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .mode-btn.selected i {
            color: white !important;
        }

        .mode-btn i {
            font-size: 0.875rem;
            color: #c17b47;
            filter: drop-shadow(0 1px 2px rgba(193, 123, 71, 0.2));
            transition: all 0.3s ease;
        }

        .mode-btn:hover i {
            transform: scale(1.1);
            filter: drop-shadow(0 2px 4px rgba(193, 123, 71, 0.3));
        }

        /* Chat Interface */
        .chat-interface {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-interface.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 0;
            padding-bottom: 12rem;
            width: 100%;
            margin: 0;
            max-width: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Custom scrollbar positioned at screen edge */
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: rgba(193, 123, 71, 0.3) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(193, 123, 71, 0.3);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(193, 123, 71, 0.5);
            background-clip: content-box;
        }

        /* Omnix Maxima Indicator */
        .omnix-maxima-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(128, 128, 128, 0.2);
            color: rgba(128, 128, 128, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(128, 128, 128, 0.1);
            display: none;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .omnix-maxima-indicator.active {
            display: flex;
        }

        .omnix-maxima-indicator:hover {
            background: rgba(128, 128, 128, 0.3);
            color: rgba(128, 128, 128, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(128, 128, 128, 0.15);
        }

        .omnix-maxima-icon {
            font-size: 1rem;
        }

        /* Code Execution Container */
        .code-execution-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .code-execution-header {
            background: #343a40;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .code-execution-content {
            padding: 1rem;
        }

        .code-execution-output {
            background: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-top: 1rem;
        }

        .thinking-process {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #f39c12;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .thinking-process-header {
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .thinking-process-content {
            color: #7a5e00;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Code Canvas for Interactive Coding */
        .code-canvas {
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 12px;
            margin: 1rem 0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .code-canvas-header {
            background: #2d2d2d;
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #404040;
        }

        .code-canvas-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #c17b47;
        }

        .code-canvas-actions {
            display: flex;
            gap: 0.5rem;
        }

        .code-action-btn {
            background: #404040;
            color: #ffffff;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .code-action-btn:hover {
            background: #c17b47;
            transform: translateY(-1px);
        }

        .code-action-btn.run-btn {
            background: #28a745;
        }

        .code-action-btn.run-btn:hover {
            background: #218838;
        }

        .code-canvas-content {
            display: flex;
            flex-direction: column;
        }

        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            padding: 1rem;
            border: none;
            outline: none;
            resize: vertical;
            min-height: 200px;
            white-space: pre;
            overflow-x: auto;
        }

        .code-output {
            background: #0d1117;
            color: #e6edf3;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            padding: 1rem;
            border-top: 1px solid #404040;
            min-height: 60px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .code-output.error {
            background: #2d1b1b;
            color: #f8d7da;
            border-top: 1px solid #721c24;
        }

        .code-output.success {
            background: #1b2d1b;
            color: #d4edda;
            border-top: 1px solid #1e7e34;
        }

        /* Code Canvas Responsive */
        @media (max-width: 768px) {
            .code-canvas-header {
                padding: 0.5rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .code-editor {
                font-size: 0.8rem;
                min-height: 150px;
            }
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .run-code-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .run-code-btn:hover {
            background: #218838;
        }

        /* Thinking Canvas */
        .thinking-canvas {
            background: transparent;
            border: 1px solid #c17b47;
            border-radius: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .thinking-canvas-header {
            background: transparent;
            color: #1a1a1a;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
        }

        .thinking-canvas-header:hover {
            background: #5a6268;
        }

        .thinking-canvas-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .live-indicator {
            font-size: 0.7rem;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse-live 2s infinite;
        }

        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .thinking-canvas-toggle {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .thinking-canvas-toggle.expanded {
            transform: rotate(180deg);
        }

        .thinking-canvas-content {
            max-height: 0;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }

        .thinking-canvas-content.expanded {
            max-height: 500px;
        }

        .thinking-canvas-content::-webkit-scrollbar {
            width: 8px;
        }

        .thinking-canvas-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .thinking-canvas-content::-webkit-scrollbar-thumb {
            background: rgba(193, 123, 71, 0.5);
            border-radius: 4px;
        }

        .thinking-canvas-content::-webkit-scrollbar-thumb:hover {
            background: rgba(193, 123, 71, 0.8);
        }

        .thinking-canvas-inner {
            padding: 1rem;
        }

        .thinking-step {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #6c757d;
        }

        .thinking-step-header {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }

        .thinking-step-content {
            color: #6c757d;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Backend Log Styles */
        .backend-log {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .backend-log.log-thinking {
            border-left-color: #6f42c1;
            background: #faf8ff;
        }

        .backend-log.log-success {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .backend-log.log-planning {
            border-left-color: #ffc107;
            background: #fffdf0;
        }

        .backend-log.log-reasoning {
            border-left-color: #17a2b8;
            background: #f0fbff;
        }

        .backend-log.log-error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .backend-log.log-warning {
            border-left-color: #fd7e14;
            background: #fff8f0;
        }

        .log-icon {
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        .log-message {
            flex: 1;
            font-weight: 500;
        }

        .log-timestamp {
            font-size: 0.7rem;
            color: #6c757d;
            opacity: 0.8;
            font-family: 'Courier New', monospace;
        }

        .thinking-step-header {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .log-details {
            font-size: 0.7rem;
            color: #868e96;
            margin-top: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        /* Live log animation */
        .backend-log {
            animation: logAppear 0.3s ease-in;
        }

        @keyframes logAppear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .live-response {
            font-family: inherit;
            line-height: 1.6;
        }

        .detailed-thinking-container {
            margin-top: 1rem;
            border-top: 1px solid #e9ecef;
            padding-top: 1rem;
        }

        .detailed-thinking-header {
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .detailed-thinking-header:hover {
            background: #f8f9fa;
        }

        .detailed-thinking-toggle {
            transition: transform 0.3s ease;
        }

        .detailed-thinking-toggle.expanded {
            transform: rotate(180deg);
        }

        .detailed-thinking-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding-left: 1rem;
            border-left: 2px solid #e9ecef;
            margin-left: 0.5rem;
        }

        .detailed-thinking-content.expanded {
            max-height: 1000px; /* Adjust as needed */
            padding-top: 0.5rem;
        }

        .detail-section {
            margin-bottom: 1rem;
        }

        .detail-section-title {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.5rem;
        }

        .detail-section-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .detailed-thinking-container {
            margin-top: 1rem;
            border-top: 1px solid #e9ecef;
            padding-top: 1rem;
        }

        .detailed-thinking-header {
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .detailed-thinking-header:hover {
            background: #f8f9fa;
        }

        .detailed-thinking-toggle {
            transition: transform 0.3s ease;
        }

        .detailed-thinking-toggle.expanded {
            transform: rotate(180deg);
        }

        .detailed-thinking-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding-left: 1rem;
            border-left: 2px solid #e9ecef;
            margin-left: 0.5rem;
        }

        .detailed-thinking-content.expanded {
            max-height: 1000px; /* Adjust as needed */
            padding-top: 0.5rem;
        }

        .detail-section {
            margin-bottom: 1rem;
        }

        .detail-section-title {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.5rem;
        }

        .detail-section-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #c17b47;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Force scrollbar to screen edge by removing margin/padding on right */
        .chat-interface {
            padding-right: 0;
            margin-right: 0;
        }

        body {
            padding-right: 0;
            margin-right: 0;
        }

        /* Messages */
        .message {
            margin-bottom: 2rem;
            max-width: 740px;
            width: 100%;
            padding: 0 2rem;
            position: relative;
            animation: message-fade-in 0.6s ease-out;
        }

        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-avatar {
            background: #e5e5e5;
            color: #666;
        }

        .ai-avatar {
            background: #c17b47;
            color: white;
        }

        .message-role {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
        }

        .message-content {
            font-size: 1.05rem;
            line-height: 1.75;
            color: #1a1a1a;
            margin-left: 40px;
            position: relative;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px) saturate(1.1);
            -webkit-backdrop-filter: blur(10px) saturate(1.1);
            border-radius: 16px;
            border: 1px solid rgba(229, 229, 229, 0.6);
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .message-content:hover {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        /* AI Messages - No bubble styling, background text only */
        .ai-message .message-content {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            padding: 0.5rem 0 !important;
            margin-left: 0 !important;
            font-weight: 400 !important;
            opacity: 0.9;
            color: #4a4a4a !important;
        }

        .ai-message .message-content:hover {
            background: transparent !important;
            box-shadow: none !important;
            transform: none !important;
            opacity: 1;
        }

        /* Hide AI message header (avatar and role) */
        .ai-message .message-header {
            display: none !important;
        }

        /* AI message overall styling */
        .ai-message {
            background: transparent;
            border: none;
            box-shadow: none;
            margin-bottom: 1.5rem;
            animation: ai-message-fade-in 0.8s ease-out;
        }
        
        @keyframes ai-message-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI message code blocks - subtle styling */
        .ai-message .message-content pre {
            background: rgba(248, 248, 248, 0.6) !important;
            border: 1px solid rgba(229, 229, 229, 0.4) !important;
            border-radius: 8px !important;
            margin: 1rem 0 !important;
        }

        .ai-message .message-content code {
            background: rgba(248, 248, 248, 0.6) !important;
            border: 1px solid rgba(229, 229, 229, 0.3) !important;
            border-radius: 4px !important;
        }

        .message-content pre {
            background: rgba(248, 248, 248, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(229, 229, 229, 0.8);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.25rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .message-content pre:hover {
            background: rgba(248, 248, 248, 1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        .message-content code {
            background: rgba(248, 248, 248, 0.9);
            backdrop-filter: blur(5px);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(229, 229, 229, 0.6);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .message-content code:hover {
            background: rgba(248, 248, 248, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-0.5px);
        }

        /* Input Area - Floating and Transparent */
        .chat-input-area {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: transparent;
            border: none;
            padding: 0;
            z-index: 1000;
            width: 740px;
            max-width: 92%;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .chat-input-area::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(ellipse at center, rgba(193, 123, 71, 0.03) 0%, transparent 60%);
            border-radius: 30px;
            z-index: -1;
        }

        .chat-input-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(25px) saturate(1.2);
            -webkit-backdrop-filter: blur(25px) saturate(1.2);
            border: 1px solid rgba(229, 229, 229, 0.4);
            border-radius: 16px;
            padding: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chat-input-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(193, 123, 71, 0.5);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 0 0 3px rgba(193, 123, 71, 0.1);
        }

        #chat-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background: transparent;
            min-height: 60px;
            max-height: 300px;
            padding: 8px 12px;
            margin-bottom: 45px;
            text-align: left;
            display: block;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #chat-input::placeholder {
            color: #999;
        }

        .input-left-controls {
            position: absolute;
            left: 8px;
            bottom: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-right-controls {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-control-btn {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
            font-size: 0.9rem;
        }

        .input-control-btn i {
            transition: transform 0.2s ease;
        }


        .input-control-btn:hover {
            background: #f0f0f0;
            border-color: #c17b47;
            color: #c17b47;
        }

        .model-selector-wrapper {
            position: relative;
            display: inline-block;
            overflow: visible;
        }

        .model-selector-btn {
            background: transparent !important;
            color: #c17b47 !important;
            border: 1px solid #c17b47 !important;
            width: auto !important;
            padding: 0 8px 0 12px !important;
            font-size: 12px;
            font-weight: 600;
            display: flex !important;
            align-items: center;
            gap: 8px;
        }

        .model-selector-btn:hover {
            background: rgba(193, 123, 71, 0.1) !important;
            border-color: #c17b47 !important;
            color: #c17b47 !important;
            transform: translateY(-1px) !important;
        }

        .model-selector-btn i {
            font-size: 10px;
            transition: transform 0.2s ease;
        }

        .model-selector-btn.open i {
            transform: rotate(180deg);
        }

        .model-dropdown {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            min-width: 160px;
            display: none;
            margin-bottom: 4px;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: #f8f8f8;
        }

        .model-option.selected {
            background: #c17b47;
            color: white;
        }

        .model-name {
            display: block;
            font-weight: 600;
            font-size: 13px;
        }

        .model-desc {
            display: block;
            font-size: 11px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .model-option.selected .model-desc {
            opacity: 0.9;
        }


        .chat-send-button {
            background: #c17b47;
            color: white;
            border: 1px solid #c17b47;
        }

        .chat-send-button:hover {
            background: #a66939;
            border-color: #a66939;
        }

        .chat-send-button:disabled {
            background: #ddd;
            border-color: #ddd;
            cursor: not-allowed;
        }

        /* Plus Button Menu */
        .plus-menu {
            position: absolute;
            bottom: 45px;
            left: 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 0.5rem;
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 180px;
        }

        .plus-menu.show {
            display: flex;
        }

        .plus-menu-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: #1a1a1a;
        }

        .plus-menu-item:hover {
            background: #f8f8f8;
        }

        .plus-menu-item i {
            color: #c17b47;
            font-size: 1rem;
            width: 16px;
        }

        /* Recording Panel */
        .recording-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .recording-panel.show {
            display: flex;
        }

        .recording-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .record-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .record-btn:hover {
            background: #dc2626;
        }

        .record-btn.recording {
            animation: pulse 2s infinite;
        }

        .stop-record-btn {
            background: #666;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stop-record-btn:hover {
            background: #555;
        }

        .recording-status {
            color: #666;
            font-size: 0.9rem;
        }

        /* Audio Visualizer */
        .audio-visualizer {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 30px;
            min-width: 100px;
        }

        .audio-bar {
            width: 3px;
            background: #c17b47;
            border-radius: 2px;
            transition: height 0.1s ease;
            min-height: 4px;
        }

        /* File Upload */
        .file-input {
            display: none;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .uploaded-file {
            background: rgba(193, 123, 71, 0.1);
            border: 1px solid rgba(193, 123, 71, 0.3);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #c17b47;
        }

        .uploaded-file .remove-file {
            cursor: pointer;
            color: #999;
            font-size: 0.7rem;
        }

        .uploaded-file .remove-file:hover {
            color: #ef4444;
        }

        /* MCP Connection Dialog */
        .mcp-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .mcp-dialog.show {
            display: flex;
        }

        .mcp-dialog-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .mcp-dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .mcp-dialog-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .mcp-dialog-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .mcp-dialog-close:hover {
            background: #f0f0f0;
        }

        .mcp-connection-type {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mcp-type-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .mcp-type-btn.active {
            border-color: #c17b47;
            background: rgba(193, 123, 71, 0.1);
        }

        .mcp-type-btn:hover {
            border-color: #c17b47;
        }

        .mcp-input-group {
            margin-bottom: 1rem;
        }

        .mcp-input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .mcp-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .mcp-input:focus {
            outline: none;
            border-color: #c17b47;
            box-shadow: 0 0 0 3px rgba(193, 123, 71, 0.1);
        }

        .mcp-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .mcp-dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .mcp-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .mcp-btn-cancel {
            background: white;
            color: #666;
        }

        .mcp-btn-cancel:hover {
            background: #f8f8f8;
        }

        .mcp-btn-connect {
            background: #c17b47;
            color: white;
            border-color: #c17b47;
        }

        .mcp-btn-connect:hover {
            background: #a66939;
        }

        /* Settings Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-content {
            background: var(--modal-bg, #ffffff);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Dark theme support for settings modal - Single Color */
        body.theme-dark .settings-modal {
            background: rgba(45, 45, 45, 0.95) !important;
        }

        body.theme-dark .settings-modal-content {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .settings-header {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            border-radius: 12px 12px 0 0 !important;
            color: #ffffff !important;
        }

        body.theme-dark .settings-header h2 {
            color: #ffffff !important;
        }

        body.theme-dark .settings-close-btn {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
            border-radius: 6px !important;
        }

        body.theme-dark .settings-close-btn:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .settings-sidebar {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            border-radius: 0 0 0 12px !important;
        }

        body.theme-dark .settings-content {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 0 0 12px 0 !important;
        }

        body.theme-dark .settings-nav-item {
            color: #ffffff !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.03) !important;
            background: #2d2d2d !important;
        }

        body.theme-dark .settings-nav-item:hover {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.08) !important;
        }

        body.theme-dark .settings-nav-item.active {
            background: #c17b47 !important;
            color: #ffffff !important;
            border: 1px solid #c17b47 !important;
            box-shadow: 0 0 12px rgba(193, 123, 71, 0.3) !important;
        }

        body.theme-dark .settings-input,
        body.theme-dark .settings-textarea,
        body.theme-dark .settings-select {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .settings-input:focus,
        body.theme-dark .settings-textarea:focus,
        body.theme-dark .settings-select:focus {
            border: 1px solid #c17b47 !important;
            box-shadow: 0 0 12px rgba(193, 123, 71, 0.2) !important;
        }

        body.theme-dark .font-preview {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .theme-option {
            border-color: #2d2d2d !important;
            border-radius: 8px !important;
            background: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .theme-option:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .theme-option.active {
            border: 1px solid #c17b47 !important;
            box-shadow: 0 0 12px rgba(193, 123, 71, 0.3) !important;
        }

        body.theme-dark .voice-option {
            border-color: #2d2d2d !important;
            background: #2d2d2d !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .voice-option:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .voice-option.active {
            background: #c17b47 !important;
            border-radius: 8px !important;
            border: 1px solid #c17b47 !important;
            box-shadow: 0 0 12px rgba(193, 123, 71, 0.3) !important;
        }

        body.theme-dark .suggestion-btn {
            background: #2d2d2d;
            border-color: #2d2d2d;
            color: #ffffff;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .suggestion-btn:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        /* Settings section styling */
        body.theme-dark .settings-section h3 {
            color: #ffffff !important;
        }

        body.theme-dark .settings-label,
        body.theme-dark .settings-sublabel {
            color: #ffffff !important;
        }

        body.theme-dark .settings-group {
            border-radius: 8px !important;
        }

        /* Creativity slider styling */
        body.theme-dark .creativity-slider {
            background: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .creativity-slider::-webkit-slider-thumb {
            background: #c17b47 !important;
            box-shadow: 0 0 8px rgba(193, 123, 71, 0.3) !important;
        }

        body.theme-dark .slider-labels span {
            color: #ffffff !important;
        }

        /* Model toggles */
        body.theme-dark .model-toggle label {
            color: #ffffff !important;
        }

        /* Comprehensive Dark Theme Support - Single Color (#2d2d2d) */
        body.theme-dark {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }

        /* Force dark theme on main containers with rounded corners */
        body.theme-dark .main-content {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 12px !important;
        }

        body.theme-dark .chat-interface {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 12px !important;
        }

        body.theme-dark .chat-input-area {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
        }

        body.theme-dark #chat-input,
        body.theme-dark #welcome-input {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
        }

        body.theme-dark #chat-input::placeholder,
        body.theme-dark #welcome-input::placeholder {
            color: #999999 !important;
        }

        body.theme-dark .message {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
        }

        body.theme-dark .user-message {
            background: #c17b47 !important;
            color: #ffffff !important;
            border-radius: 12px !important;
        }

        body.theme-dark .ai-message {
            background: transparent !important;
            color: #ffffff !important;
            border-radius: 0 !important;
        }

        /* Dark theme - AI messages without bubbles */
        body.theme-dark .ai-message .message-content {
            background: transparent !important;
            color: #cccccc !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            opacity: 0.85;
        }

        body.theme-dark .ai-message .message-content:hover {
            opacity: 1;
            color: #ffffff !important;
        }

        body.theme-dark .ai-message {
            background: transparent !important;
        }
        
        /* Dark theme AI code blocks */
        body.theme-dark .ai-message .message-content pre {
            background: rgba(45, 45, 45, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #cccccc !important;
        }

        body.theme-dark .ai-message .message-content code {
            background: rgba(45, 45, 45, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #cccccc !important;
        }

        body.theme-dark .input-control-btn,
        body.theme-dark .welcome-control-btn {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .input-control-btn:hover,
        body.theme-dark .welcome-control-btn:hover {
            background: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .model-dropdown,
        body.theme-dark .plus-menu,
        body.theme-dark .slider-popup {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 0 8px rgba(255, 255, 255, 0.05) !important;
            z-index: 9999 !important;
        }

        body.theme-dark .model-option:hover,
        body.theme-dark .plus-menu-item:hover,
        body.theme-dark .dropdown-option:hover {
            background: #2d2d2d !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.08) !important;
        }

        body.theme-dark .welcome-title,
        body.theme-dark .welcome-header h1 {
            color: #ffffff !important;
        }

        body.theme-dark .mode-btn {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .mode-btn:hover {
            background: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .sidebar-title,
        body.theme-dark .chat-history-title {
            color: #ffffff !important;
        }

        body.theme-dark .new-chat-btn {
            background: #c17b47 !important;
            color: #ffffff !important;
            border-radius: 8px !important;
        }

        body.theme-dark .mini-icon {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .mini-icon:hover {
            background: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .omnix-maxima-indicator {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 8px !important;
        }

        body.theme-dark .loading-message {
            color: #ffffff !important;
        }

        body.theme-dark .toggle-item-label {
            color: #ffffff !important;
        }

        body.theme-dark .dropdown-title {
            color: #ffffff !important;
        }

        /* Fix Chat Area Dark Mode - More Specific Selectors with Rounded Corners */
        body.theme-dark .chat-messages {
            background: #2d2d2d !important;
            color: #ffffff !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        body.theme-dark .welcome-screen {
            background: #2d2d2d !important;
            color: #ffffff !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        body.theme-dark .input-wrapper {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        body.theme-dark .welcome-input-container {
            background: #2d2d2d !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        body.theme-dark .welcome-input-container .input-wrapper {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        body.theme-dark .chat-input-area {
            background: #2d2d2d !important;
            border-color: #2d2d2d !important;
            opacity: 1 !important;
            border-radius: 12px !important;
        }

        /* Mode buttons text fix */
        body.theme-dark .mode-btn span {
            color: #ffffff !important;
        }

        body.theme-dark .mode-btn i {
            color: #ffffff !important;
        }

        /* Chat area text fix - Remove opacity issues */
        body.theme-dark .chat-messages * {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        body.theme-dark .welcome-screen * {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        body.theme-dark .welcome-screen .omnix-icon {
            color: #c17b47 !important;
            opacity: 1 !important;
        }

        /* Ensure all text elements have full opacity */
        body.theme-dark h1, 
        body.theme-dark h2, 
        body.theme-dark h3, 
        body.theme-dark p, 
        body.theme-dark span, 
        body.theme-dark div {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        /* Input area backgrounds */
        body.theme-dark .chat-input-area {
            background: #2d2d2d !important;
            border-color: #404040 !important;
        }

        body.theme-dark .chat-input-area .input-wrapper {
            background: #2d2d2d !important;
            border-color: #404040 !important;
        }

        /* Ensure all text in chat interface is white with full opacity */
        body.theme-dark .chat-interface,
        body.theme-dark .chat-interface * {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        body.theme-dark .welcome-screen,
        body.theme-dark .welcome-screen * {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        /* Chat interface background consistency */
        body.theme-dark .chat-interface {
            background: #2d2d2d !important;
            color: #ffffff !important;
            opacity: 1 !important;
        }

        /* Keep brand color for specific elements */
        body.theme-dark .welcome-screen .omnix-icon,
        body.theme-dark .user-message,
        body.theme-dark .new-chat-btn {
            color: #ffffff !important;
            opacity: 1 !important;
        }

        /* Ultra-specific targeting for problematic elements with rounded corners */
        body.theme-dark div,
        body.theme-dark section,
        body.theme-dark main,
        body.theme-dark article {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 8px !important;
        }

        /* Target every possible container with consistent styling */
        body.theme-dark .chat-messages,
        body.theme-dark .chat-interface,
        body.theme-dark .welcome-screen,
        body.theme-dark .main-content,
        body.theme-dark #chat-interface,
        body.theme-dark #welcome-screen,
        body.theme-dark #main-content {
            background: #2d2d2d !important;
            color: #ffffff !important;
            background-color: #2d2d2d !important;
            border-radius: 12px !important;
        }

        /* Input areas specific targeting - single color */
        body.theme-dark .chat-input-area,
        body.theme-dark .input-wrapper,
        body.theme-dark .welcome-input-container,
        body.theme-dark .input-container {
            background: #2d2d2d !important;
            background-color: #2d2d2d !important;
            border: 1px solid #2d2d2d !important;
            border-radius: 12px !important;
        }

        /* Live Mode Voice Sphere Dark Theme - Single Color */
        body.theme-dark .live-conversation-overlay {
            background: rgba(45, 45, 45, 0.95) !important;
            color: #ffffff !important;
            border-radius: 12px !important;
        }

        body.theme-dark .live-conversation-container {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-radius: 12px !important;
        }

        body.theme-dark .voice-sphere {
            background: #2d2d2d !important;
            border: 2px solid #2d2d2d !important;
            border-radius: 50% !important;
        }

        /* Fix shifting dots visibility in dark mode */
        body.theme-dark .shifting-dots {
            opacity: 1 !important;
        }

        /* Voice dots - make them more visible in dark mode */
        body.theme-dark .voice-dot {
            background: #ffffff !important;
            opacity: 0.8 !important;
        }

        body.theme-dark .voice-dot.active {
            background: #64C8FF !important;
            opacity: 1 !important;
        }

        body.theme-dark .voice-dot.ai-speaking {
            background: #FF9664 !important;
            opacity: 1 !important;
        }

        body.theme-dark .voice-dot.scattered {
            background: #ffffff !important;
            opacity: 0.9 !important;
        }

        /* If shifting dots use individual dot elements */
        body.theme-dark .shifting-dots .dot,
        body.theme-dark .shifting-dots span {
            background: #ffffff !important;
            opacity: 0.8 !important;
        }

        /* Live mode controls - Single Color */
        body.theme-dark .live-mic-btn {
            background: #c17b47 !important;
            color: #ffffff !important;
            border-color: #c17b47 !important;
            border-radius: 50% !important;
        }

        body.theme-dark .live-transcription {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 12px !important;
        }

        body.theme-dark .transcription-text {
            color: #ffffff !important;
        }

        body.theme-dark .sources-btn {
            background: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #2d2d2d !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .sources-btn:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        /* General button backlight for any missed buttons */
        body.theme-dark button {
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.03) !important;
        }

        body.theme-dark button:hover {
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.08) !important;
        }

        /* Voice preview buttons */
        body.theme-dark .voice-preview-btn {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05) !important;
        }

        body.theme-dark .voice-preview-btn:hover {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) !important;
        }

        .settings-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .settings-header h2 {
            margin: 0;
            color: #1a1a1a;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .settings-close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .settings-close-btn:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        .settings-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .settings-sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e5e5e5;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
            font-weight: 500;
        }

        .settings-nav-item:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        .settings-nav-item.active {
            background: #c17b47;
            color: white;
        }

        .settings-nav-item i {
            width: 16px;
            text-align: center;
        }

        .settings-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section h3 {
            margin: 0 0 1.5rem 0;
            color: #1a1a1a;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .settings-group {
            margin-bottom: 2rem;
        }

        .settings-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .settings-sublabel {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #666;
            font-size: 0.9rem;
        }

        .settings-input, .settings-textarea, .settings-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .settings-input:focus, .settings-textarea:focus, .settings-select:focus {
            outline: none;
            border-color: #c17b47;
        }

        .settings-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Font Selection */
        .font-selector {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .font-preview {
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Theme Selection */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .theme-option {
            text-align: center;
            cursor: pointer;
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .theme-option:hover {
            border-color: #c17b47;
        }

        .theme-option.active {
            border-color: #c17b47;
            background: #f8f4f0;
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .light-preview {
            background: #ffffff;
            border: 1px solid #e5e5e5;
        }

        .dark-preview {
            background: #1a1a1a;
            border: 1px solid #333;
        }

        .system-preview {
            background: linear-gradient(45deg, #ffffff 50%, #1a1a1a 50%);
            border: 1px solid #e5e5e5;
        }

        .theme-preview-header {
            height: 20px;
            background: rgba(193, 123, 71, 0.2);
            border-radius: 4px 4px 0 0;
        }

        .theme-preview-content {
            height: 40px;
            background: rgba(193, 123, 71, 0.1);
            border-radius: 0 0 4px 4px;
        }

        /* Checkbox Row */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #c17b47;
        }

        .checkbox-row .settings-label {
            margin-bottom: 0;
            cursor: pointer;
        }

        /* Creativity Slider */
        .creativity-slider-container {
            margin-bottom: 1rem;
        }

        .creativity-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e5e5;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin-bottom: 0.5rem;
        }

        .creativity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #c17b47;
            cursor: pointer;
        }

        .creativity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #c17b47;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }

        /* Model Toggles */
        .model-toggles {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .model-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .model-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #c17b47;
        }

        /* Voice Selection */
        .voice-selection {
            margin-bottom: 1.5rem;
        }

        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .voice-option {
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-option:hover {
            border-color: #c17b47;
        }

        .voice-option.active {
            border-color: #c17b47;
            background: #f8f4f0;
        }

        .voice-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voice-name {
            font-weight: 500;
        }

        .voice-preview-btn {
            background: #c17b47;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-preview-btn:hover {
            background: #a66939;
            transform: scale(1.1);
        }

        /* Prompt Suggestions */
        .prompt-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .suggestion-btn {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .suggestion-btn:hover {
            background: #c17b47;
            color: white;
            border-color: #c17b47;
        }

        /* Loading indicator */
        .loading-message {
            display: none;
            margin-bottom: 1.5rem;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 36px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: #c17b47;
            border-radius: 50%;
            animation: loadingDots 1.5s infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingDots {
            0%, 80%, 100% { 
                opacity: 0.3; 
                transform: scale(0.8); 
            }
            40% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .welcome-screen {
                padding: 1rem;
            }
            
            .welcome-title {
                font-size: 1.8rem;
            }
            
            .chat-messages {
                padding: 1rem 2% 8rem 2%;
            }
            
            .chat-header {
                padding: 1rem;
            }
            
            .chat-input-area {
                left: 50%;
                transform: translateX(-50%);
                width: 96%;
                max-width: 96%;
                bottom: 1rem;
            }
            
            .mode-buttons {
                gap: 0.5rem;
            }
            
            .mode-btn {
                min-width: auto;
                padding: 0.5rem 1rem;
            }
        }

        /* New Styles for Slider Popup */
        .slider-btn {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
            font-size: 0.9rem;
        }

        .slider-btn:hover {
            background: #f0f0f0;
            border-color: #c17b47;
            color: #c17b47;
        }

        .slider-popup {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 320px;
            max-width: 90vw;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1001;
        }

        .slider-popup.show {
            display: flex;
        }

        .slider-popup::-webkit-scrollbar {
            width: 6px;
        }

        .slider-popup::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .slider-popup::-webkit-scrollbar-thumb {
            background: #c17b47;
            border-radius: 3px;
        }

        .slider-popup::-webkit-scrollbar-thumb:hover {
            background: #a86a3a;
        }

        .slider-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .slider-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .slider-dropdown {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider-dropdown:focus {
            outline: none;
            border-color: #c17b47;
            box-shadow: 0 0 0 3px rgba(193, 123, 71, 0.1);
        }

        .slider-tools-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .slider-tool-item {
            padding: 0.5rem;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .slider-tool-item:hover {
            background: #f8f8f8;
            border-color: #c17b47;
            color: #c17b47;
        }

        .slider-tool-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .slider-tool-group-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .slider-add-btn {
            background: #c17b47;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider-add-btn:hover {
            background: #a66939;
        }

        .hidden {
            display: none !important;
        }

        /* New Enhanced Slider Popup Styles */
        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
            transition: all 0.2s ease;
        }

        .toggle-item:hover {
            background: #f8f8f8;
            border-color: #c17b47;
        }

        .toggle-item-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #c17b47;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .dropdown-section {
            position: relative;
            margin-bottom: 1rem;
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-header:hover {
            background: #f8f8f8;
            border-color: #c17b47;
        }

        .dropdown-header-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-icon {
            color: #c17b47;
        }

        .dropdown-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
            color: #666;
        }

        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
            overflow: visible;
        }

        .dropdown-content.show {
            display: block;
        }


        .dropdown-option {
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: #f8f8f8;
        }

        .dropdown-option.selected {
            background: #c17b47;
            color: white;
        }

        .tools-dropdown-content {
            padding: 0.75rem;
        }

        .tools-section {
            margin-bottom: 1rem;
        }

        .tools-section:last-child {
            margin-bottom: 0;
        }

        .tools-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tools-add-btn {
            width: 100%;
            padding: 0.75rem;
            background: #c17b47;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }

        .tools-add-btn:hover {
            background: #a66939;
        }

        .tools-available-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f8f8f8;
            color: #666;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tools-available-btn:hover {
            background: #f0f0f0;
            border-color: #c17b47;
            color: #c17b47;
        }

        .separator {
            height: 1px;
            background: #e5e5e5;
            margin: 0.75rem 0;
        }

        /* Live Conversation Overlay Styles - Perplexity Style */
        .live-conversation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fefcfa;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            padding: 2rem;
        }

        .live-conversation-overlay.show {
            display: flex;
            opacity: 1;
        }

        .live-conversation-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            width: 100%;
            height: 100%;
            max-width: 600px;
        }

        .live-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e5e5;
            border-radius: 50%;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .live-close-btn:hover {
            border-color: #c17b47;
            color: #c17b47;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .perplexity-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .sources-btn {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            color: #c17b47;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .sources-btn:hover {
            background: #f8f8f8;
            border-color: #c17b47;
        }

        .voice-sphere-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            flex: 1;
            justify-content: center;
        }

        .voice-sphere {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .voice-sphere:hover {
            transform: scale(1.02);
        }

        .voice-sphere.ai-speaking {
            animation: ai-breathing 2s ease-in-out infinite, ai-glow 3s ease-in-out infinite;
        }

        .voice-sphere.user-speaking {
            animation: user-listening 0.8s ease-in-out infinite;
        }

        .voice-sphere.ai-thinking {
            animation: thinking-pulse 1.5s ease-in-out infinite;
        }

        @keyframes userSpeakingPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(100, 200, 255, 0.3);
            }
            100% {
                transform: scale(1.03);
                box-shadow: 0 0 25px rgba(100, 200, 255, 0.6);
            }
        }

        .shifting-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .voice-dot {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #c17b47;
            border-radius: 50%;
            opacity: 0.7;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            will-change: transform, opacity, background-color;
        }

        .voice-dot.scattered {
            animation: scatter 0.6s ease-out;
        }

        .voice-dot.active {
            background: #64C8FF;
            opacity: 1;
        }

        .voice-dot.ai-speaking {
            background: #FF9664;
            opacity: 1;
            animation: audio-wave 2s ease-in-out infinite;
        }

        .voice-dot.ai-thinking {
            background: #F59E0B;
            opacity: 0.8;
            animation: thinking-pulse 1.5s ease-in-out infinite;
        }

        .voice-dot.audio-reactive {
            animation: particle-burst 0.6s ease-out;
        }

        .voice-dot.high-frequency {
            background: #EF4444;
            animation: audio-wave 0.3s ease-in-out infinite;
        }

        .voice-dot.mid-frequency {
            background: #F59E0B;
            animation: audio-wave 0.5s ease-in-out infinite;
        }

        .voice-dot.low-frequency {
            background: #10B981;
            animation: audio-wave 0.8s ease-in-out infinite;
        }

        .voice-dot.wave-animation {
            animation: dotWave 1.2s ease-in-out infinite, aiSpeakingPulse 0.8s ease-in-out infinite alternate;
        }

        @keyframes scatter {
            0% {
                transform: translate(0, 0) scale(1);
            }
            50% {
                transform: translate(var(--scatter-x), var(--scatter-y)) scale(1.5);
                opacity: 1;
            }
            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes aiSpeakingPulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
                box-shadow: 0 0 8px rgba(255, 150, 100, 0.4);
            }
            100% {
                transform: scale(1.3);
                opacity: 1;
                box-shadow: 0 0 15px rgba(255, 150, 100, 0.8);
            }
        }

        @keyframes sphereReaction {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 150, 100, 0.2);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(255, 150, 100, 0.4);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 150, 100, 0.2);
            }
        }

        @keyframes dotWave {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-5px) scale(1.2);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0);
            }
            33% {
                transform: translate(2px, -2px);
            }
            66% {
                transform: translate(-2px, 1px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.95);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            100% {
                transform: scale(1.8);
                opacity: 0;
            }
        }

        @keyframes ai-breathing {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes ai-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(124, 58, 237, 0.6);
            }
        }

        @keyframes user-listening {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(45, 212, 191, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(45, 212, 191, 0.8);
            }
        }

        @keyframes thinking-pulse {
            0%, 100% {
                opacity: 0.8;
                transform: scale(0.98);
            }
            33% {
                opacity: 1;
                transform: scale(1.01);
            }
            66% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        @keyframes audio-wave {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 0.6;
            }
        }

        @keyframes particle-burst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(0.8) rotate(360deg);
                opacity: 0;
            }
        }

        .live-transcription {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin: 1rem 0;
            box-shadow: none;
            border: none;
            min-height: 60px;
            width: 100%;
            max-width: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .transcription-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .transcription-text {
            font-size: 0.9rem;
            color: #1a1a1a;
            line-height: 1.5;
            min-height: 80px;
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
        }

        .conversation-status {
            text-align: center;
            color: #1a1a1a;
            margin-top: 1rem;
        }

        /* Live Controls Styles */
        .live-controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .live-mic-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .live-mic-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .live-mic-btn:active {
            transform: scale(0.98);
        }

        .live-mic-btn.recording {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
            animation: pulse 1.5s infinite;
        }

        .live-mic-btn.listening {
            background: #c17b47;
            color: white;
            border-color: #a66838;
            animation: pulse 2s infinite;
        }

        .live-mic-btn i {
            font-size: 2rem;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(193, 123, 71, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(193, 123, 71, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(193, 123, 71, 0);
            }
        }

        .live-text-input-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            width: 100%;
            max-width: 400px;
        }

        .live-text-input-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .live-text-input-container button {
            padding: 0.75rem 1rem;
            background: #c17b47;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .live-text-input-container button:hover {
            background: #a66838;
        }

        .status-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #c17b47;
        }

        .status-subtitle {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }

        .live-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            background: #c17b47;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(193, 123, 71, 0.3);
            position: relative;
        }

        .mic-button:hover {
            background: #a66939;
            transform: scale(1.05);
        }

        .mic-button:active {
            transform: scale(0.95);
        }

        .mic-button.recording {
            background: #e44;
            animation: recordingPulse 1s infinite;
        }

        .mic-button.muted {
            background: #666;
        }

        @keyframes recordingPulse {
            0%, 100% { box-shadow: 0 4px 16px rgba(238, 68, 68, 0.3); }
            50% { box-shadow: 0 4px 24px rgba(238, 68, 68, 0.6); }
        }

        .hands-free-toggle {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hands-free-toggle.active {
            background: #c17b47;
            color: white;
            border-color: #c17b47;
        }

        /* Responsive design for live conversation */
        @media (max-width: 768px) {
            .voice-sphere {
                width: 250px;
                height: 250px;
            }
            
            .live-conversation-container {
                gap: 1.5rem;
                padding: 1rem;
            }
            
            .live-transcription {
                padding: 1rem;
                min-height: 100px;
            }
            
            .mic-button {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
            
            .status-text {
                font-size: 1.1rem;
            }
            
            .perplexity-header {
                margin-bottom: 1rem;
            }
        }

        /* Advanced Visual Enhancements */
        
        /* Enhanced focus styles */
        *:focus-visible {
            outline: 3px solid rgba(193, 123, 71, 0.4);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Loading animation keyframes */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Global loading state */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(193, 123, 71, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Enhanced button ripple effect */
        .btn:active::after, .new-chat-btn:active::after, .mode-btn:active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                width: 200px;
                height: 200px;
                top: calc(50% - 100px);
                left: calc(50% - 100px);
                opacity: 0;
            }
        }
        
        /* Performance Optimizations */
        .new-chat-btn,
        .mode-btn,
        .chat-item,
        .message,
        .input-wrapper,
        .sidebar-mini,
        .message-content,
        .chat-input-wrapper {
            will-change: transform;
        }
        
        /* Scroll improvements */
        .chat-messages {
            scroll-behavior: smooth;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(193, 123, 71, 0.3);
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(193, 123, 71, 0.5);
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .gentle-pulse,
            .icon-glow,
            .title-gradient,
            .shimmer {
                animation: none !important;
            }
        }

        /* Code Canvas Styles */
        .code-canvas {
            position: fixed;
            top: 0;
            right: -60%;
            width: 60%;
            height: 100vh;
            background: #1e1e1e;
            border-left: 1px solid #333;
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
        }

        .code-canvas.open {
            right: 0;
        }

        .code-canvas-header {
            background: #252525;
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 12px;
        }

        .code-canvas-title {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .code-canvas-tabs {
            display: flex;
            gap: 4px;
        }

        .code-canvas-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .code-canvas-tab.active {
            background: #333;
            color: #fff;
        }

        .code-canvas-tab:hover {
            background: #333;
            color: #fff;
        }

        .code-canvas-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .code-canvas-btn {
            padding: 6px 10px;
            background: #333;
            border: none;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .code-canvas-btn:hover {
            background: #444;
        }

        .code-canvas-btn.primary {
            background: #007acc;
        }

        .code-canvas-btn.primary:hover {
            background: #005a9e;
        }

        .code-canvas-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .code-canvas-close:hover {
            color: #fff;
            background: #333;
        }

        .code-canvas-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .code-editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }

        .code-editor {
            flex: 1;
            min-height: 0;
        }

        .code-preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .code-preview-header {
            padding: 8px 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 8px;
        }

        .code-preview-url {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
        }

        .code-preview-iframe {
            flex: 1;
            border: none;
            background: #fff;
        }

        .code-output {
            background: #000;
            color: #0f0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            padding: 12px;
            overflow-y: auto;
            white-space: pre-wrap;
            flex: 1;
        }

        .code-canvas-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-canvas-loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Code Canvas Integration with Chat */
        .code-canvas-trigger {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #007acc;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .code-canvas-trigger:hover {
            background: #005a9e;
        }

        .message.has-code:hover .code-canvas-trigger {
            display: flex;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .code-canvas {
                width: 100%;
                right: -100%;
            }
            
            .code-canvas-content {
                flex-direction: column;
            }
            
            .code-editor-panel {
                border-right: none;
                border-bottom: 1px solid #333;
                max-height: 50%;
            }
        }
    </style>
    <script src="js/live_voice_client.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-comments"></i>
                Chat History
            </div>
            <button class="sidebar-close" id="sidebar-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <button class="new-chat-btn" id="new-chat-btn">
            <i class="fas fa-plus"></i>
            New Chat
        </button>
        
        <div class="chat-history-section">
            <div class="chat-history-title">Recent Chats</div>
            <div id="chat-history-list">
                <!-- Recent chats will be populated here -->
            </div>
        </div>
    </div>

    <!-- Sidebar Mini Version -->
    <div class="sidebar-mini" id="sidebar-mini">
        <div class="mini-icon mini-settings" id="mini-settings" title="Settings">
            <i class="fas fa-cog"></i>
        </div>
        <div class="mini-icon mini-new-chat" id="mini-new-chat" title="New Chat">
            <i class="fas fa-plus"></i>
        </div>
        <div class="mini-icon mini-profile" id="mini-profile" title="Profile">
            <i class="fas fa-user"></i>
        </div>
        <button class="mini-expand" id="mini-expand" title="Open Sidebar">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-header">
            <div class="omnix-icon" id="omnix-welcome-logo">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBvbHlnb24gcG9pbnRzPSIxMyAyIDMgMTQgMTIgMTQgMTEgMjIgMjEgMTAgMTIgMTAgMTMgMiIgZmlsbD0iI2QxNDYyYSIvPgo8L3N2Zz4K" alt="Omnix AI" style="width: 15%; height: 15%; object-fit: contain;">
            </div>
            <h1 class="welcome-title">How can Omnix AI help you today?</h1>
        </div>

        <div class="welcome-input-container">
            <div class="input-wrapper">
                <!-- Uploaded Files Display -->
                <div class="uploaded-files" id="welcome-uploaded-files"></div>
                
                <!-- Text Input -->
                <textarea id="welcome-input" placeholder="Ask me anything or choose a mode below..." rows="1"></textarea>
                
                <!-- Left Controls (Plus, Mic, and Slider) -->
                <div class="welcome-left-controls">
                    <button class="welcome-control-btn" id="welcome-plus-btn" title="More options">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="welcome-control-btn" id="welcome-mic-btn" title="Voice input">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                <!-- Right Controls (Model Selector, Send) -->
                <div class="welcome-right-controls">
                    <div class="model-selector-wrapper">
                        <button class="welcome-control-btn model-selector-btn" id="welcome-model-selector" title="Select AI Model">
                            <span id="welcome-selected-model">Omnix Flash</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="model-dropdown" id="welcome-model-dropdown">
                            <div class="model-option" data-model="flash">
                                <span class="model-name">Omnix Flash</span>
                                <span class="model-desc">Fast responses</span>
                            </div>
                            <div class="model-option" data-model="maxima">
                                <span class="model-name">Omnix Maxima</span>
                                <span class="model-desc">Complex tasks</span>
                            </div>
                        </div>
                    </div>
                    <button class="welcome-control-btn send-button" id="welcome-send-button" title="Send message">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>

                <!-- Plus Menu for Welcome -->
                <div class="plus-menu" id="welcome-plus-menu" style="bottom: auto; top: 45px; left: 8px;">
                    <div class="plus-menu-item" id="welcome-upload-files">
                        <i class="fas fa-paperclip"></i>
                        <span>Upload Files</span>
                    </div>
                    <div class="plus-menu-item" id="welcome-upload-video">
                        <i class="fas fa-video"></i>
                        <span>Upload Video</span>
                    </div>
                    <div class="plus-menu-item" id="welcome-upload-codebase">
                        <i class="fas fa-code"></i>
                        <span>Upload Codebase</span>
                    </div>
                    <div class="plus-menu-item" id="welcome-take-camera">
                        <i class="fas fa-camera"></i>
                        <span>Take Using Camera</span>
                    </div>
                </div>

            </div>
        </div>

        <div class="mode-buttons">
            <button class="mode-btn" data-mode="research" title="Search the web and get comprehensive research">
                <i class="fas fa-search"></i>
                <span>Research</span>
            </button>
            <button class="mode-btn" data-mode="browser" title="Interactive browser automation and web tasks">
                <i class="fas fa-globe"></i>
                <span>Browser</span>
            </button>
            <button class="mode-btn" data-mode="live" title="Live conversation - mindful AI companion">
                <i class="fas fa-broadcast-tower"></i>
                <span>Live</span>
            </button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface" id="chat-interface">
        <!-- Omnix Maxima Indicator -->
        <div class="omnix-maxima-indicator" id="omnix-maxima-indicator">
            <span>Omnix Maxima</span>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be added here -->
        </div>

        <div class="loading-message" id="loading-message">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input-area">
            <!-- Recording Panel -->
            <div class="recording-panel" id="recording-panel">
                <div class="recording-controls">
                    <button class="record-btn" id="record-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="stop-record-btn" id="stop-record-btn" style="display: none;">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div class="recording-status" id="recording-status">Ready to record</div>
                <div class="audio-visualizer" id="audio-visualizer">
                    <!-- Audio bars will be generated here -->
                </div>
            </div>

            <!-- Uploaded Files Display -->
            <div class="uploaded-files" id="uploaded-files"></div>

            <div class="chat-input-wrapper">
                <textarea id="chat-input" placeholder="Type your message..." rows="1"></textarea>
                
                <!-- Plus Menu -->
                <div class="plus-menu" id="plus-menu">
                    <div class="plus-menu-item" id="upload-files">
                        <i class="fas fa-paperclip"></i>
                        <span>Upload Files</span>
                    </div>
                    <div class="plus-menu-item" id="upload-video">
                        <i class="fas fa-video"></i>
                        <span>Upload Video</span>
                    </div>
                    <div class="plus-menu-item" id="upload-codebase">
                        <i class="fas fa-code"></i>
                        <span>Upload Codebase</span>
                    </div>
                    <div class="plus-menu-item" id="take-camera">
                        <i class="fas fa-camera"></i>
                        <span>Take Using Camera</span>
                    </div>
                </div>
                
                <!-- Left Controls (Plus, Mic, and Slider) -->
                <div class="input-left-controls">
                    <button class="input-control-btn" id="plus-btn" title="More options">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="input-control-btn" id="mic-btn" title="Voice input">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>

                <!-- Right Controls (Model Selector, Send) -->
                <div class="input-right-controls">
                    <div class="model-selector-wrapper">
                        <button class="input-control-btn model-selector-btn" id="chat-model-selector" title="Select AI Model">
                            <span id="chat-selected-model">Omnix Flash</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="model-dropdown" id="chat-model-dropdown">
                            <div class="model-option" data-model="flash">
                                <span class="model-name">Omnix Flash</span>
                                <span class="model-desc">Fast responses</span>
                            </div>
                            <div class="model-option" data-model="maxima">
                                <span class="model-name">Omnix Maxima</span>
                                <span class="model-desc">Complex tasks</span>
                            </div>
                        </div>
                    </div>
                    <button class="input-control-btn chat-send-button" id="chat-send-button" title="Send message">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>

                <!-- Slider Popup -->
                <div class="slider-popup" id="slider-popup">
                    <!-- Feature Toggles -->
                    <div class="toggle-item">
                        <span class="toggle-item-label">Web Search</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="web-search-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-item">
                        <span class="toggle-item-label">Researcher</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="researcher-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-item">
                        <span class="toggle-item-label">Extended Reasoning</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="extended-reasoning-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-item">
                        <span class="toggle-item-label">Sequential Thinking</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sequential-thinking-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="separator"></div>

                    <!-- Styles Dropdown -->
                    <div class="dropdown-section">
                        <div class="dropdown-header" onclick="toggleStylesDropdown(event)">
                            <div class="dropdown-header-content">
                                <i class="fas fa-feather-alt dropdown-icon"></i>
                                <span class="dropdown-title">Styles</span>
                            </div>
                            <i class="fas fa-chevron-down dropdown-arrow" id="styles-arrow"></i>
                        </div>
                        <div class="dropdown-content" id="styles-dropdown">
                            <div class="dropdown-option" onclick="selectStyle('auto')">Auto</div>
                            <div class="dropdown-option" onclick="selectStyle('formal')">Formal</div>
                            <div class="dropdown-option" onclick="selectStyle('explanatory')">Explanatory</div>
                            <div class="dropdown-option" onclick="selectStyle('concise')">Concise</div>
                            <div class="dropdown-option" onclick="selectStyle('friendly')">Friendly</div>
                            <div class="dropdown-option" onclick="selectStyle('custom')">Custom</div>
                        </div>
                    </div>

                    <!-- Tools Dropdown -->
                    <div class="dropdown-section">
                        <div class="dropdown-header" onclick="toggleToolsDropdown(event)">
                            <div class="dropdown-header-content">
                                <i class="fas fa-tools dropdown-icon"></i>
                                <span class="dropdown-title">Tools</span>
                            </div>
                            <i class="fas fa-chevron-down dropdown-arrow" id="tools-arrow"></i>
                        </div>
                        <div class="dropdown-content tools-dropdown-content" id="tools-dropdown">
                            <div class="tools-section">
                                <div class="tools-section-title">MCP</div>
                                <button class="tools-add-btn" onclick="showMcpDialog()">+ Add New MCP</button>
                                <button class="tools-available-btn" onclick="showAvailableMcpTools()">Available MCP <i class="fas fa-chevron-right" style="float: right; margin-top: 2px;"></i></button>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <div class="tools-section">
                                <div class="tools-section-title">Connectors</div>
                                <button class="tools-add-btn" onclick="showConnectorDialog()">+ Add New Connectors</button>
                                <button class="tools-available-btn" onclick="showAvailableConnectors()">Available Connectors</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden File Input -->
            <input type="file" class="file-input" id="file-input" multiple accept="*/*">
            
            <!-- Hidden Welcome File Input -->
            <input type="file" class="file-input" id="welcome-file-input" multiple accept="*/*">
        </div>
    </div>
    </div>


    <!-- MCP Connection Dialog -->
    <div class="mcp-dialog" id="mcp-dialog">
        <div class="mcp-dialog-content">
            <div class="mcp-dialog-header">
                <div class="mcp-dialog-title">MCP Connection</div>
                <button class="mcp-dialog-close" id="mcp-dialog-close">&times;</button>
            </div>
            
            <div class="mcp-connection-type">
                <button class="mcp-type-btn active" id="mcp-type-url">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">URL Connection</div>
                    <div style="font-size: 0.9rem; color: #666;">Connect via WebSocket URL</div>
                </button>
                <button class="mcp-type-btn" id="mcp-type-json">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">JSON Config</div>
                    <div style="font-size: 0.9rem; color: #666;">Provide JSON configuration</div>
                </button>
            </div>
            
            <div id="mcp-url-form">
                <div class="mcp-input-group">
                    <label class="mcp-input-label" for="mcp-url-input">Server URL</label>
                    <input type="text" class="mcp-input" id="mcp-url-input" placeholder="ws://localhost:8080" />
                </div>
                <div class="mcp-input-group">
                    <label class="mcp-input-label" for="mcp-name-input">Connection Name</label>
                    <input type="text" class="mcp-input" id="mcp-name-input" placeholder="My MCP Server" />
                </div>
            </div>
            
            <div id="mcp-json-form" style="display: none;">
                <div class="mcp-input-group">
                    <label class="mcp-input-label" for="mcp-json-input">JSON Configuration</label>
                    <textarea class="mcp-input mcp-textarea" id="mcp-json-input" placeholder='{"url": "ws://localhost:8080", "name": "My Server", "auth": {"token": "..."}}'></textarea>
                </div>
            </div>
            
            <div class="mcp-dialog-actions">
                <button class="mcp-btn mcp-btn-cancel" id="mcp-cancel-btn">Cancel</button>
                <button class="mcp-btn mcp-btn-connect" id="mcp-connect-btn">Connect</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-modal-content">
            <!-- Settings Header -->
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="settings-close-btn" id="settings-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Settings Body -->
            <div class="settings-body">
                <!-- Settings Sidebar -->
                <div class="settings-sidebar">
                    <div class="settings-nav-item active" data-section="appearance">
                        <i class="fas fa-palette"></i>
                        <span>Appearance</span>
                    </div>
                    <div class="settings-nav-item" data-section="personalize">
                        <i class="fas fa-user-cog"></i>
                        <span>Personalize</span>
                    </div>
                    <div class="settings-nav-item" data-section="connectors">
                        <i class="fas fa-plug"></i>
                        <span>Connectors</span>
                    </div>
                    <div class="settings-nav-item" data-section="browser-agent">
                        <i class="fas fa-globe"></i>
                        <span>Browser Agent</span>
                    </div>
                    <div class="settings-nav-item" data-section="privacy">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy</span>
                    </div>
                    <div class="settings-nav-item" data-section="about">
                        <i class="fas fa-info-circle"></i>
                        <span>About us</span>
                    </div>
                    <div class="settings-nav-item" data-section="help">
                        <i class="fas fa-question-circle"></i>
                        <span>Help</span>
                    </div>
                </div>
                
                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- Appearance Section -->
                    <div class="settings-section active" id="appearance-section">
                        <h3>Appearance</h3>
                        
                        <!-- Font Selection -->
                        <div class="settings-group">
                            <label class="settings-label">Font Family</label>
                            <div class="font-selector">
                                <select class="settings-select" id="font-family-select">
                                    <option value="Georgia, 'Times New Roman', Times, serif" selected>Georgia (Default)</option>
                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Crimson Text', serif">Crimson Text</option>
                                    <option value="'Libre Baskerville', serif">Libre Baskerville</option>
                                    <option value="'OpenDyslexic', sans-serif">OpenDyslexic (Dyslexic Friendly)</option>
                                </select>
                                <div class="font-preview" id="font-preview">
                                    The quick brown fox jumps over the lazy dog. 1234567890
                                </div>
                            </div>
                        </div>
                        
                        <!-- Theme Selection -->
                        <div class="settings-group">
                            <label class="settings-label">Theme</label>
                            <div class="theme-options">
                                <div class="theme-option active" data-theme="light">
                                    <div class="theme-preview light-preview">
                                        <div class="theme-preview-header"></div>
                                        <div class="theme-preview-content"></div>
                                    </div>
                                    <span>Light (Default)</span>
                                </div>
                                <div class="theme-option" data-theme="dark">
                                    <div class="theme-preview dark-preview">
                                        <div class="theme-preview-header"></div>
                                        <div class="theme-preview-content"></div>
                                    </div>
                                    <span>Dark</span>
                                </div>
                                <div class="theme-option" data-theme="system">
                                    <div class="theme-preview system-preview">
                                        <div class="theme-preview-header"></div>
                                        <div class="theme-preview-content"></div>
                                    </div>
                                    <span>Use System</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personalize Section -->
                    <div class="settings-section" id="personalize-section">
                        <h3>Personalize</h3>
                        
                        <!-- System Prompt -->
                        <div class="settings-group">
                            <label class="settings-label">Omnix AI System Prompt</label>
                            <textarea class="settings-textarea" id="system-prompt" placeholder="Customize how Omnix AI should behave and respond..."></textarea>
                        </div>
                        
                        <!-- AI Name -->
                        <div class="settings-group">
                            <label class="settings-label">What should we call you?</label>
                            <input type="text" class="settings-input" id="ai-name" placeholder="Omnix AI" value="Omnix AI">
                        </div>
                        
                        <!-- User Description -->
                        <div class="settings-group">
                            <label class="settings-label">Describe yourself</label>
                            <textarea class="settings-textarea" id="user-description" placeholder="Tell Omnix AI about yourself to get more personalized responses..."></textarea>
                        </div>
                        
                        <!-- Learning Toggle -->
                        <div class="settings-group">
                            <div class="checkbox-row">
                                <input type="checkbox" id="ai-learning-toggle" class="settings-checkbox">
                                <label for="ai-learning-toggle" class="settings-label">Let Omnix AI learn you</label>
                            </div>
                        </div>
                        
                        <!-- Creativity Slider -->
                        <div class="settings-group">
                            <label class="settings-label">How creative do you want Omnix AI to be?</label>
                            <div class="creativity-slider-container">
                                <input type="range" class="creativity-slider" id="creativity-slider" min="0" max="100" value="50">
                                <div class="slider-labels">
                                    <span>Conservative</span>
                                    <span>Balanced</span>
                                    <span>Creative</span>
                                </div>
                            </div>
                            
                            <!-- Model Checkboxes -->
                            <div class="model-toggles">
                                <div class="model-toggle">
                                    <input type="checkbox" id="live-voice-model" checked>
                                    <label for="live-voice-model">Live Voice Model</label>
                                </div>
                                <div class="model-toggle">
                                    <input type="checkbox" id="omnix-flash" checked>
                                    <label for="omnix-flash">Omnix Flash</label>
                                </div>
                                <div class="model-toggle">
                                    <input type="checkbox" id="omnix-maxima" checked>
                                    <label for="omnix-maxima">Omnix Maxima</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Conversation Mode -->
                        <div class="settings-group">
                            <label class="settings-label">Live Conversation Mode</label>
                            
                            <!-- Voice Selection -->
                            <div class="voice-selection">
                                <label class="settings-sublabel">Choose Voice</label>
                                <div class="voice-grid">
                                    <div class="voice-option" data-voice="dMyQqiVXTU80dDl2eNK8">
                                        <div class="voice-info">
                                            <span class="voice-name">Eryn</span>
                                            <button class="voice-preview-btn" data-voice-id="dMyQqiVXTU80dDl2eNK8">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option active" data-voice="Hybl6rg76ZOcgqZqN5WN">
                                        <div class="voice-info">
                                            <span class="voice-name">Tala (Default)</span>
                                            <button class="voice-preview-btn" data-voice-id="Hybl6rg76ZOcgqZqN5WN">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="WAhoMTNdLdMoq1j3wf3I">
                                        <div class="voice-info">
                                            <span class="voice-name">Hope</span>
                                            <button class="voice-preview-btn" data-voice-id="WAhoMTNdLdMoq1j3wf3I">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="q0PCqBlLEWqtUZJ2DYn7">
                                        <div class="voice-info">
                                            <span class="voice-name">Jerry</span>
                                            <button class="voice-preview-btn" data-voice-id="q0PCqBlLEWqtUZJ2DYn7">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="ftDdhfYtmfGP0tFlBYA1">
                                        <div class="voice-info">
                                            <span class="voice-name">Alisha</span>
                                            <button class="voice-preview-btn" data-voice-id="ftDdhfYtmfGP0tFlBYA1">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="jqcCZkN6Knx8BJ5TBdYR">
                                        <div class="voice-info">
                                            <span class="voice-name">Zara</span>
                                            <button class="voice-preview-btn" data-voice-id="jqcCZkN6Knx8BJ5TBdYR">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="PpXxSapWoo4j3JoF2LPQ">
                                        <div class="voice-info">
                                            <span class="voice-name">Shubham</span>
                                            <button class="voice-preview-btn" data-voice-id="PpXxSapWoo4j3JoF2LPQ">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="voice-option" data-voice="m7GHBtY0UEqljrKQw2JH">
                                        <div class="voice-info">
                                            <span class="voice-name">Aisha</span>
                                            <button class="voice-preview-btn" data-voice-id="m7GHBtY0UEqljrKQw2JH">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Live Mode System Prompt -->
                            <div class="live-mode-prompt">
                                <label class="settings-sublabel">How do you want Live mode to be?</label>
                                <textarea class="settings-textarea" id="live-mode-prompt" placeholder="Customize how Omnix AI behaves in live conversation mode..."></textarea>
                                
                                <!-- Suggestions -->
                                <div class="prompt-suggestions">
                                    <div class="suggestion-btn" data-suggestion="personal-assistant">Personal Assistant</div>
                                    <div class="suggestion-btn" data-suggestion="emotional-partner">Emotional Partner</div>
                                    <div class="suggestion-btn" data-suggestion="mindfulness">Mindfulness</div>
                                    <div class="suggestion-btn" data-suggestion="creative-companion">Creative Companion</div>
                                    <div class="suggestion-btn" data-suggestion="study-buddy">Study Buddy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Placeholder sections for other nav items -->
                    <div class="settings-section" id="connectors-section">
                        <h3>Connectors</h3>
                        <p>Connector settings will be available soon.</p>
                    </div>
                    
                    <div class="settings-section" id="browser-agent-section">
                        <h3>Browser Agent</h3>
                        <p>Browser agent settings will be available soon.</p>
                    </div>
                    
                    <div class="settings-section" id="privacy-section">
                        <h3>Privacy</h3>
                        <p>Privacy settings will be available soon.</p>
                    </div>
                    
                    <div class="settings-section" id="about-section">
                        <h3>About us</h3>
                        <p>Information about Omnix AI will be available soon.</p>
                    </div>
                    
                    <div class="settings-section" id="help-section">
                        <h3>Help</h3>
                        <p>Help documentation will be available soon.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Conversation Overlay - Perplexity Style -->
    <div class="live-conversation-overlay" id="live-conversation-overlay">
        <div class="live-conversation-container">
            <!-- Close button -->
            <button class="live-close-btn" id="live-close-btn" title="Close live conversation">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Header with Sources -->
            <div class="perplexity-header">
                <button class="sources-btn" id="sources-btn">
                    <i class="fas fa-external-link-alt"></i> Sources
                </button>
            </div>
            
            <!-- Voice Sphere -->
            <div class="voice-sphere-container">
                <div class="voice-sphere" id="voice-sphere">
                    <div class="shifting-dots" id="shifting-dots"></div>
                </div>
                
                <!-- Live Transcription -->
                <div class="live-transcription" id="live-transcription">
                    <div class="transcription-text" id="transcription-text">🎤 Click microphone to record (Manual Mode + ElevenLabs STT)</div>
                </div>
                
                <!-- Live Controls - Mic Only -->
                <div class="live-controls">
                    <button class="live-mic-btn" id="live-mic-btn" title="Push to Talk">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                <!-- Text Input (hidden by default) -->
                <div class="live-text-input-container" id="live-text-input-container" style="display: none;">
                    <input type="text" id="live-text-input" placeholder="Type your message..." />
                    <button id="live-send-text-confirm"><i class="fas fa-paper-plane"></i></button>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentMode = 'chat';
        let isProcessing = false;
        let currentChatId = null;
        let chatHistory = [];
        let uploadedFiles = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioStream = null;
        let recognition = null;
        let sliderSettings = {
            mode: 'chat',
            style: 'auto',
            tools: {
                webSearch: true,
                researcher: false,
                extendedReasoning: true,
                sequentialThinking: true,
                codeExecutor: false
            }
        };

        // Live conversation state
        let isLiveConversationActive = false;
        let isLiveRecording = false;
        let isListeningForSilence = false;
        let silenceTimer = null;
        let audioProcessor = null;
        let liveAudioContext = null;
        let liveAnalyser = null;
        let liveMediaStream = null;
        let audioBuffer = [];
        let particleSystem = null;

        // DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatInterface = document.getElementById('chat-interface');
        const welcomeInput = document.getElementById('welcome-input');
        const welcomeSendButton = document.getElementById('welcome-send-button');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const loadingMessage = document.getElementById('loading-message');
        
        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarMini = document.getElementById('sidebar-mini');
        const sidebarClose = document.getElementById('sidebar-close');
        const newChatBtn = document.getElementById('new-chat-btn');
        const miniNewChat = document.getElementById('mini-new-chat');
        const miniExpand = document.getElementById('mini-expand');
        const miniSettings = document.getElementById('mini-settings');
        const miniProfile = document.getElementById('mini-profile');
        const chatHistoryList = document.getElementById('chat-history-list');
        const mainContent = document.getElementById('main-content');
        
        // New input elements
        const plusBtn = document.getElementById('plus-btn');
        const plusMenu = document.getElementById('plus-menu');
        const micBtn = document.getElementById('mic-btn');
        const fileInput = document.getElementById('file-input');
        const uploadFilesBtn = document.getElementById('upload-files');
        const uploadVideoBtn = document.getElementById('upload-video');
        const uploadCodebaseBtn = document.getElementById('upload-codebase');
        const takeCameraBtn = document.getElementById('take-camera');
        const addMcpBtn = document.getElementById('add-mcp');
        const uploadedFilesDiv = document.getElementById('uploaded-files');
        const recordingPanel = document.getElementById('recording-panel');
        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const recordingStatus = document.getElementById('recording-status');
        const audioVisualizer = document.getElementById('audio-visualizer');
        
        // Slider elements
        const sliderBtn = document.getElementById('slider-btn');
        const sliderPopup = document.getElementById('slider-popup');
        const welcomeSliderBtn = document.getElementById('welcome-slider-btn');
        const welcomeSliderPopup = document.getElementById('welcome-slider-popup');
        
        // Welcome screen input elements
        const welcomePlusBtn = document.getElementById('welcome-plus-btn');
        const welcomePlusMenu = document.getElementById('welcome-plus-menu');
        const welcomeMicBtn = document.getElementById('welcome-mic-btn');
        const welcomeFileInput = document.getElementById('welcome-file-input');
        const welcomeUploadFilesBtn = document.getElementById('welcome-upload-files');
        const welcomeUploadVideoBtn = document.getElementById('welcome-upload-video');
        const welcomeUploadCodebaseBtn = document.getElementById('welcome-upload-codebase');
        const welcomeTakeCameraBtn = document.getElementById('welcome-take-camera');
        const welcomeAddMcpBtn = document.getElementById('welcome-add-mcp');
        const welcomeUploadedFilesDiv = document.getElementById('welcome-uploaded-files');
        
        // MCP Dialog elements
        const mcpDialog = document.getElementById('mcp-dialog');
        const mcpDialogClose = document.getElementById('mcp-dialog-close');
        const mcpTypeUrl = document.getElementById('mcp-type-url');
        const mcpTypeJson = document.getElementById('mcp-type-json');
        const mcpUrlForm = document.getElementById('mcp-url-form');
        const mcpJsonForm = document.getElementById('mcp-json-form');
        const mcpUrlInput = document.getElementById('mcp-url-input');
        const mcpNameInput = document.getElementById('mcp-name-input');
        const mcpJsonInput = document.getElementById('mcp-json-input');
        const mcpCancelBtn = document.getElementById('mcp-cancel-btn');
        const mcpConnectBtn = document.getElementById('mcp-connect-btn');

        // Live conversation elements
        const liveConversationOverlay = document.getElementById('live-conversation-overlay');
        const liveCloseBtn = document.getElementById('live-close-btn');
        const liveMicBtn = document.getElementById('live-mic-btn');
        const liveTextInputContainer = document.getElementById('live-text-input-container');
        const liveTextInput = document.getElementById('live-text-input');
        const liveSendTextConfirm = document.getElementById('live-send-text-confirm');
        const particleCanvas = document.getElementById('particle-canvas');
        const conversationStatus = document.getElementById('conversation-status');
        
        // Live conversation state
        let liveSessionId = null;
        let isLiveSessionActive = false;
        let isAudioMuted = false;
        let sessionStartTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            console.log('Elements found:', {
                plusBtn: !!plusBtn,
                micBtn: !!micBtn, 
                sliderBtn: !!sliderBtn,
                welcomePlusBtn: !!welcomePlusBtn,
                welcomeMicBtn: !!welcomeMicBtn,
                welcomeSliderBtn: !!welcomeSliderBtn
            });
            
            // Welcome screen events
            if (welcomeSendButton) {
                welcomeSendButton.addEventListener('click', handleWelcomeMessage);
            }


            if (welcomeInput) {
                welcomeInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleWelcomeMessage();
                    }
                });
            }

            // Auto-resize welcome textarea
            welcomeInput.addEventListener('input', () => {
                welcomeInput.style.height = 'auto';
                welcomeInput.style.height = Math.min(welcomeInput.scrollHeight, 120) + 'px';
            });

            // Mode button events
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    selectMode(mode);
                });
            });

            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleChatMessage();
                    }
                });
            }

            // Chat interface events
            if (chatSendButton) {
                chatSendButton.addEventListener('click', handleChatMessage);
            }


            // Auto-resize chat textarea
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
            });

            // Sidebar events
            miniExpand.addEventListener('click', openSidebar);
            sidebarClose.addEventListener('click', closeSidebar);
            newChatBtn.addEventListener('click', startNewChat);
            miniNewChat.addEventListener('click', startNewChat);
            
            // Also make the entire mini sidebar clickable to expand
            sidebarMini.addEventListener('click', (e) => {
                // Only open sidebar if clicking the container directly or the expand button
                if (e.target === sidebarMini || e.target === miniExpand || e.target.closest('#mini-expand')) {
                    openSidebar();
                }
            });
            
            // Placeholder event listeners for settings and profile (no functionality yet)
            miniSettings.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent sidebar from opening
                showSettingsModal();
            });
            miniProfile.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent sidebar from opening
                console.log('Profile clicked - functionality not implemented yet');
            });
            miniNewChat.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent sidebar from opening
                startNewChat();
            });

            // Input controls events
            if (plusBtn) {
                console.log('Adding event listener to plusBtn');
                plusBtn.addEventListener('click', togglePlusMenu);
            } else {
                console.log('ERROR: plusBtn element not found!');
            }
            if (micBtn) {
                console.log('Adding event listener to micBtn');
                micBtn.addEventListener('click', startVoiceInput);
            } else {
                console.log('ERROR: micBtn element not found!');
            }
            if (uploadFilesBtn) {
                uploadFilesBtn.addEventListener('click', () => {
                    fileInput.click();
                    togglePlusMenu();
                });
            }
            if (uploadVideoBtn) {
                uploadVideoBtn.addEventListener('click', () => {
                    const videoInput = document.createElement('input');
                    videoInput.type = 'file';
                    videoInput.accept = 'video/*';
                    videoInput.multiple = true;
                    videoInput.onchange = handleFileUpload;
                    videoInput.click();
                    togglePlusMenu();
                });
            }
            if (uploadCodebaseBtn) {
                uploadCodebaseBtn.addEventListener('click', () => {
                    showFakeCodebaseInput();
                    togglePlusMenu();
                });
            }
            if (takeCameraBtn) {
                takeCameraBtn.addEventListener('click', () => {
                    // Camera functionality - placeholder for now
                    alert('Camera functionality coming soon!');
                    togglePlusMenu();
                });
            }
            if (addMcpBtn) {
                addMcpBtn.addEventListener('click', () => {
                    showMcpDialog();
                    togglePlusMenu();
                });
            }
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
            }

            // Recording events
            if (recordBtn) {
                recordBtn.addEventListener('click', startRecording);
            }
            if (stopRecordBtn) {
                stopRecordBtn.addEventListener('click', stopRecording);
            }

            // Close plus menu when clicking outside
            document.addEventListener('click', (e) => {
                if (plusBtn && plusMenu && !plusBtn.contains(e.target) && !plusMenu.contains(e.target)) {
                    plusMenu.classList.remove('show');
                }
            });

            // Initialize audio visualizer
            initializeAudioVisualizer();
            
            // Initialize speech recognition
            initializeSpeechRecognition();

            // Welcome screen events
            if (welcomePlusBtn) {
                welcomePlusBtn.addEventListener('click', toggleWelcomePlusMenu);
            }
            if (welcomeMicBtn) {
                welcomeMicBtn.addEventListener('click', startWelcomeVoiceInput);
            }
            if (welcomeUploadFilesBtn) {
                welcomeUploadFilesBtn.addEventListener('click', () => {
                // Redirect to chat area when upload button is pressed from welcome screen
                if (!chatInterface.classList.contains('active')) {
                    // Generate new chat ID if none exists
                    if (!currentChatId) {
                        currentChatId = generateChatId();
                    }
                    
                    // Switch to chat interface
                    currentMode = 'chat';
                    showChatInterface();
                    
                    // Show plus menu in chat area and trigger file upload
                    setTimeout(() => {
                        plusMenu.classList.add('show');
                        fileInput.click();
                    }, 100);
                } else {
                    welcomeFileInput.click();
                }
                toggleWelcomePlusMenu();
                });
            }
            if (welcomeUploadVideoBtn) {
                welcomeUploadVideoBtn.addEventListener('click', () => {
                if (!chatInterface.classList.contains('active')) {
                    if (!currentChatId) {
                        currentChatId = generateChatId();
                    }
                    currentMode = 'chat';
                    showChatInterface();
                    setTimeout(() => {
                        const videoInput = document.createElement('input');
                        videoInput.type = 'file';
                        videoInput.accept = 'video/*';
                        videoInput.multiple = true;
                        videoInput.onchange = handleFileUpload;
                        videoInput.click();
                    }, 100);
                } else {
                    const videoInput = document.createElement('input');
                    videoInput.type = 'file';
                    videoInput.accept = 'video/*';
                    videoInput.multiple = true;
                    videoInput.onchange = handleWelcomeFileUpload;
                    videoInput.click();
                }
                toggleWelcomePlusMenu();
                });
            }
            if (welcomeUploadCodebaseBtn) {
                welcomeUploadCodebaseBtn.addEventListener('click', () => {
                if (!chatInterface.classList.contains('active')) {
                    if (!currentChatId) {
                        currentChatId = generateChatId();
                    }
                    currentMode = 'chat';
                    showChatInterface();
                    setTimeout(() => {
                        showFakeCodebaseInput();
                    }, 100);
                } else {
                    showFakeCodebaseInput();
                }
                toggleWelcomePlusMenu();
                });
            }
            if (welcomeTakeCameraBtn) {
                welcomeTakeCameraBtn.addEventListener('click', () => {
                alert('Camera functionality coming soon!');
                toggleWelcomePlusMenu();
                });
            }
            if (welcomeAddMcpBtn) {
                welcomeAddMcpBtn.addEventListener('click', () => {
                showMcpDialog();
                toggleWelcomePlusMenu();
                });
            }
            if (welcomeFileInput) {
                welcomeFileInput.addEventListener('change', handleWelcomeFileUpload);
            }

            // Slider popup events
            if (sliderBtn) {
                console.log('Adding event listener to sliderBtn');
                sliderBtn.addEventListener('click', toggleSliderPopup);
            } else {
                console.log('ERROR: sliderBtn element not found!');
            }
            if (welcomeSliderBtn) {
                console.log('Adding event listener to welcomeSliderBtn');
                welcomeSliderBtn.addEventListener('click', toggleWelcomeSliderPopup);
            } else {
                console.log('ERROR: welcomeSliderBtn element not found!');
            }

            // MCP Dialog events
            mcpDialogClose.addEventListener('click', closeMcpDialog);
            mcpCancelBtn.addEventListener('click', closeMcpDialog);
            mcpConnectBtn.addEventListener('click', handleMcpConnect);
            mcpTypeUrl.addEventListener('click', () => switchMcpType('url'));
            mcpTypeJson.addEventListener('click', () => switchMcpType('json'));
            
            // Close menus when clicking outside
            document.addEventListener('click', (e) => {
                if (welcomePlusBtn && welcomePlusMenu && !welcomePlusBtn.contains(e.target) && !welcomePlusMenu.contains(e.target)) {
                    welcomePlusMenu.classList.remove('show');
                }
                if (plusBtn && plusMenu && !plusBtn.contains(e.target) && !plusMenu.contains(e.target)) {
                    plusMenu.classList.remove('show');
                }
                if (sliderBtn && sliderPopup && !sliderBtn.contains(e.target) && !sliderPopup.contains(e.target)) {
                    sliderPopup.classList.remove('show');
                }
                if (welcomeSliderBtn && welcomeSliderPopup && !welcomeSliderBtn.contains(e.target) && !welcomeSliderPopup.contains(e.target)) {
                    welcomeSliderPopup.classList.remove('show');
                }
            });

            // Load chat history
            loadChatHistory();
        }

        function toggleSliderPopup() {
            console.log('toggleSliderPopup called');
            if (sliderPopup) {
                sliderPopup.classList.toggle('show');
                console.log('Slider popup toggled. Visible:', sliderPopup.classList.contains('show'));
            } else {
                console.log('ERROR: sliderPopup element not found!');
            }
        }

        function toggleWelcomeSliderPopup() {
            console.log('toggleWelcomeSliderPopup called');
            if (welcomeSliderPopup) {
                welcomeSliderPopup.classList.toggle('show');
                console.log('Welcome slider popup toggled. Visible:', welcomeSliderPopup.classList.contains('show'));
            } else {
                console.log('ERROR: welcomeSliderPopup element not found!');
            }
        }

        function showMcpDialog() {
            mcpDialog.classList.add('show');
            if (sliderPopup) sliderPopup.classList.remove('show');
            if (welcomeSliderPopup) welcomeSliderPopup.classList.remove('show');
        }

        function showConnectorDialog() {
            console.log('Connector dialog - coming soon');
            alert('Connector management feature coming soon!');
        }

        function showAvailableMcpTools() {
            console.log('Available MCP tools - coming soon');
            alert('MCP tools management feature coming soon!');
        }

        function showAvailableConnectors() {
            console.log('Available connectors - coming soon');
            alert('Connectors management feature coming soon!');
        }

        function toggleExtendedReasoning() {
            sliderSettings.tools.extendedReasoning = !sliderSettings.tools.extendedReasoning;
            console.log('Extended Reasoning:', sliderSettings.tools.extendedReasoning);
        }

        function toggleSequentialThinking() {
            sliderSettings.tools.sequentialThinking = !sliderSettings.tools.sequentialThinking;
            console.log('Sequential Thinking:', sliderSettings.tools.sequentialThinking);
        }

        function toggleCodeExecutor() {
            sliderSettings.tools.codeExecutor = !sliderSettings.tools.codeExecutor;
            console.log('Code Executor:', sliderSettings.tools.codeExecutor);
        }

        function selectMode(mode) {
            // Handle browser mode differently - redirect to interactive page
            if (mode === 'browser') {
                window.location.href = '/interactive';
                return;
            }
            
            // Handle live conversation mode
            if (mode === 'live') {
                startLiveConversation();
                return;
            }
            
            // Generate new chat ID if none exists
            if (!currentChatId) {
                currentChatId = generateChatId();
            }
            
            currentMode = mode;
            showChatInterface();
            
            // Show/hide Omnix Maxima indicator for complex mode
            const omnixIndicator = document.getElementById('omnix-maxima-indicator');
            if (omnixIndicator) {
                if (mode === 'complex') {
                    omnixIndicator.classList.add('active');
                } else {
                    omnixIndicator.classList.remove('active');
                }
            }
            
            const modeNames = {
                'chat': 'Chat',
                'research': 'Research',
                'complex': 'Complex Tasks'
            };
            
            // Update dropdown to match selected mode
            const modeSelect = document.getElementById('mode-select');
            const welcomeModeSelect = document.getElementById('welcome-mode-select');
            if (modeSelect) modeSelect.value = mode;
            if (welcomeModeSelect) welcomeModeSelect.value = mode;
            
            const placeholders = {
                'chat': 'How can I help you?',
                'research': 'What would you like me to research?',
                'complex': 'Describe your complex task or problem...'
            };
            
            chatInput.placeholder = placeholders[mode];
            
            // Add welcome message
            addMessage('ai', `${modeNames[mode]} mode activated. ${placeholders[mode]}`);
        }

        async function handleWelcomeMessage() {
            if (!welcomeInput) return;
            const message = welcomeInput.value.trim();
            if (!message || isProcessing) return;

            // Clear the input
            welcomeInput.value = '';
            welcomeInput.style.height = 'auto';

            // Generate new chat ID if none exists
            if (!currentChatId) {
                currentChatId = generateChatId();
            }

            // Set mode based on the selected model
            if (currentModel === 'maxima') {
                currentMode = 'complex';
            } else {
                currentMode = 'chat';
            }
            showChatInterface();
            
            // Process the message
            await processMessage(message);
        }

        async function handleChatMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing) return;
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            await processMessage(message);
        }

        async function processMessage(message) {
            if (isProcessing) return;
            
            isProcessing = true;
            
            // Add user message
            addMessage('user', message);
            
            // Analyze prompt complexity for Omnix Maxima mode
            if (currentMode === 'complex') {
                const complexity = analyzePromptComplexity(message);
                
                if (complexity === 'simple') {
                    // Handle simple prompts with live response
                    await handleSimpleResponse(message);
                    isProcessing = false;
                    return;
                }
                
                // For complex prompts, use enhanced processing
                await handleComplexResponse(message);
                isProcessing = false;
                return;
            }
            
            // Show loading for non-complex modes
            showLoading();
            
            try {
                let endpoint = '/chat';
                let body = { message: message };
                
                if (currentMode === 'research') {
                    endpoint = '/research';
                    body = { query: message };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                hideLoading();
                
                if (currentMode === 'research' && data.sources) {
                    // Enhanced research response with additional data
                    addEnhancedResearchMessage(
                        data.summary, 
                        data.sources, 
                        data.insights, 
                        data.confidence, 
                        data.source_count
                    );
                } else if (data.response) {
                    addMessage('ai', data.response);
                } else {
                    addMessage('ai', 'Sorry, I encountered an error processing your request.');
                }
                
            } catch (error) {
                hideLoading();
                addMessage('ai', `Connection error: ${error.message}`);
                console.error('Error:', error);
            }
            
            isProcessing = false;
        }

        async function handleSimpleResponse(message) {
            // Create live response element
            const responseElement = createLiveResponse();
            
            try {
                // Make API call for simple response
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        mode: 'simple',
                        context: 'omnix_maxima'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Type the actual response from backend
                const responseText = Array.isArray(data.response) ? data.response.join('\n') : (data.response || 'I understand. How can I help you?');
                await typeResponse(responseElement, responseText);
                
                // Add sources if available
                if (data.sources && data.sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'sources-section';
                    sourcesDiv.style.cssText = `
                        margin-top: 15px;
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #007bff;
                    `;
                    
                    const sourcesTitle = document.createElement('h4');
                    sourcesTitle.textContent = '🔍 Sources';
                    sourcesTitle.style.cssText = `
                        margin: 0 0 10px 0;
                        color: #007bff;
                        font-size: 14px;
                        font-weight: 600;
                    `;
                    sourcesDiv.appendChild(sourcesTitle);
                    
                    data.sources.forEach((source, index) => {
                        const sourceLink = document.createElement('a');
                        sourceLink.href = source.url;
                        sourceLink.target = '_blank';
                        sourceLink.rel = 'noopener noreferrer';
                        sourceLink.textContent = `${index + 1}. ${source.title}`;
                        sourceLink.style.cssText = `
                            display: block;
                            color: #0066cc;
                            text-decoration: none;
                            margin-bottom: 5px;
                            font-size: 13px;
                            word-break: break-word;
                        `;
                        sourceLink.onmouseover = () => sourceLink.style.textDecoration = 'underline';
                        sourceLink.onmouseout = () => sourceLink.style.textDecoration = 'none';
                        sourcesDiv.appendChild(sourceLink);
                    });
                    
                    responseElement.parentElement.appendChild(sourcesDiv);
                }
                
            } catch (error) {
                // Fallback to basic response if API fails
                console.error('Simple response error:', error);
                await typeResponse(responseElement, `I'm here to help! What would you like to work on?`);
            }
        }

        async function handleComplexResponse(message) {
            // Create message with thinking canvas
            const messageId = Date.now().toString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar ai-avatar';
            avatar.textContent = 'AI';
            
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role';
            roleSpan.textContent = 'Omnix AI';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.appendChild(avatar);
            header.appendChild(roleSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Add thinking canvas
            const thinkingCanvas = createThinkingCanvas(messageId);
            contentDiv.appendChild(thinkingCanvas);
            
            // Add live response area
            const responseArea = document.createElement('div');
            responseArea.className = 'live-response';
            contentDiv.appendChild(responseArea);
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            // Prepare for live response streaming
            let liveResponseText = '';
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            responseArea.appendChild(cursor);
            
            // Make streaming API call for complex response with real backend logs
            try {
                const data = await makeStreamingRequest(
                    '/complex_task',
                    { 
                        prompt: message,
                        mode: 'complex',
                        options: {
                            enable_web_search: sliderSettings.tools.webSearch,
                            enable_extended_reasoning: sliderSettings.tools.extendedReasoning,
                            enable_sequential_thinking: sliderSettings.tools.sequentialThinking
                        },
                        thinking_steps: true,
                        live_stream: true,
                        include_logs: true
                    },
                    // Handle thinking steps from backend (if any)
                    (step) => {
                        addThinkingStep(messageId, step.title, step.content);
                    },
                    // Handle response chunks for live typing
                    (chunk) => {
                        liveResponseText += chunk;
                        responseArea.insertBefore(document.createTextNode(chunk), cursor);
                        scrollToBottom();
                    },
                    // Handle real backend logs from enhanced_complex_mode.py
                    (logData) => {
                        addLiveBackendLog(messageId, logData);
                    }
                );
                
                // Remove cursor when done
                cursor.remove();

                let finalResponseText = "Sorry, I couldn't process that. Please try again.";
                let finalCodeBlocks = [];

                // Check for the final result from the streaming response
                if (data && data.final_result) {
                    const finalResult = data.final_result;

                    // Check for backend error first
                    if (finalResult.status === 'failed' && finalResult.error) {
                        finalResponseText = `An error occurred on the backend: ${finalResult.error}`;
                    }
                    // Check for the expected successful result
                    else if (finalResult.results && finalResult.results.final_synthesis && finalResult.results.final_synthesis.synthesis_content) {
                        finalResponseText = finalResult.results.final_synthesis.synthesis_content;
                        // Also extract code blocks and render detailed thinking
                        if (finalResult.results && finalResult.results.code_blocks) {
                            finalCodeBlocks = finalResult.results.code_blocks;
                        }
                        renderDetailedThinkingProcess(messageId, finalResult.results);
                    }
                    // Add a fallback if the structure is not as expected
                    else {
                        finalResponseText = "Received a response, but it was not in the expected format.";
                        console.error("Unexpected final_result structure:", finalResult);
                    }
                } else if (data && data.error) {
                    finalResponseText = `An error occurred during streaming: ${data.error}`;
                } else if (data && data.response) {
                    // Fallback for a non-streaming JSON response
                    finalResponseText = data.response;
                    finalCodeBlocks = data.code_blocks || [];
                }

                // Render the final response, parsing Markdown
                if (!liveResponseText) {
                    // Ensure finalResponseText is a string
                    const responseString = Array.isArray(finalResponseText) ? finalResponseText.join('\n') : String(finalResponseText);
                    responseArea.innerHTML = marked.parse(responseString);
                } else {
                    // Ensure liveResponseText is a string
                    const liveString = Array.isArray(liveResponseText) ? liveResponseText.join('\n') : String(liveResponseText);
                    responseArea.innerHTML = marked.parse(liveString);
                }

                // Add code blocks if provided
                if (finalCodeBlocks.length > 0) {
                    finalCodeBlocks.forEach((codeBlock, index) => {
                        const codeContainer = document.createElement('div');
                        codeContainer.className = 'code-execution-container';
                        
                        const escapedCode = codeBlock.code.replace(/`/g, '\\`').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                        codeContainer.innerHTML = `
                            <div class="code-execution-header">
                                <span><i class="fas fa-code"></i> ${codeBlock.language || 'Code'}</span>
                                <button class="run-code-btn" onclick="executeCode('${codeBlock.language}', '${escapedCode}', 'complex-${messageId}-${index}')">
                                    <i class="fas fa-play"></i> Run
                                </button>
                            </div>
                            <div class="code-execution-content">
                                <pre><code>${codeBlock.code}</code></pre>
                                <div class="code-execution-output" id="code-output-complex-${messageId}-${index}" style="display: none;"></div>
                            </div>
                        `;
                        
                        contentDiv.appendChild(codeContainer);
                    });
                }
                
            } catch (error) {
                console.error('Complex response error:', error);
                cursor.remove();
                await typeResponse(responseArea, `I encountered an error while processing your request. Let me try a different approach: ${error.message}`);
            }
        }

        // Backend log processing functions replaced generateThinkingSteps
        // All thinking steps now come from real enhanced_complex_mode.py logs

        function showChatInterface() {
            welcomeScreen.classList.add('hidden');
            chatInterface.classList.add('active');
            chatInput.focus();
        }

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'message user-message' : 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${role}-avatar`;
            avatar.textContent = role === 'user' ? 'U' : 'AI';
            
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role';
            roleSpan.textContent = role === 'user' ? 'You' : 'Omnix AI';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.appendChild(avatar);
            header.appendChild(roleSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Ensure content is a string before passing to marked.parse
            let contentString = content;
            if (Array.isArray(content)) {
                contentString = content.join('\n');
            } else if (typeof content !== 'string') {
                contentString = String(content);
            }
            
            contentDiv.innerHTML = marked.parse(contentString);
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);

            // Convert code blocks to interactive code canvases
            convertCodeBlocksToCanvases(contentDiv, role === 'ai');

            scrollToBottom();
        }

        // Code Canvas Functions - Updated to use Monaco Editor
        function convertCodeBlocksToCanvases(contentDiv, isAiMessage = false) {
            const codeBlocks = contentDiv.querySelectorAll('pre > code');
            codeBlocks.forEach((codeBlock, index) => {
                const preElement = codeBlock.parentElement;
                const languageClass = codeBlock.className;
                const languageMatch = languageClass.match(/language-(\w+)/);
                const language = languageMatch ? languageMatch[1] : 'text';
                
                // Only add canvas triggers for supported languages when it's an AI message
                const supportedLanguages = ['javascript', 'js', 'python', 'py', 'html', 'css', 'json'];
                const isExecutable = supportedLanguages.includes(language.toLowerCase());
                
                if (isAiMessage && isExecutable) {
                    // Instead of replacing, add a "Open in Canvas" button
                    const openCanvasBtn = document.createElement('button');
                    openCanvasBtn.className = 'code-canvas-trigger';
                    openCanvasBtn.innerHTML = '<i class="fas fa-code"></i> Open in Canvas';
                    openCanvasBtn.style.position = 'absolute';
                    openCanvasBtn.style.top = '8px';
                    openCanvasBtn.style.right = '8px';
                    openCanvasBtn.style.display = 'flex';
                    
                    openCanvasBtn.onclick = (e) => {
                        e.stopPropagation();
                        const code = codeBlock.textContent;
                        const mappedLanguage = language === 'js' ? 'javascript' : 
                                             language === 'py' ? 'python' : language;
                        window.codeCanvas.open(code, mappedLanguage, `${mappedLanguage.toUpperCase()} - AI Generated`);
                    };
                    
                    // Make pre element relative so button can be positioned
                    preElement.style.position = 'relative';
                    preElement.appendChild(openCanvasBtn);
                    
                    // Also add hover effect
                    preElement.addEventListener('mouseenter', () => {
                        openCanvasBtn.style.display = 'flex';
                    });
                    preElement.addEventListener('mouseleave', () => {
                        openCanvasBtn.style.display = 'none';
                    });
                }
            });
        }

        // Legacy functions removed - now using Monaco-based Code Canvas

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function copyCodeToClipboard(canvasId) {
            const canvas = document.getElementById(canvasId);
            const editor = canvas.querySelector('.code-editor');
            
            navigator.clipboard.writeText(editor.value).then(() => {
                // Show success feedback
                const copyBtn = canvas.querySelector('.code-action-btn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code to clipboard');
            });
        }

        function executeCanvasCode(canvasId, language) {
            const canvas = document.getElementById(canvasId);
            const editor = canvas.querySelector('.code-editor');
            const output = canvas.querySelector('.code-output');
            const runBtn = canvas.querySelector('.run-btn');
            
            const code = editor.value.trim();
            if (!code) {
                showCodeOutput(output, 'No code to execute', 'error');
                return;
            }
            
            // Show loading state
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            runBtn.disabled = true;
            output.style.display = 'block';
            showCodeOutput(output, 'Executing code...', '');
            
            // Execute based on language
            setTimeout(() => {
                try {
                    let result;
                    const lowerLang = language.toLowerCase();
                    
                    if (lowerLang === 'javascript' || lowerLang === 'js') {
                        result = executeJavaScript(code);
                    } else if (lowerLang === 'python' || lowerLang === 'py') {
                        result = executePythonDemo(code);
                    } else {
                        result = 'Code execution not supported for this language yet.';
                    }
                    
                    showCodeOutput(output, result, 'success');
                } catch (error) {
                    showCodeOutput(output, `Error: ${error.message}`, 'error');
                } finally {
                    // Reset button
                    runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
                    runBtn.disabled = false;
                }
            }, 1000);
        }

        function showCodeOutput(outputDiv, message, type) {
            outputDiv.className = `code-output ${type}`;
            outputDiv.textContent = message;
            outputDiv.style.display = 'block';
        }

        function executeJavaScript(code) {
            // Create a safe execution environment
            const originalConsoleLog = console.log;
            const outputs = [];
            
            // Override console.log to capture output
            console.log = function(...args) {
                outputs.push(args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' '));
            };
            
            try {
                // Execute the code in a limited scope
                const result = new Function(`
                    "use strict";
                    ${code}
                `)();
                
                // Restore console.log
                console.log = originalConsoleLog;
                
                let output = outputs.length > 0 ? outputs.join('\n') : '';
                if (result !== undefined) {
                    if (output) output += '\n';
                    output += `Return value: ${typeof result === 'object' ? JSON.stringify(result, null, 2) : result}`;
                }
                
                return output || 'Code executed successfully (no output)';
            } catch (error) {
                console.log = originalConsoleLog;
                throw error;
            }
        }

        function executePythonDemo(code) {
            // Simple Python simulation for demo purposes
            // In a real implementation, this would call a backend Python executor
            
            const lines = code.split('\n');
            const outputs = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('print(') && trimmed.endsWith(')')) {
                    // Extract and simulate print statements
                    const content = trimmed.slice(6, -1);
                    try {
                        // Simple evaluation for strings and numbers
                        const evaluated = content.startsWith('"') || content.startsWith("'") 
                            ? content.slice(1, -1) 
                            : content;
                        outputs.push(evaluated);
                    } catch (e) {
                        outputs.push(content);
                    }
                }
            }
            
            if (outputs.length > 0) {
                return outputs.join('\n');
            } else {
                return 'Python demo: Code would execute on server\n(This is a frontend simulation)';
            }
        }

        function addResearchMessage(summary, sources) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar ai-avatar';
            avatar.textContent = 'AI';
            
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role';
            roleSpan.textContent = 'Omnix AI';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.appendChild(avatar);
            header.appendChild(roleSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Add summary
            const summaryP = document.createElement('p');
            const summaryString = Array.isArray(summary) ? summary.join('\n') : String(summary);
            summaryP.innerHTML = marked.parse(summaryString);
            contentDiv.appendChild(summaryP);
            
            // Add sources
            if (sources && sources.length > 0) {
                const sourcesTitle = document.createElement('p');
                sourcesTitle.innerHTML = '<strong>Sources:</strong>';
                sourcesTitle.style.marginTop = '1rem';
                contentDiv.appendChild(sourcesTitle);
                
                sources.forEach(source => {
                    const sourceLink = document.createElement('a');
                    sourceLink.href = source.url;
                    sourceLink.target = '_blank';
                    sourceLink.textContent = source.title;
                    sourceLink.style.display = 'block';
                    sourceLink.style.color = '#c17b47';
                    sourceLink.style.textDecoration = 'underline';
                    sourceLink.style.marginBottom = '0.25rem';
                    contentDiv.appendChild(sourceLink);
                });
            }
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addEnhancedResearchMessage(summary, sources, insights, confidence, sourceCount) {
            // Use enhanced display for research results if additional data available
            if (insights || confidence || sourceCount > 5) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Add research metadata header
                if (sourceCount || confidence) {
                    const metadataDiv = document.createElement('div');
                    metadataDiv.style.cssText = `
                        background: rgba(193, 123, 71, 0.1);
                        padding: 0.75rem 1rem;
                        border-radius: 8px;
                        margin-bottom: 1.5rem;
                        border-left: 3px solid #c17b47;
                        font-size: 0.9rem;
                        color: #666;
                    `;
                    
                    const metadataContent = [];
                    if (sourceCount) metadataContent.push(`📚 ${sourceCount} sources analyzed`);
                    if (confidence) metadataContent.push(`🎯 ${Math.round(confidence * 100)}% confidence`);
                    metadataContent.push(`🧠 Sequential thinking applied`);
                    
                    metadataDiv.innerHTML = `<strong>🔍 Comprehensive Research:</strong> ${metadataContent.join(' • ')}`;
                    contentDiv.appendChild(metadataDiv);
                }
                
                // Add main summary
                const summaryDiv = document.createElement('div');
                const summaryString = Array.isArray(summary) ? summary.join('\n') : String(summary);
                summaryDiv.innerHTML = marked.parse(summaryString);
                contentDiv.appendChild(summaryDiv);
                
                // Add key insights if available
                if (insights && insights.length > 0) {
                    const insightsDiv = document.createElement('div');
                    insightsDiv.style.cssText = `
                        margin: 1.5rem 0;
                        padding: 1rem;
                        background: rgba(255, 255, 255, 0.5);
                        border-radius: 8px;
                        border: 1px solid rgba(193, 123, 71, 0.2);
                    `;
                    
                    const insightsTitle = document.createElement('h4');
                    insightsTitle.textContent = '💡 Key Insights';
                    insightsTitle.style.cssText = 'margin: 0 0 0.75rem 0; color: #c17b47; font-size: 1.1rem;';
                    insightsDiv.appendChild(insightsTitle);
                    
                    const insightsList = document.createElement('ul');
                    insightsList.style.cssText = 'margin: 0; padding-left: 1.25rem;';
                    
                    insights.slice(0, 5).forEach(insight => {
                        const li = document.createElement('li');
                        li.textContent = insight;
                        li.style.cssText = 'margin-bottom: 0.5rem; line-height: 1.4;';
                        insightsList.appendChild(li);
                    });
                    
                    insightsDiv.appendChild(insightsList);
                    contentDiv.appendChild(insightsDiv);
                }
                
                messageDiv.appendChild(contentDiv);
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
                
            } else {
                // Fall back to basic research message
                addResearchMessage(summary, sources);
            }
        }

        function addComplexMessage(response, thinking = null, codeBlocks = null, thinkingSteps = null) {
            const messageId = Date.now().toString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar ai-avatar';
            avatar.textContent = 'AI';
            
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role';
            roleSpan.textContent = 'Omnix AI';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.appendChild(avatar);
            header.appendChild(roleSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Add thinking canvas if thinking steps provided
            if (thinkingSteps && thinkingSteps.length > 0) {
                const thinkingCanvas = createThinkingCanvas(messageId);
                contentDiv.appendChild(thinkingCanvas);
                
                // Add thinking steps
                setTimeout(() => {
                    thinkingSteps.forEach(step => {
                        addThinkingStep(messageId, step.title, step.content);
                    });
                }, 100);
            }
            
            // Add main response
            const responseP = document.createElement('p');
            responseP.innerHTML = response.replace(/\n/g, '<br>');
            contentDiv.appendChild(responseP);
            
            // Add code blocks if provided
            if (codeBlocks && codeBlocks.length > 0) {
                codeBlocks.forEach((codeBlock, index) => {
                    const codeContainer = document.createElement('div');
                    codeContainer.className = 'code-execution-container';
                    
                    const codeHeader = document.createElement('div');
                    codeHeader.className = 'code-execution-header';
                    const escapedCode2 = codeBlock.code.replace(/`/g, '\\`').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                    codeHeader.innerHTML = `
                        <span><i class="fas fa-code"></i> ${codeBlock.language || 'Code'}</span>
                        <button class="run-code-btn" onclick="executeCode('${codeBlock.language}', '${escapedCode2}', 'msg-${messageId}-${index}')">
                            <i class="fas fa-play"></i> Run
                        </button>
                    `;
                    
                    const codeContent = document.createElement('div');
                    codeContent.className = 'code-execution-content';
                    
                    const codeBlock_pre = document.createElement('pre');
                    const codeElement = document.createElement('code');
                    codeElement.textContent = codeBlock.code;
                    codeBlock_pre.appendChild(codeElement);
                    codeContent.appendChild(codeBlock_pre);
                    
                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'code-execution-output';
                    outputDiv.id = `code-output-msg-${messageId}-${index}`;
                    outputDiv.style.display = 'none';
                    codeContent.appendChild(outputDiv);
                    
                    codeContainer.appendChild(codeHeader);
                    codeContainer.appendChild(codeContent);
                    contentDiv.appendChild(codeContainer);
                });
            }
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function executeCode(language, code, outputId) {
            const outputDiv = document.getElementById(`code-output-${outputId}`);
            outputDiv.style.display = 'block';
            outputDiv.textContent = 'Executing...';
            
            try {
                if (language === 'javascript' || language === 'js') {
                    // Create a safer sandbox for JavaScript execution using Function constructor
                    try {
                        const func = new Function(code);
                        const result = func();
                        outputDiv.textContent = result !== undefined ? String(result) : 'Code executed successfully';
                    } catch (err) {
                        outputDiv.textContent = `Error: ${err.message}`;
                        outputDiv.style.color = '#ff6b6b';
                    }
                } else if (language === 'html') {
                    // For HTML, create an iframe to render it
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '300px';
                    iframe.style.border = '1px solid #ddd';
                    iframe.style.borderRadius = '4px';
                    iframe.style.marginTop = '1rem';
                    
                    outputDiv.innerHTML = '';
                    outputDiv.appendChild(iframe);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(code);
                    iframeDoc.close();
                } else if (language === 'css') {
                    // For CSS, create a demo with the styles applied
                    const demoDiv = document.createElement('div');
                    demoDiv.innerHTML = `
                        <style>${code}</style>
                        <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 1rem;">
                            <p>CSS Demo</p>
                            <div class="demo-content">
                                <h3>Sample Content</h3>
                                <p>This demonstrates your CSS styles.</p>
                                <button>Sample Button</button>
                            </div>
                        </div>
                    `;
                    outputDiv.innerHTML = '';
                    outputDiv.appendChild(demoDiv);
                } else {
                    outputDiv.textContent = `Code execution for ${language} is not supported in the browser. This would typically run on the server.`;
                }
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
                outputDiv.style.color = '#dc3545';
            }
        }

        // Prompt Complexity Analysis System
        function analyzePromptComplexity(prompt) {
            const lowerPrompt = prompt.toLowerCase().trim();
            
            // Simple greetings and basic responses
            const simplePatterns = [
                /^(hi|hello|hey|hola|good morning|good afternoon|good evening)$/,
                /^(thanks?|thank you|ty)$/,
                /^(bye|goodbye|see you|cya)$/,
                /^(yes|no|ok|okay|sure)$/,
                /^(how are you|what's up|sup)$/,
                /^(what time is it|what day is it)$/
            ];

            // Complex task indicators
            const complexPatterns = [
                /build|create|develop|make|design|implement/,
                /write.*code|program|script/,
                /analyze|research|find|search/,
                /explain.*how|tutorial|guide|steps/,
                /help.*with|solve|fix|debug/,
                /plan|strategy|approach/,
                /compare|difference|versus/
            ];

            // Check for simple patterns
            for (const pattern of simplePatterns) {
                if (pattern.test(lowerPrompt)) {
                    return 'simple';
                }
            }

            // Check for complex patterns
            for (const pattern of complexPatterns) {
                if (pattern.test(lowerPrompt)) {
                    return 'complex';
                }
            }

            // Length-based complexity
            if (prompt.length < 20) {
                return 'simple';
            } else if (prompt.length > 100) {
                return 'complex';
            }

            return 'medium';
        }

        // Thinking Canvas Management
        function createThinkingCanvas(messageId) {
            const canvas = document.createElement('div');
            canvas.className = 'thinking-canvas';
            canvas.id = `thinking-canvas-${messageId}`;
            
            canvas.innerHTML = `
                <div class="thinking-canvas-header" onclick="toggleThinkingCanvas('${messageId}')">
                    <div class="thinking-canvas-title">
                        <i class="fas fa-brain"></i>
                        <span>thinking... processes</span>
                    </div>
                    <span class="thinking-canvas-toggle">▼</span>
                </div>
                <div class="thinking-canvas-content" id="thinking-content-${messageId}">
                    <div class="thinking-canvas-inner" id="thinking-inner-${messageId}">
                        <div class="thinking-step backend-log log-process">
                            <div class="thinking-step-header">
                                <span class="log-icon">⏳</span>
                                <span class="log-message">Connecting...</span>
                                <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="thinking-step-content log-details">
                                Waiting for backend processing logs...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add placeholder for detailed thinking process, initially hidden
            const detailedContainer = document.createElement('div');
            detailedContainer.className = 'detailed-thinking-container';
            detailedContainer.id = `detailed-thinking-container-${messageId}`;
            detailedContainer.style.display = 'none'; // Hide until final results are in
            
            detailedContainer.innerHTML = `
                <div class="detailed-thinking-header" onclick="toggleDetailedThinking('${messageId}')">
                    <span>See thinking process in detail</span>
                    <span class="detailed-thinking-toggle" id="detailed-thinking-toggle-${messageId}">▼</span>
                </div>
                <div class="detailed-thinking-content" id="detailed-thinking-content-${messageId}">
                    <!-- Detailed results will be rendered here -->
                </div>
            `;
            
            const thinkingInner = canvas.querySelector(`#thinking-inner-${messageId}`);
            thinkingInner.appendChild(detailedContainer);

            return canvas;
        }

        function toggleThinkingCanvas(messageId) {
            const content = document.getElementById(`thinking-content-${messageId}`);
            const toggle = document.querySelector(`#thinking-canvas-${messageId} .thinking-canvas-toggle`);
            
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        function addThinkingStep(messageId, title, content) {
            const thinkingInner = document.getElementById(`thinking-inner-${messageId}`);
            if (!thinkingInner) return;
            
            const step = document.createElement('div');
            step.className = 'thinking-step';
            step.innerHTML = `
                <div class="thinking-step-header">${title}</div>
                <div class="thinking-step-content">${content}</div>
            `;
            
            thinkingInner.appendChild(step);
        }

        // Live Response Streaming
        function createLiveResponse(role = 'ai') {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'message user-message' : 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${role}-avatar`;
            avatar.textContent = role === 'user' ? 'U' : 'AI';
            
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role';
            roleSpan.textContent = role === 'user' ? 'You' : 'Omnix AI';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.appendChild(avatar);
            header.appendChild(roleSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content live-response';
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            return contentDiv;
        }

        function typeResponse(element, text, speed = 30) {
            return new Promise((resolve) => {
                let i = 0;
                element.innerHTML = '';
                
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                element.appendChild(cursor);
                
                const timer = setInterval(() => {
                    if (i < text.length) {
                        element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
                        i++;
                        scrollToBottom();
                    } else {
                        cursor.remove();
                        clearInterval(timer);
                        resolve();
                    }
                }, speed);
            });
        }

        // Enhanced API integration with streaming support
        async function makeStreamingRequest(endpoint, body, onThinkingStep = null, onResponseChunk = null, onBackendLog = null) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        ...body,
                        stream: true,
                        include_thinking: true,
                        include_logs: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Check if streaming is supported
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    return await handleStreamingResponse(response, onThinkingStep, onResponseChunk, onBackendLog);
                } else {
                    // Fallback to regular JSON response
                    return await response.json();
                }
            } catch (error) {
                console.error('Streaming request error:', error);
                throw error;
            }
        }

        async function handleStreamingResponse(response, onThinkingStep, onResponseChunk, onBackendLog) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let result = { response: '', thinking_steps: [], code_blocks: [], final_result: null, error: null };
            let buffer = '';

            const processLine = (line) => {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.type === 'thinking_step' && onThinkingStep) {
                            onThinkingStep(data.step);
                        } else if (data.type === 'response_chunk' && onResponseChunk) {
                            onResponseChunk(data.chunk);
                            result.response += data.chunk;
                        } else if (data.type === 'backend_log' && onBackendLog) {
                            onBackendLog(data.log);
                        } else if (data.type === 'log_message' && onBackendLog) {
                            onBackendLog(data);
                        } else if (data.type === 'code_block') {
                            result.code_blocks.push(data.code);
                        } else if (data.type === 'complete') {
                            if (data.result) {
                                result.final_result = data.result;
                            }
                            return 'done';
                        } else if (data.type === 'error') {
                            result.error = data.error;
                            console.error('Backend streaming error:', data.error);
                            return 'done';
                        }
                    } catch (e) {
                        console.error("Failed to parse stream data:", line, e);
                    }
                }
                return null;
            };

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        // Process any remaining data in the buffer
                        if (buffer) {
                            processLine(buffer);
                        }
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    let boundary;
                    while ((boundary = buffer.indexOf('\n')) !== -1) {
                        const line = buffer.substring(0, boundary).trim();
                        buffer = buffer.substring(boundary + 1);
                        if (line) {
                            const status = processLine(line);
                            if (status === 'done') {
                                return result;
                            }
                        }
                    }
                }
            } finally {
                reader.releaseLock();
            }

            return result;
        }

        // Parse backend log messages from enhanced_complex_mode.py
        function parseBackendLog(logMessage) {
            // Handle both raw log strings and structured log objects
            let logText = typeof logMessage === 'string' ? logMessage : logMessage.message || '';
            
            // Extract timestamp
            const timestampMatch = logText.match(/\[(\d{2}:\d{2}:\d{2})\]/);
            const timestamp = timestampMatch ? timestampMatch[1] : new Date().toLocaleTimeString();
            
            // Extract log level
            const levelMatch = logText.match(/\b(INFO|DEBUG|WARNING|ERROR)\b/);
            const level = levelMatch ? levelMatch[1] : 'INFO';
            
            // Extract the main message (remove timestamp, file info, and level)
            let message = logText
                .replace(/\[\d{2}:\d{2}:\d{2}\]/, '') // Remove timestamp
                .replace(/enhanced_complex_mode\.py:\d+/, '') // Remove file info
                .replace(/\b(INFO|DEBUG|WARNING|ERROR)\b/, '') // Remove log level
                .trim();
            
            // Detect log type based on content
            let logType = 'process';
            let icon = '⚙️';
            
            if (message.includes('🧠') || message.includes('Deep Think')) {
                logType = 'thinking';
                icon = '🧠';
            } else if (message.includes('✅') || message.includes('completed')) {
                logType = 'success';
                icon = '✅';
            } else if (message.includes('Planning notebook') || message.includes('notebook')) {
                logType = 'planning';
                icon = '📝';
            } else if (message.includes('reasoning') || message.includes('chains')) {
                logType = 'reasoning';
                icon = '🔗';
            } else if (message.includes('error') || level === 'ERROR') {
                logType = 'error';
                icon = '❌';
            } else if (message.includes('warning') || level === 'WARNING') {
                logType = 'warning';
                icon = '⚠️';
            }
            
            return {
                timestamp,
                level,
                message: message || logText,
                type: logType,
                icon,
                raw: logText
            };
        }

        // Add live backend log to thinking canvas
        function addLiveBackendLog(messageId, logData) {
            const parsedLog = parseBackendLog(logData);
            const thinkingInner = document.getElementById(`thinking-inner-${messageId}`);
            if (!thinkingInner) return;
            
            const logStep = document.createElement('div');
            logStep.className = `thinking-step backend-log log-${parsedLog.type}`;
            
            logStep.innerHTML = `
                <div class="thinking-step-header">
                    <span class="log-icon">${parsedLog.icon}</span>
                    <span class="log-message">${parsedLog.message}</span>
                    <span class="log-timestamp">${parsedLog.timestamp}</span>
                </div>
                <div class="thinking-step-content log-details">
                    Level: ${parsedLog.level} | Type: ${parsedLog.type}
                </div>
            `;
            
            thinkingInner.appendChild(logStep);
            
            // Auto-scroll to show new logs
            scrollToBottom();
            
            // Expand thinking canvas if it's collapsed
            const thinkingContent = document.getElementById(`thinking-content-${messageId}`);
            if (thinkingContent && !thinkingContent.classList.contains('expanded')) {
                toggleThinkingCanvas(messageId);
            }
        }

        function showLoading() {
            loadingMessage.style.display = 'block';
            
            // Enhanced loading message for research mode
            if (currentMode === 'research') {
                const loadingText = loadingMessage.querySelector('.loading-text');
                if (loadingText) {
                    loadingText.innerHTML = `
                        🔍 Conducting comprehensive research...<br>
                        <span style="font-size: 0.8rem; color: #888; margin-top: 0.5rem; display: block;">
                            • Searching 25-100+ sources • Applying sequential thinking • Analyzing credibility
                        </span>
                    `;
                }
            }
            
            scrollToBottom();
        }

        function hideLoading() {
            loadingMessage.style.display = 'none';
            
            // Reset loading message to default
            const loadingText = loadingMessage.querySelector('.loading-text');
            if (loadingText) {
                loadingText.innerHTML = 'Omnix AI is thinking...';
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleDetailedThinking(messageId) {
            const content = document.getElementById(`detailed-thinking-content-${messageId}`);
            const toggle = document.getElementById(`detailed-thinking-toggle-${messageId}`);
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        function renderDetailedThinkingProcess(messageId, results) {
            const container = document.getElementById(`detailed-thinking-container-${messageId}`);
            const contentDiv = document.getElementById(`detailed-thinking-content-${messageId}`);
            if (!container || !contentDiv) return;

            // Make the container visible
            container.style.display = 'block';
            
            let html = '';

            // 1. Multi-Stage Reasoning
            if (results.multi_stage_reasoning) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">🧠 Multi-Stage Reasoning</div>
                        <div class="detail-section-content">
                            <strong>Analysis:</strong>
                            <p>${results.multi_stage_reasoning.analysis}</p>
                            <strong>Architecture:</strong>
                            <p>${results.multi_stage_reasoning.architecture}</p>
                            <strong>Implementation:</strong>
                            <p>${results.multi_stage_reasoning.implementation}</p>
                        </div>
                    </div>
                `;
            }

            // 2. Multi-Perspective Analysis
            if (results.multi_perspective_analysis) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">👁️ Multi-Perspective Analysis</div>
                        <div class="detail-section-content">${results.multi_perspective_analysis}</div>
                    </div>
                `;
            }

            // 3. Enhanced Sequential Thinking
            if (results.enhanced_sequential_thinking) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">🔗 Enhanced Sequential Thinking</div>
                        <div class="detail-section-content">${results.enhanced_sequential_thinking.thinking_process}</div>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
        }

        // Duplicate functions removed - keeping only the first declarations

        // Sidebar functionality
        function openSidebar() {
            sidebar.classList.add('open');
            mainContent.classList.add('sidebar-open');
            sidebarMini.classList.add('sidebar-open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            mainContent.classList.remove('sidebar-open');
            sidebarMini.classList.remove('sidebar-open');
        }

        function startNewChat() {
            // Save current chat if exists
            if (currentChatId && chatMessages.children.length > 0) {
                saveChatToHistory();
            }

            // Reset interface
            currentChatId = generateChatId();
            currentMode = 'chat';
            chatMessages.innerHTML = '';
            
            // Show welcome screen
            chatInterface.classList.remove('active');
            welcomeScreen.classList.remove('hidden');
            
            welcomeInput.value = '';
            welcomeInput.focus();
            
            closeSidebar();
        }

        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveChatToHistory() {
            if (!currentChatId || chatMessages.children.length === 0) return;

            const firstMessage = chatMessages.querySelector('.message .message-content');
            const title = firstMessage ? 
                firstMessage.textContent.substring(0, 50) + (firstMessage.textContent.length > 50 ? '...' : '') :
                'New Chat';

            const chatData = {
                id: currentChatId,
                title: title,
                mode: currentMode,
                timestamp: new Date().toISOString(),
                messages: Array.from(chatMessages.children).map(msg => ({
                    role: msg.querySelector('.message-role')?.textContent || 'Unknown',
                    content: msg.querySelector('.message-content')?.textContent || ''
                }))
            };

            // Update existing chat or add new one
            const existingIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
            if (existingIndex >= 0) {
                chatHistory[existingIndex] = chatData;
            } else {
                chatHistory.unshift(chatData);
            }

            // Keep only last 50 chats
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(0, 50);
            }

            localStorage.setItem('omnix_chat_history', JSON.stringify(chatHistory));
            renderChatHistory();
        }

        function loadChatHistory() {
            try {
                const saved = localStorage.getItem('omnix_chat_history');
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    renderChatHistory();
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
                chatHistory = [];
            }
        }

        function renderChatHistory() {
            chatHistoryList.innerHTML = '';

            if (chatHistory.length === 0) {
                chatHistoryList.innerHTML = '<div style="padding: 1rem 0.5rem; color: #666; font-size: 0.8rem; text-align: center;">No recent chats</div>';
                return;
            }

            chatHistory.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                if (chat.id === currentChatId) {
                    chatItem.classList.add('active');
                }

                const timeStr = new Date(chat.timestamp).toLocaleDateString();
                
                chatItem.innerHTML = `
                    <div class="chat-item-title">${chat.title}</div>
                    <div class="chat-item-time">${timeStr} • ${chat.mode}</div>
                `;

                chatItem.addEventListener('click', () => loadChat(chat));
                chatHistoryList.appendChild(chatItem);
            });
        }

        function loadChat(chat) {
            // Save current chat first
            if (currentChatId && currentChatId !== chat.id && chatMessages.children.length > 0) {
                saveChatToHistory();
            }

            currentChatId = chat.id;
            currentMode = chat.mode;
            
            // Clear and restore messages
            chatMessages.innerHTML = '';
            chat.messages.forEach(msg => {
                const role = msg.role.toLowerCase().includes('you') ? 'user' : 'ai';
                addMessage(role, msg.content);
            });

            // Show chat interface
            showChatInterface();
            
            closeSidebar();
            renderChatHistory(); // Update active state
        }

        // Plus Menu Functionality
        function togglePlusMenu() {
            console.log('togglePlusMenu called');
            if (plusMenu) {
                plusMenu.classList.toggle('show');
                console.log('Plus menu toggled. Visible:', plusMenu.classList.contains('show'));
            } else {
                console.log('ERROR: plusMenu element not found!');
            }
        }

        // File Upload Functionality
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                });
            });
            renderUploadedFiles();
            event.target.value = ''; // Clear the input
        }

        function renderUploadedFiles() {
            uploadedFilesDiv.innerHTML = '';
            uploadedFiles.forEach((fileData, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'uploaded-file';
                
                const icon = getFileIcon(fileData.type);
                fileDiv.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${fileData.name}</span>
                    <span class="remove-file" onclick="removeFile(${index})">×</span>
                `;
                
                uploadedFilesDiv.appendChild(fileDiv);
            });
        }

        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'fas fa-image';
            if (fileType.startsWith('video/')) return 'fas fa-video';
            if (fileType.startsWith('audio/')) return 'fas fa-music';
            if (fileType.includes('pdf')) return 'fas fa-file-pdf';
            if (fileType.includes('text') || fileType.includes('json') || fileType.includes('javascript') || fileType.includes('python')) return 'fas fa-file-code';
            if (fileType.includes('zip') || fileType.includes('tar')) return 'fas fa-file-archive';
            return 'fas fa-file';
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderUploadedFiles();
        }

        // Welcome Screen Functionality
        function toggleWelcomePlusMenu() {
            console.log('toggleWelcomePlusMenu called');
            if (welcomePlusMenu) {
                welcomePlusMenu.classList.toggle('show');
                console.log('Welcome plus menu toggled. Visible:', welcomePlusMenu.classList.contains('show'));
            } else {
                console.log('ERROR: welcomePlusMenu element not found!');
            }
        }

        function handleWelcomeFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                });
            });
            renderWelcomeUploadedFiles();
            event.target.value = ''; // Clear the input
        }

        function renderWelcomeUploadedFiles() {
            welcomeUploadedFilesDiv.innerHTML = '';
            uploadedFiles.forEach((fileData, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'uploaded-file';
                
                const icon = getFileIcon(fileData.type);
                fileDiv.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${fileData.name}</span>
                    <span class="remove-file" onclick="removeWelcomeFile(${index})">×</span>
                `;
                
                welcomeUploadedFilesDiv.appendChild(fileDiv);
            });
        }

        function removeWelcomeFile(index) {
            uploadedFiles.splice(index, 1);
            renderWelcomeUploadedFiles();
        }

        function startWelcomeVoiceInput() {
            // Redirect to chat area when mic button is pressed from welcome screen
            if (!chatInterface.classList.contains('active')) {
                // Generate new chat ID if none exists
                if (!currentChatId) {
                    currentChatId = generateChatId();
                }
                
                // Switch to chat interface
                currentMode = 'chat';
                showChatInterface();
            }
            
            // Start voice recording in chat area
            if (!isRecording) {
                recordingPanel.classList.add('show');
                startRecording();
            }
        }

        // MCP Connection Functionality
        function showMcpDialog() {
            mcpDialog.classList.add('show');
        }

        // Fake Codebase Input Functionality
        function showFakeCodebaseInput() {
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            `;

            modal.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: #333; font-size: 22px; font-weight: 600;">Add Codebase</h3>
                    <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">Choose how to add your codebase</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button id="fake-github-tab" style="flex: 1; padding: 10px; border: 2px solid #c17b47; background: #c17b47; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">GitHub Link</button>
                        <button id="fake-files-tab" style="flex: 1; padding: 10px; border: 2px solid #ddd; background: transparent; color: #666; border-radius: 8px; cursor: pointer; font-weight: 500;">Upload Files</button>
                    </div>
                    
                    <div id="fake-github-section">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">GitHub Repository URL:</label>
                        <input type="text" id="fake-github-input" placeholder="https://github.com/username/repo" 
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;">
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 13px; color: #666; line-height: 1.4;">
                                <strong>Note:</strong> This is a demo interface. The system will simulate importing your repository.
                            </div>
                        </div>
                    </div>
                    
                    <div id="fake-files-section" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Select Files or Folder:</label>
                        <div style="border: 2px dashed #c17b47; border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 15px; cursor: pointer;" id="fake-file-drop">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: #c17b47; margin-bottom: 10px;"></i>
                            <p style="margin: 0; color: #666;">Click to select files or drag & drop</p>
                            <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">Supports multiple files and folders</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 13px; color: #666; line-height: 1.4;">
                                <strong>Note:</strong> This is a demo interface. File selection will be simulated.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="fake-cancel-btn" style="padding: 10px 20px; border: 2px solid #ddd; background: transparent; color: #666; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                    <button id="fake-import-btn" style="padding: 10px 20px; border: 2px solid #c17b47; background: #c17b47; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Import Codebase</button>
                </div>
            `;

            modalOverlay.appendChild(modal);
            document.body.appendChild(modalOverlay);

            // Tab functionality
            const githubTab = modal.querySelector('#fake-github-tab');
            const filesTab = modal.querySelector('#fake-files-tab');
            const githubSection = modal.querySelector('#fake-github-section');
            const filesSection = modal.querySelector('#fake-files-section');

            githubTab.addEventListener('click', () => {
                githubTab.style.background = '#c17b47';
                githubTab.style.color = 'white';
                githubTab.style.borderColor = '#c17b47';
                filesTab.style.background = 'transparent';
                filesTab.style.color = '#666';
                filesTab.style.borderColor = '#ddd';
                githubSection.style.display = 'block';
                filesSection.style.display = 'none';
            });

            filesTab.addEventListener('click', () => {
                filesTab.style.background = '#c17b47';
                filesTab.style.color = 'white';
                filesTab.style.borderColor = '#c17b47';
                githubTab.style.background = 'transparent';
                githubTab.style.color = '#666';
                githubTab.style.borderColor = '#ddd';
                githubSection.style.display = 'none';
                filesSection.style.display = 'block';
            });

            // File drop simulation
            const fileDropArea = modal.querySelector('#fake-file-drop');
            fileDropArea.addEventListener('click', () => {
                simulateFileSelection(fileDropArea);
            });

            // Import button functionality
            modal.querySelector('#fake-import-btn').addEventListener('click', () => {
                const activeTab = githubSection.style.display !== 'none' ? 'github' : 'files';
                if (activeTab === 'github') {
                    const githubUrl = modal.querySelector('#fake-github-input').value.trim();
                    if (githubUrl) {
                        simulateGithubImport(githubUrl);
                    } else {
                        alert('Please enter a GitHub URL');
                        return;
                    }
                } else {
                    simulateFileImport();
                }
                document.body.removeChild(modalOverlay);
            });

            // Cancel button functionality
            modal.querySelector('#fake-cancel-btn').addEventListener('click', () => {
                document.body.removeChild(modalOverlay);
            });

            // Close on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    document.body.removeChild(modalOverlay);
                }
            });

            // Focus the GitHub input
            setTimeout(() => {
                modal.querySelector('#fake-github-input').focus();
            }, 100);
        }

        function simulateFileSelection(dropArea) {
            dropArea.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #c17b47; margin-bottom: 10px;"></i>
                <p style="margin: 0; color: #c17b47; font-weight: 500;">Selecting files...</p>
            `;
            
            setTimeout(() => {
                dropArea.innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 24px; color: #28a745; margin-bottom: 10px;"></i>
                    <p style="margin: 0; color: #28a745; font-weight: 500;">5 files selected</p>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">main.py, utils.py, config.json, README.md, requirements.txt</p>
                `;
            }, 1500);
        }

        function simulateGithubImport(url) {
            // Show loading message in chat
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Importing codebase from ${url}...</span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                setTimeout(() => {
                    loadingDiv.innerHTML = `
                        <div class="message-content">
                            <p>✅ <strong>Codebase Import Simulation Complete</strong></p>
                            <p>Successfully simulated importing from: <code>${url}</code></p>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin: 10px 0; border-left: 4px solid #c17b47;">
                                <strong>Simulated Repository Analysis:</strong><br>
                                📁 Found 23 files<br>
                                🐍 Python project detected<br>
                                📝 README.md available<br>
                                🔧 requirements.txt found<br>
                                💾 Ready for code assistance
                            </div>
                            <p>You can now ask questions about your codebase or request modifications!</p>
                        </div>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 2000);
            }
        }

        function simulateFileImport() {
            // Show loading message in chat
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Processing uploaded files...</span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                setTimeout(() => {
                    loadingDiv.innerHTML = `
                        <div class="message-content">
                            <p>✅ <strong>File Import Simulation Complete</strong></p>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin: 10px 0; border-left: 4px solid #c17b47;">
                                <strong>Simulated Files Processed:</strong><br>
                                📄 main.py - 150 lines<br>
                                📄 utils.py - 89 lines<br>
                                📄 config.json - Configuration file<br>
                                📄 README.md - Documentation<br>
                                📄 requirements.txt - Dependencies
                            </div>
                            <p>Files are now available for code analysis and assistance!</p>
                        </div>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 2000);
            }
        }

        function closeMcpDialog() {
            mcpDialog.classList.remove('show');
            // Reset form
            mcpUrlInput.value = '';
            mcpNameInput.value = '';
            mcpJsonInput.value = '';
            switchMcpType('url');
        }

        function switchMcpType(type) {
            if (type === 'url') {
                mcpTypeUrl.classList.add('active');
                mcpTypeJson.classList.remove('active');
                mcpUrlForm.style.display = 'block';
                mcpJsonForm.style.display = 'none';
            } else {
                mcpTypeJson.classList.add('active');
                mcpTypeUrl.classList.remove('active');
                mcpUrlForm.style.display = 'none';
                mcpJsonForm.style.display = 'block';
            }
        }

        function handleMcpConnect() {
            const isUrlMode = mcpTypeUrl.classList.contains('active');
            let connectionData;

            if (isUrlMode) {
                const url = mcpUrlInput.value.trim();
                const name = mcpNameInput.value.trim() || 'MCP Server';
                
                if (!url) {
                    alert('Please enter a server URL');
                    return;
                }

                connectionData = { url, name, type: 'url' };
            } else {
                const jsonConfig = mcpJsonInput.value.trim();
                
                if (!jsonConfig) {
                    alert('Please enter JSON configuration');
                    return;
                }

                try {
                    connectionData = JSON.parse(jsonConfig);
                    connectionData.type = 'json';
                } catch (error) {
                    alert('Invalid JSON configuration: ' + error.message);
                    return;
                }
            }

            console.log('MCP connection requested:', connectionData);
            addMessage('system', `Attempting to connect to MCP server: ${connectionData.name || connectionData.url}`);
            
            // TODO: Implement actual MCP connection
            closeMcpDialog();
        }

        // Voice Input and Recording Functionality
        function startVoiceInput() {
            console.log('startVoiceInput called');
            if (!isRecording) {
                recordingPanel.classList.add('show');
                startRecording();
            } else {
                console.log('Already recording');
            }
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    recordingStatus.textContent = 'Listening...';
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    // Default to chat input, will be overridden by welcome voice input if needed
                    if (chatInterface.classList.contains('active')) {
                        chatInput.value = transcript;
                    } else {
                        welcomeInput.value = transcript;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    recordingStatus.textContent = `Error: ${event.error}`;
                };

                recognition.onend = () => {
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                    recordBtn.style.display = 'block';
                    stopRecordBtn.style.display = 'none';
                    recordingStatus.textContent = 'Ready to record';
                    recordingPanel.classList.remove('show');
                };
            } else {
                console.warn('Speech recognition not supported in this browser');
            }
        }

        async function startRecording() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                if (recognition) {
                    recognition.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    recordBtn.style.display = 'none';
                    stopRecordBtn.style.display = 'block';
                    recordingStatus.textContent = 'Recording... Speak now';
                    
                    // Start audio visualization
                    startAudioVisualization(audioStream);
                }
            } catch (error) {
                console.error('Error starting recording:', error);
                recordingStatus.textContent = 'Microphone access denied';
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            stopAudioVisualization();
        }

        // Audio Visualization
        function initializeAudioVisualizer() {
            // Create audio bars
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '4px';
                audioVisualizer.appendChild(bar);
            }
        }

        function startAudioVisualization(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            microphone.connect(analyser);
            analyser.fftSize = 256;

            const bars = audioVisualizer.querySelectorAll('.audio-bar');

            function animate() {
                if (!isRecording) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                for (let i = 0; i < bars.length; i++) {
                    const value = dataArray[i * 4] || 0;
                    const height = Math.max(4, (value / 255) * 30);
                    bars[i].style.height = height + 'px';
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        function stopAudioVisualization() {
            const bars = audioVisualizer.querySelectorAll('.audio-bar');
            bars.forEach(bar => {
                bar.style.height = '4px';
            });
        }

        // Auto-save chat periodically
        setInterval(() => {
            if (currentChatId && chatMessages.children.length > 0) {
                saveChatToHistory();
            }
        }, 30000); // Save every 30 seconds

        // New Enhanced Slider Functions
        
        // Dropdown toggle functions for chat interface
        function toggleStylesDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('styles-dropdown');
            const arrow = document.getElementById('styles-arrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('open');
        }

        function toggleToolsDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('tools-dropdown');
            const arrow = document.getElementById('tools-arrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('open');
        }

        function selectStyle(style) {
            console.log('Style selected:', style);
            sliderSettings.style = style;
            // Close dropdown
            document.getElementById('styles-dropdown').classList.remove('show');
            document.getElementById('styles-arrow').classList.remove('open');
        }

        // Dropdown toggle functions for welcome interface
        function toggleWelcomeStylesDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('welcome-styles-dropdown');
            const arrow = document.getElementById('welcome-styles-arrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('open');
        }

        function toggleWelcomeToolsDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('welcome-tools-dropdown');
            const arrow = document.getElementById('welcome-tools-arrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('open');
        }

        function selectWelcomeStyle(style) {
            console.log('Welcome style selected:', style);
            sliderSettings.style = style;
            // Close dropdown
            document.getElementById('welcome-styles-dropdown').classList.remove('show');
            document.getElementById('welcome-styles-arrow').classList.remove('open');
        }

        // Updated connector and MCP functions
        function showConnectorDialog() {
            alert('Connector management feature coming soon!');
            // Close dropdowns
            const toolsDropdown = document.getElementById('tools-dropdown');
            const welcomeToolsDropdown = document.getElementById('welcome-tools-dropdown');
            if (toolsDropdown) {
                toolsDropdown.classList.remove('show');
                document.getElementById('tools-arrow').classList.remove('open');
            }
            if (welcomeToolsDropdown) {
                welcomeToolsDropdown.classList.remove('show');
                document.getElementById('welcome-tools-arrow').classList.remove('open');
            }
        }

        function showAvailableConnectors() {
            alert('Available connectors feature coming soon!');
            // Close dropdowns
            const toolsDropdown = document.getElementById('tools-dropdown');
            const welcomeToolsDropdown = document.getElementById('welcome-tools-dropdown');
            if (toolsDropdown) {
                toolsDropdown.classList.remove('show');
                document.getElementById('tools-arrow').classList.remove('open');
            }
            if (welcomeToolsDropdown) {
                welcomeToolsDropdown.classList.remove('show');
                document.getElementById('welcome-tools-arrow').classList.remove('open');
            }
        }

        // Updated MCP functions to work with new design
        function showAvailableMcpTools() {
            console.log('Available MCP tools - coming soon');
            alert('MCP tools management feature coming soon!');
            // Close dropdowns
            const toolsDropdown = document.getElementById('tools-dropdown');
            const welcomeToolsDropdown = document.getElementById('welcome-tools-dropdown');
            if (toolsDropdown) {
                toolsDropdown.classList.remove('show');
                document.getElementById('tools-arrow').classList.remove('open');
            }
            if (welcomeToolsDropdown) {
                welcomeToolsDropdown.classList.remove('show');
                document.getElementById('welcome-tools-arrow').classList.remove('open');
            }
        }

        // Toggle functionality for feature switches
        function setupToggleListeners() {
            // Web Search toggles
            const webSearchToggle = document.getElementById('web-search-toggle');
            const welcomeWebSearchToggle = document.getElementById('welcome-web-search-toggle');
            
            if (webSearchToggle) {
                webSearchToggle.addEventListener('change', function() {
                    sliderSettings.tools.webSearch = this.checked;
                    console.log('Web Search:', this.checked);
                });
            }
            
            if (welcomeWebSearchToggle) {
                welcomeWebSearchToggle.addEventListener('change', function() {
                    sliderSettings.tools.webSearch = this.checked;
                    console.log('Welcome Web Search:', this.checked);
                    // Sync with chat toggle
                    if (webSearchToggle) webSearchToggle.checked = this.checked;
                });
            }

            // Researcher toggles
            const researcherToggle = document.getElementById('researcher-toggle');
            const welcomeResearcherToggle = document.getElementById('welcome-researcher-toggle');
            
            if (researcherToggle) {
                researcherToggle.addEventListener('change', function() {
                    sliderSettings.tools.researcher = this.checked;
                    console.log('Researcher:', this.checked);
                });
            }
            
            if (welcomeResearcherToggle) {
                welcomeResearcherToggle.addEventListener('change', function() {
                    sliderSettings.tools.researcher = this.checked;
                    console.log('Welcome Researcher:', this.checked);
                    // Sync with chat toggle
                    if (researcherToggle) researcherToggle.checked = this.checked;
                });
            }

            // Extended Reasoning toggles
            const extendedReasoningToggle = document.getElementById('extended-reasoning-toggle');
            const welcomeExtendedReasoningToggle = document.getElementById('welcome-extended-reasoning-toggle');
            
            if (extendedReasoningToggle) {
                extendedReasoningToggle.addEventListener('change', function() {
                    sliderSettings.tools.extendedReasoning = this.checked;
                    console.log('Extended Reasoning:', this.checked);
                });
            }
            
            if (welcomeExtendedReasoningToggle) {
                welcomeExtendedReasoningToggle.addEventListener('change', function() {
                    sliderSettings.tools.extendedReasoning = this.checked;
                    console.log('Welcome Extended Reasoning:', this.checked);
                    // Sync with chat toggle
                    if (extendedReasoningToggle) extendedReasoningToggle.checked = this.checked;
                });
            }

            // Sequential Thinking toggles
            const sequentialThinkingToggle = document.getElementById('sequential-thinking-toggle');
            const welcomeSequentialThinkingToggle = document.getElementById('welcome-sequential-thinking-toggle');
            
            if (sequentialThinkingToggle) {
                sequentialThinkingToggle.addEventListener('change', function() {
                    sliderSettings.tools.sequentialThinking = this.checked;
                    console.log('Sequential Thinking:', this.checked);
                });
            }
            
            if (welcomeSequentialThinkingToggle) {
                welcomeSequentialThinkingToggle.addEventListener('change', function() {
                    sliderSettings.tools.sequentialThinking = this.checked;
                    console.log('Welcome Sequential Thinking:', this.checked);
                    // Sync with chat toggle
                    if (sequentialThinkingToggle) sequentialThinkingToggle.checked = this.checked;
                });
            }
        }

        // Initialize toggle listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupToggleListeners();
        });

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (welcomePlusBtn && welcomePlusMenu && !welcomePlusBtn.contains(e.target) && !welcomePlusMenu.contains(e.target)) {
                welcomePlusMenu.classList.remove('show');
            }
            if (plusBtn && plusMenu && !plusBtn.contains(e.target) && !plusMenu.contains(e.target)) {
                plusMenu.classList.remove('show');
            }
            if (sliderBtn && sliderPopup && !sliderBtn.contains(e.target) && !sliderPopup.contains(e.target)) {
                sliderPopup.classList.remove('show');
                // Also close dropdowns when slider popup closes
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-arrow').forEach(arrow => {
                    arrow.classList.remove('open');
                });
            }
            if (welcomeSliderBtn && welcomeSliderPopup && !welcomeSliderBtn.contains(e.target) && !welcomeSliderPopup.contains(e.target)) {
                welcomeSliderPopup.classList.remove('show');
                // Also close dropdowns when slider popup closes
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-arrow').forEach(arrow => {
                    arrow.classList.remove('open');
                });
            }
            
            // Close individual dropdowns when clicking outside them (but only if slider popup is still open)
            if ((sliderPopup && sliderPopup.classList.contains('show')) || 
                (welcomeSliderPopup && welcomeSliderPopup.classList.contains('show'))) {
                const dropdowns = document.querySelectorAll('.dropdown-section');
                dropdowns.forEach(section => {
                    if (!section.contains(e.target) && !e.target.closest('.dropdown-header')) {
                        const dropdown = section.querySelector('.dropdown-content');
                        const arrow = section.querySelector('.dropdown-arrow');
                        if (dropdown) dropdown.classList.remove('show');
                        if (arrow) arrow.classList.remove('open');
                    }
                });
            }
        });

        // ============ SERVER-SIDE LIVE VOICE SYSTEM ============
        // All processing happens on the server, no Socket.IO needed
        
        class LiveVoiceSystem {
            constructor() {
                this.client = null;
                this.isActive = false;
                this.isRecording = false;
                this.sessionId = null;
            }
            
            async initialize() {
                console.log('🎤 Initializing Server-Side Live Voice System...');
                
                try {
                    // Create and initialize the server-side client
                    if (window.ServerSideLiveVoiceClient) {
                        this.client = new window.ServerSideLiveVoiceClient();
                        const success = await this.client.initialize();
                        
                        if (success) {
                            this.isActive = true;
                            this.sessionId = this.client.sessionId;
                            console.log('✅ Live Voice System initialized successfully');
                            this.updateStatus('Ready', 'Click microphone to start talking');
                            return true;
                        }
                    } else {
                        throw new Error('Live Voice Client not loaded');
                    }
                } catch (error) {
                    console.error('❌ Failed to initialize Live Voice System:', error);
                    this.showError(error.message);
                    return false;
                }
            }
            
            
            startRecording() {
                if (!this.isActive || this.isRecording || !this.client) return;
                
                console.log('🔴 Starting recording...');
                const success = this.client.startRecording();
                
                if (success) {
                    this.isRecording = true;
                    this.updateStatus('Recording', 'Listening to you...');
                    
                    // Update UI
                    const micBtn = document.getElementById('live-mic-btn');
                    if (micBtn) {
                        micBtn.classList.add('recording');
                    }
                }
            }
            
            stopRecording() {
                if (!this.isRecording || !this.client) return;
                
                console.log('⏹️ Stopping recording...');
                const success = this.client.stopRecording();
                
                if (success) {
                    this.isRecording = false;
                    this.updateStatus('Processing', 'Processing your message...');
                    
                    // Update UI
                    const micBtn = document.getElementById('live-mic-btn');
                    if (micBtn) {
                        micBtn.classList.remove('recording');
                    }
                }
            }
            
            async sendTextMessage(text) {
                if (!this.isActive || !text.trim() || !this.client) return;
                
                console.log('📤 Sending text message:', text);
                this.updateTranscription('You: ' + text);
                
                // Send via client (handles server-side processing)
                await this.client.sendTextMessage(text);
                
                this.updateStatus('Waiting', 'Waiting for response...');
            }
            
            updateStatus(title, subtitle) {
                updateConversationStatus(title, subtitle);
            }
            
            updateTranscription(text) {
                const element = document.getElementById('transcription-text');
                if (element) {
                    element.textContent = text;
                }
            }
            
            showError(message) {
                this.updateStatus('Error', message);
                console.error('Live Voice Error:', message);
            }
            
            async cleanup() {
                console.log('🧹 Cleaning up Live Voice System...');
                
                // Stop recording if active
                if (this.isRecording) {
                    this.stopRecording();
                }
                
                // End client session
                if (this.client) {
                    await this.client.end();
                    this.client = null;
                }
                
                this.isActive = false;
                this.sessionId = null;
                console.log('✅ Cleanup complete');
            }
        }
        
        // Global instance
        let liveVoiceSystem = null;
        
        // Updated start function
        async function startLiveConversation() {
            console.log('Starting live conversation...');
            
            try {
                // Show overlay
                isLiveConversationActive = true;
                liveConversationOverlay.classList.add('show');
                
                // Initialize voice sphere animation
                initializeVoiceSphere();
                
                // Create and initialize live voice system
                liveVoiceSystem = new LiveVoiceSystem();
                const success = await liveVoiceSystem.initialize();
                
                if (success) {
                    setupLiveControls();
                    updateConversationStatus('Ready', 'Click microphone to start talking');
                } else {
                    throw new Error('Failed to initialize voice system');
                }
                
            } catch (error) {
                console.error('Failed to start live conversation:', error);
                updateConversationStatus('Error', error.message);
                // Close overlay on error
                setTimeout(() => closeLiveConversation(), 3000);
            }
        }

        async function closeLiveConversation() {
            console.log('Closing live conversation...');
            isLiveConversationActive = false;
            liveConversationOverlay.classList.remove('show');
            
            // Clean up live voice system
            if (liveVoiceSystem) {
                await liveVoiceSystem.cleanup();
                liveVoiceSystem = null;
            }
            
            // Clean up old audio resources (for compatibility)
            if (liveMediaStream) {
                liveMediaStream.getTracks().forEach(track => track.stop());
                liveMediaStream = null;
            }
            
            if (liveAudioContext) {
                liveAudioContext.close();
                liveAudioContext = null;
            }
            
            // Stop voice sphere animation
            if (voiceSphereSystem) {
                voiceSphereSystem.stop();
                voiceSphereSystem = null;
            }
        }

        function setupLiveControls() {
            // Close button
            const liveCloseBtn = document.getElementById('live-close-btn');
            if (liveCloseBtn) {
                liveCloseBtn.addEventListener('click', closeLiveConversation);
            }
            
            // Microphone button - click to start/stop
            if (liveMicBtn) {
                liveMicBtn.addEventListener('click', toggleLiveRecording);
            }
            
            // Hands-free toggle
            const handsFreeToggle = document.getElementById('hands-free-toggle');
            if (handsFreeToggle) {
                handsFreeToggle.addEventListener('click', toggleHandsFree);
            }
            
            // Sources button
            const sourcesBtn = document.getElementById('sources-btn');
            if (sourcesBtn) {
                sourcesBtn.addEventListener('click', showSources);
            }
        }

        function toggleLiveMute() {
            isLiveMuted = !isLiveMuted;
            
            if (liveMuteBtn) {
                if (isLiveMuted) {
                    liveMuteBtn.classList.add('muted');
                    liveMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    updateConversationStatus('Muted', 'Microphone is off');
                } else {
                    liveMuteBtn.classList.remove('muted');
                    liveMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    updateConversationStatus('Listening', 'Speak naturally and I\'ll respond');
                }
            }
            
            // Mute/unmute the audio stream
            if (liveMediaStream) {
                liveMediaStream.getAudioTracks().forEach(track => {
                    track.enabled = !isLiveMuted;
                });
            }
        }

        function updateConversationStatus(title, subtitle) {
            // Use the transcription text element to show status
            const transcriptionText = document.getElementById('transcription-text');
            if (transcriptionText) {
                if (subtitle) {
                    transcriptionText.textContent = `${title}: ${subtitle}`;
                } else {
                    transcriptionText.textContent = title;
                }
            }
            console.log(`Status: ${title}${subtitle ? ` - ${subtitle}` : ''}`);
        }

        // Legacy functions kept for compatibility - will be removed in future
        async function initializeLiveAudio() {
            // Now handled by LiveVoiceSystem class
            console.log('Legacy initializeLiveAudio called - using new system');
        }
        
        async function waitForSocketAndInitialize() {
            // Now handled by LiveVoiceSystem class
            console.log('Legacy waitForSocketAndInitialize called - using new system');
        }
        
        async function initializeElevenLabsLive() {
            // Now handled by LiveVoiceSystem class
            console.log('Legacy initializeElevenLabsLive called - using new system');
        }

        // ElevenLabs uses SocketIO connection - no need for separate token management

        // ElevenLabs connection is handled via SocketIO in the backend

        // ElevenLabs event handlers are set up through SocketIO in the main script
        // Audio responses will be handled via the live_audio_response event
        // Text responses will be handled via the live_text_response event

        // Audio Processing Setup
        function setupAudioProcessing() {
            if (!liveMediaStream) {
                console.warn('No media stream available for audio processing');
                return;
            }
            
            // Create audio processing pipeline
            const audioContext = liveAudioContext;
            const source = audioContext.createMediaStreamSource(liveMediaStream);
            
            // Create script processor for real-time audio capture
            const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
            
            // Voice Activity Detection
            let voiceActivityTimeout;
            let isUserSpeaking = false;
            let audioBuffer = [];
            let silenceCount = 0;
            
            scriptProcessor.onaudioprocess = (audioProcessingEvent) => {
                if (isLiveMuted) return;
                
                const inputBuffer = audioProcessingEvent.inputBuffer;
                const inputData = inputBuffer.getChannelData(0);
                
                // Convert to 16kHz PCM for audio processing
                const downsampledData = downsampleAudio(inputData, audioContext.sampleRate, 16000);
                
                // Voice Activity Detection
                const rms = calculateRMS(downsampledData);
                const isVoiceDetected = rms > 0.01; // Threshold for voice detection
                
                if (isVoiceDetected) {
                    if (!isUserSpeaking) {
                        isUserSpeaking = true;
                        console.log('🎤 User started speaking');
                        updateConversationStatus('Listening', 'I hear you...');
                        triggerUserSpeakingVisuals();
                    }
                    
                    // Add to buffer
                    audioBuffer.push(...downsampledData);
                    silenceCount = 0;
                    
                    // Clear any existing timeout
                    if (voiceActivityTimeout) {
                        clearTimeout(voiceActivityTimeout);
                    }
                    
                    // Manual mode - no automatic timeout processing
                    // Audio will only be processed when user manually clicks stop
                    
                } else {
                    silenceCount++;
                    
                    // If we have enough silence samples, consider speech ended
                    if (isUserSpeaking && silenceCount > 50) { // ~1.25 seconds of silence
                        if (voiceActivityTimeout) {
                            clearTimeout(voiceActivityTimeout);
                        }
                        
                        // Manual mode - no automatic processing on silence
                        // User must click stop to process audio
                    }
                }
            };
            
            // Connect the audio processing pipeline
            source.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
            
            console.log('🎵 Audio processing pipeline established');
        }

        // Send audio data for STT processing
        function sendAudioToElevenLabs(audioData) {
            if (!liveSessionId || !isLiveSessionActive) {
                console.log('⚠️ No active session for audio processing');
                return;
            }
            
            try {
                // Convert Float32Array to base64
                const audioBuffer = new ArrayBuffer(audioData.length * 4);
                const audioView = new Float32Array(audioBuffer);
                audioView.set(audioData);
                
                // Convert to base64
                const bytes = new Uint8Array(audioBuffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                const audioBase64 = btoa(binary);
                
                console.log('🎤 Sending audio for STT processing');
                
                // Send to backend for STT processing - check if socket is connected
                if (socket && socket.connected) {
                    socket.emit('live_send_audio', {
                        session_id: liveSessionId,
                        audio_data: audioBase64
                    });
                    console.log('🎵 Audio sent to server for STT processing');
                } else {
                    console.warn('⚠️ Socket not connected - cannot send audio');
                    updateTranscriptionText('⚠️ Connection lost - please refresh page');
                }
                
                updateConversationStatus('Processing...', 'Converting speech to text');
                
            } catch (error) {
                console.error('Error sending audio:', error);
                updateConversationStatus('Error', 'Failed to process audio');
            }
        }

        // Play AI response audio (legacy PCM format)
        async function playAIResponse(audioBase64) {
            try {
                // Decode base64 audio data
                const audioData = atob(audioBase64);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }
                
                // Convert PCM to playable audio
                const audioBuffer = await liveAudioContext.decodeAudioData(audioArray.buffer);
                
                // Create audio source and play
                const source = liveAudioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(liveAudioContext.destination);
                source.start();
                
                console.log('🔊 Playing AI response audio');
                
            } catch (error) {
                console.error('Error playing AI response:', error);
            }
        }

        // Play ElevenLabs audio response
        function playElevenLabsAudio(audioBase64) {
            try {
                // Don't play if audio is muted
                if (isAudioMuted) {
                    console.log('🔇 Audio muted, skipping playback');
                    return;
                }
                
                // Create an audio element for ElevenLabs MP3 audio with high quality settings
                const audio = new Audio();
                audio.src = 'data:audio/mp3;base64,' + audioBase64;
                audio.volume = 0.8;  // Slightly reduced to prevent distortion
                audio.preload = 'auto';
                audio.crossOrigin = 'anonymous';
                
                // Error handling for audio loading
                audio.onerror = (e) => {
                    console.error('Audio loading error:', e);
                    updateConversationStatus('Audio Error', 'Failed to load audio');
                };
                
                audio.oncanplaythrough = () => {
                    console.log('🎵 Audio can play through without interruption');
                    audio.play().then(() => {
                        console.log('🔊 Playing ElevenLabs audio response');
                    }).catch(error => {
                        console.error('Failed to play ElevenLabs audio:', error);
                        // Request user interaction for autoplay
                        updateConversationStatus('Audio Ready', 'Click anywhere to enable audio playback');
                        document.addEventListener('click', () => {
                            audio.play().catch(err => console.error('Manual play failed:', err));
                        }, { once: true });
                        if (voiceSphereSystem) {
                            voiceSphereSystem.setMode('idle');
                        }
                    });
                };
                
                audio.onended = () => {
                    console.log('ElevenLabs audio finished playing');
                    if (voiceSphereSystem) {
                        voiceSphereSystem.setMode('idle');
                    }
                };
                
            } catch (error) {
                console.error('Failed to process ElevenLabs audio:', error);
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('idle');
                }
            }
        }

        // Configure AI personality for mindfulness/emotional support
        async function configureAIPersonality() {
            // Additional configuration can be sent after initial setup
            const personalityConfig = {
                clientContent: {
                    turns: [{
                        role: "user",
                        parts: [{
                            text: "Please remember that you are a mindful, emotionally supportive companion. Always respond with warmth, empathy, and presence. Use natural speech patterns with appropriate pauses for reflection."
                        }]
                    }]
                }
            };
            
            if (liveWebSocket && liveWebSocket.readyState === WebSocket.OPEN) {
                liveWebSocket.send(JSON.stringify(personalityConfig));
            }
        }

        // Audio utility functions
        function downsampleAudio(inputData, inputSampleRate, outputSampleRate) {
            if (inputSampleRate === outputSampleRate) return inputData;
            
            const ratio = inputSampleRate / outputSampleRate;
            const outputLength = Math.floor(inputData.length / ratio);
            const output = new Float32Array(outputLength);
            
            for (let i = 0; i < outputLength; i++) {
                const inputIndex = Math.floor(i * ratio);
                output[i] = inputData[inputIndex];
            }
            
            return output;
        }

        function calculateRMS(audioData) {
            let sum = 0;
            for (let i = 0; i < audioData.length; i++) {
                sum += audioData[i] * audioData[i];
            }
            return Math.sqrt(sum / audioData.length);
        }

        // Visual feedback functions for particle system
        function triggerUserSpeakingVisuals() {
            if (particleSystem) {
                particleSystem.setMode('user_speaking');
            }
        }

        function triggerAIResponseVisuals() {
            if (particleSystem) {
                particleSystem.setMode('ai_responding');
            }
            updateConversationStatus('AI Speaking', 'Sharing thoughts with care...');
        }

        function triggerIdleVisuals() {
            if (particleSystem) {
                particleSystem.setMode('idle');
            }
        }

        // Enhanced error handling and reconnection logic for ElevenLabs
        function handleElevenLabsError(error) {
            console.error('ElevenLabs Live API Error:', error);
            
            const errorMessages = {
                'auth_failed': 'Authentication failed. Please refresh and try again.',
                'quota_exceeded': 'API quota exceeded. Please try again later.',
                'network_error': 'Network connection issue. Checking connection...',
                'invalid_audio': 'Audio format issue. Please check your microphone.',
                'default': 'Connection issue. Attempting to reconnect...'
            };
            
            const message = errorMessages[error.type] || errorMessages.default;
            updateConversationStatus('Error', message);
            
            // Implement exponential backoff for reconnection
            if (error.retryable && isLiveConversationActive) {
                setTimeout(() => {
                    if (isLiveConversationActive) {
                        initializeElevenLabsLive().catch(retryError => {
                            console.error('Retry failed:', retryError);
                        });
                    }
                }, Math.min(30000, 1000 * Math.pow(2, error.retryCount || 0)));
            }
        }

        // Perplexity-style Voice Sphere Functions
        let voiceSphereSystem = null;
        let isHandsFreeMode = false;
        let speechRecognition = null;

        function initializeVoiceSphere() {
            const voiceSphere = document.getElementById('voice-sphere');
            const shiftingDots = document.getElementById('shifting-dots');
            if (!voiceSphere || !shiftingDots) return;

            // Create Perplexity-style dot pattern
            const totalDots = 180; // Increased for denser pattern
            const centerX = 150;
            const centerY = 150;
            const dots = [];

            // Create dots in multiple rings + scattered pattern
            for (let i = 0; i < totalDots; i++) {
                const dot = document.createElement('div');
                dot.className = 'voice-dot';
                
                let x, y, radius, angle;
                
                // Distribution: 60% outer ring, 30% middle rings, 10% scattered
                const distribution = i / totalDots;
                
                if (distribution < 0.6) {
                    // Outer ring with slight variation
                    angle = (i / (totalDots * 0.6)) * Math.PI * 2;
                    radius = 110 + Math.random() * 10;
                } else if (distribution < 0.9) {
                    // Middle rings
                    angle = ((i - totalDots * 0.6) / (totalDots * 0.3)) * Math.PI * 2;
                    radius = 40 + Math.random() * 60;
                } else {
                    // Scattered inner dots
                    angle = Math.random() * Math.PI * 2;
                    radius = Math.random() * 40;
                }
                
                x = centerX + Math.cos(angle) * radius;
                y = centerY + Math.sin(angle) * radius;
                
                dot.style.left = x + 'px';
                dot.style.top = y + 'px';
                
                // Store dot data
                const dotData = {
                    element: dot,
                    baseX: x,
                    baseY: y,
                    currentX: x,
                    currentY: y,
                    angle: angle,
                    radius: radius,
                    speed: 0.3 + Math.random() * 0.7,
                    phaseOffset: Math.random() * Math.PI * 2,
                    floatAmplitude: 0.5 + Math.random() * 1.5,
                    responseStrength: 0.5 + Math.random() * 0.5
                };
                
                dots.push(dotData);
                shiftingDots.appendChild(dot);
            }

            // Setup mouse/touch interactions
            const setupInteractions = () => {
                let mousePosition = { x: 0, y: 0 };

                // Mouse/touch interaction for scatter effect
                voiceSphere.addEventListener('mousemove', (e) => {
                    const rect = voiceSphere.getBoundingClientRect();
                    mousePosition = {
                        x: e.clientX - rect.left - 150,
                        y: e.clientY - rect.top - 150
                    };
                    scatterNearbyDots(mousePosition);
                });

                voiceSphere.addEventListener('mouseleave', () => {
                    mousePosition = { x: 0, y: 0 };
                    resetDots();
                });

                // Touch interactions
                voiceSphere.addEventListener('touchmove', (e) => {
                    const rect = voiceSphere.getBoundingClientRect();
                    const touch = e.touches[0];
                    mousePosition = {
                        x: touch.clientX - rect.left - 150,
                        y: touch.clientY - rect.top - 150
                    };
                    scatterNearbyDots(mousePosition);
                });

                voiceSphere.addEventListener('touchend', () => {
                    mousePosition = { x: 0, y: 0 };
                    resetDots();
                });

                // Click for pulse effect and start live session
                voiceSphere.addEventListener('click', async () => {
                    createRipple();
                    
                    // If session is not active, start one
                    if (!sessionActive) {
                        try {
                            // Request microphone permission first
                            await navigator.mediaDevices.getUserMedia({ audio: true });
                            
                            // Initialize ElevenLabs Live session (wait for socket first)
                            await waitForSocketAndInitialize();
                        } catch (error) {
                            console.error('Error starting live session:', error);
                            updateConversationStatus('Permission Required', 'Please allow microphone access');
                        }
                    }
                });

                const scatterNearbyDots = (mousePos) => {
                    const scatterRadius = 50;
                    
                    dots.forEach(dot => {
                        const dx = dot.currentX - 150 - mousePos.x;
                        const dy = dot.currentY - 150 - mousePos.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < scatterRadius) {
                            const force = 1 - (distance / scatterRadius);
                            const scatterX = dx * force * 30;
                            const scatterY = dy * force * 30;
                            
                            dot.element.style.setProperty('--scatter-x', `${scatterX}px`);
                            dot.element.style.setProperty('--scatter-y', `${scatterY}px`);
                            dot.element.classList.add('scattered');
                            
                            // Update position with scatter
                            const newX = dot.baseX + scatterX * 0.3;
                            const newY = dot.baseY + scatterY * 0.3;
                            dot.element.style.transform = `translate(${newX - dot.baseX}px, ${newY - dot.baseY}px)`;
                        }
                    });
                };

                const resetDots = () => {
                    dots.forEach(dot => {
                        dot.element.classList.remove('scattered');
                        dot.element.style.transform = '';
                    });
                };

                const createRipple = () => {
                    dots.forEach((dot, index) => {
                        setTimeout(() => {
                            dot.element.style.animation = 'ripple 0.8s ease-out';
                            setTimeout(() => {
                                dot.element.style.animation = '';
                            }, 800);
                        }, index * 2);
                    });
                };
            };

            setupInteractions();

            // Enhanced animation system
            voiceSphereSystem = {
                dots: dots,
                animationId: null,
                mode: 'idle',
                time: 0,
                audioLevel: 0,
                
                start() {
                    this.animate();
                },
                
                stop() {
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    this.stopAudioAnalysis();
                    // Clear any intervals
                    if (this.scatterInterval) {
                        clearInterval(this.scatterInterval);
                        this.scatterInterval = null;
                    }
                    if (this.reactionInterval) {
                        clearInterval(this.reactionInterval);
                        this.reactionInterval = null;
                    }
                },
                
                setMode(newMode) {
                    this.mode = newMode;
                    const voiceSphere = document.getElementById('voice-sphere');
                    
                    // Remove all mode classes from dots and sphere
                    this.dots.forEach(dot => {
                        dot.element.classList.remove('active', 'ai-speaking', 'ai-thinking', 'wave-animation', 
                                                   'audio-reactive', 'high-frequency', 'mid-frequency', 'low-frequency');
                    });
                    
                    if (voiceSphere) {
                        voiceSphere.classList.remove('ai-speaking', 'user-speaking', 'ai-thinking');
                    }
                    
                    // Clear any existing intervals
                    if (this.scatterInterval) {
                        clearInterval(this.scatterInterval);
                        this.scatterInterval = null;
                    }
                    if (this.reactionInterval) {
                        clearInterval(this.reactionInterval);
                        this.reactionInterval = null;
                    }
                    
                    if (newMode === 'user_speaking') {
                        this.dots.forEach(dot => {
                            dot.element.classList.add('active');
                        });
                        if (voiceSphere) {
                            voiceSphere.classList.add('user-speaking');
                        }
                        // Start audio analysis for reactive effects
                        this.startAudioAnalysis();
                        
                    } else if (newMode === 'ai_responding' || newMode === 'ai_speaking') {
                        // Add wave animation to dots with staggered timing
                        this.dots.forEach((dot, index) => {
                            setTimeout(() => {
                                dot.element.classList.add('ai-speaking');
                                if (Math.random() > 0.6) { // 40% chance for wave effect
                                    dot.element.style.animationDelay = `${index * 0.03}s`;
                                    dot.element.classList.add('wave-animation');
                                }
                            }, index * 8); // Faster stagger
                        });
                        
                        if (voiceSphere) {
                            voiceSphere.classList.add('ai-speaking');
                        }
                        
                        // Enhanced AI speaking effects
                        this.scatterInterval = setInterval(() => {
                            if (this.mode === 'ai_responding' || this.mode === 'ai_speaking') {
                                this.triggerEnhancedScatter();
                            }
                        }, 1500);
                        
                        // Add frequency-based reactions
                        this.reactionInterval = setInterval(() => {
                            if (this.mode === 'ai_responding' || this.mode === 'ai_speaking') {
                                this.triggerFrequencyReaction();
                            }
                        }, 800);
                        
                    } else if (newMode === 'ai_thinking') {
                        // Thinking mode - slower, more contemplative
                        this.dots.forEach((dot, index) => {
                            setTimeout(() => {
                                dot.element.classList.add('ai-thinking');
                            }, index * 15);
                        });
                        
                        if (voiceSphere) {
                            voiceSphere.classList.add('ai-thinking');
                        }
                        
                        // Subtle thinking effects
                        this.scatterInterval = setInterval(() => {
                            if (this.mode === 'ai_thinking') {
                                this.triggerThinkingEffect();
                            }
                        }, 3000);
                    }
                },

                triggerScatter() {
                    // Select random dots for scatter effect
                    const randomDots = this.dots.filter(() => Math.random() > 0.8);
                    randomDots.forEach(dot => {
                        dot.element.classList.add('scattered');
                        setTimeout(() => {
                            dot.element.classList.remove('scattered');
                        }, 600);
                    });
                },

                triggerEnhancedScatter() {
                    // More dynamic scatter effect for AI speaking
                    const randomDots = this.dots.filter(() => Math.random() > 0.7);
                    randomDots.forEach((dot, index) => {
                        setTimeout(() => {
                            dot.element.classList.add('scattered', 'audio-reactive');
                            setTimeout(() => {
                                dot.element.classList.remove('scattered', 'audio-reactive');
                            }, 800);
                        }, index * 50);
                    });
                },

                triggerFrequencyReaction() {
                    // Simulate frequency-based visual responses
                    const frequencyTypes = ['high-frequency', 'mid-frequency', 'low-frequency'];
                    const selectedDots = this.dots.filter(() => Math.random() > 0.85);
                    
                    selectedDots.forEach(dot => {
                        const freqType = frequencyTypes[Math.floor(Math.random() * frequencyTypes.length)];
                        dot.element.classList.add(freqType);
                        setTimeout(() => {
                            dot.element.classList.remove(freqType);
                        }, 1200);
                    });
                },

                triggerThinkingEffect() {
                    // Subtle wave effect for thinking mode
                    const centerDots = this.dots.filter(dot => dot.radius < 80);
                    centerDots.forEach((dot, index) => {
                        setTimeout(() => {
                            dot.element.style.transform += ' scale(1.1)';
                            dot.element.style.opacity = '0.9';
                            setTimeout(() => {
                                dot.element.style.transform = '';
                                dot.element.style.opacity = '';
                            }, 500);
                        }, index * 100);
                    });
                },

                startAudioAnalysis() {
                    // Real-time audio analysis for user speaking
                    if (liveAnalyser) {
                        this.audioAnalysisInterval = setInterval(() => {
                            const bufferLength = liveAnalyser.frequencyBinCount;
                            const dataArray = new Uint8Array(bufferLength);
                            liveAnalyser.getByteFrequencyData(dataArray);
                            
                            // Calculate average audio level
                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                sum += dataArray[i];
                            }
                            const avgLevel = sum / bufferLength / 255;
                            this.audioLevel = avgLevel;
                            
                            // Trigger reactive effects based on audio
                            if (avgLevel > 0.1) {
                                this.triggerAudioReaction(dataArray);
                            }
                        }, 50);
                    }
                },

                triggerAudioReaction(frequencyData) {
                    // React to real audio input
                    const highFreq = frequencyData.slice(Math.floor(frequencyData.length * 0.7));
                    const midFreq = frequencyData.slice(Math.floor(frequencyData.length * 0.3), Math.floor(frequencyData.length * 0.7));
                    const lowFreq = frequencyData.slice(0, Math.floor(frequencyData.length * 0.3));
                    
                    const highAvg = highFreq.reduce((a, b) => a + b, 0) / highFreq.length / 255;
                    const midAvg = midFreq.reduce((a, b) => a + b, 0) / midFreq.length / 255;
                    const lowAvg = lowFreq.reduce((a, b) => a + b, 0) / lowFreq.length / 255;
                    
                    // Apply frequency-specific reactions
                    if (highAvg > 0.2) {
                        const outerDots = this.dots.filter(dot => dot.radius > 90);
                        const reactDots = outerDots.filter(() => Math.random() > 0.8);
                        reactDots.forEach(dot => {
                            dot.element.classList.add('high-frequency');
                            setTimeout(() => dot.element.classList.remove('high-frequency'), 300);
                        });
                    }
                    
                    if (midAvg > 0.15) {
                        const midDots = this.dots.filter(dot => dot.radius > 40 && dot.radius < 90);
                        const reactDots = midDots.filter(() => Math.random() > 0.8);
                        reactDots.forEach(dot => {
                            dot.element.classList.add('mid-frequency');
                            setTimeout(() => dot.element.classList.remove('mid-frequency'), 400);
                        });
                    }
                    
                    if (lowAvg > 0.1) {
                        const innerDots = this.dots.filter(dot => dot.radius < 50);
                        const reactDots = innerDots.filter(() => Math.random() > 0.8);
                        reactDots.forEach(dot => {
                            dot.element.classList.add('low-frequency');
                            setTimeout(() => dot.element.classList.remove('low-frequency'), 500);
                        });
                    }
                },

                stopAudioAnalysis() {
                    if (this.audioAnalysisInterval) {
                        clearInterval(this.audioAnalysisInterval);
                        this.audioAnalysisInterval = null;
                    }
                },
                
                animate() {
                    this.time += 0.016; // Assuming 60fps
                    
                    this.dots.forEach(dot => {
                        let x = dot.baseX;
                        let y = dot.baseY;
                        
                        // Base floating animation
                        const floatX = Math.sin(this.time * dot.speed + dot.phaseOffset) * dot.floatAmplitude;
                        const floatY = Math.cos(this.time * dot.speed * 0.7 + dot.phaseOffset) * dot.floatAmplitude;
                        
                        // Mode-specific animations
                        if (this.mode === 'idle') {
                            // Enhanced gentle breathing motion
                            const breatheMain = Math.sin(this.time * 0.4) * 1.5;
                            const breatheSecondary = Math.cos(this.time * 0.6 + dot.phaseOffset) * 0.8;
                            const orbitalMotion = Math.sin(this.time * 0.08 + dot.phaseOffset) * 0.5;
                            
                            x += floatX + Math.cos(dot.angle + this.time * 0.05 + orbitalMotion) * breatheMain;
                            y += floatY + Math.sin(dot.angle + this.time * 0.05 + orbitalMotion) * (breatheMain + breatheSecondary);
                            
                            // Occasional subtle sparkle effect
                            if (Math.random() > 0.9998) {
                                dot.element.style.transform += ' scale(1.3)';
                                dot.element.style.opacity = '1';
                                setTimeout(() => {
                                    dot.element.style.transform = '';
                                    dot.element.style.opacity = '';
                                }, 200);
                            }
                            
                        } else if (this.mode === 'user_speaking') {
                            // Inward contraction with audio response
                            const contraction = 0.7 + Math.sin(this.time * 3) * 0.1 + this.audioLevel * 0.2;
                            const newRadius = dot.radius * contraction;
                            x = 150 + Math.cos(dot.angle) * newRadius;
                            y = 150 + Math.sin(dot.angle) * newRadius;
                            
                            // Add vibration based on audio
                            x += Math.random() * this.audioLevel * 10 - 5;
                            y += Math.random() * this.audioLevel * 10 - 5;
                            
                        } else if (this.mode === 'ai_responding' || this.mode === 'ai_speaking') {
                            // Enhanced AI speaking animation
                            const expansion = 1.1 + Math.sin(this.time * 2.5 + dot.phaseOffset) * 0.2;
                            const rotation = this.time * 0.3 + dot.phaseOffset;
                            const newRadius = dot.radius * expansion;
                            x = 150 + Math.cos(dot.angle + rotation) * newRadius;
                            y = 150 + Math.sin(dot.angle + rotation) * newRadius;
                            
                            // Add more dynamic flowing motion
                            const flowX = Math.sin(this.time * 2 + dot.phaseOffset) * 4;
                            const flowY = Math.cos(this.time * 1.8 + dot.phaseOffset) * 4;
                            x += flowX;
                            y += flowY;
                            
                            // Add occasional burst effects
                            if (Math.random() > 0.995) {
                                const burstX = Math.random() * 20 - 10;
                                const burstY = Math.random() * 20 - 10;
                                x += burstX * dot.responseStrength;
                                y += burstY * dot.responseStrength;
                            }
                            
                        } else if (this.mode === 'ai_thinking') {
                            // Slower, more contemplative movement
                            const breathe = Math.sin(this.time * 0.8 + dot.phaseOffset) * 1.5;
                            const contemplate = Math.cos(this.time * 0.3 + dot.phaseOffset) * 0.5;
                            x += floatX * 0.5 + contemplate;
                            y += floatY * 0.5 + breathe;
                            
                            // Subtle inward-outward motion
                            const thinkRadius = dot.radius + Math.sin(this.time * 1.2 + dot.phaseOffset) * 3;
                            x = 150 + Math.cos(dot.angle) * thinkRadius - 150 + x;
                            y = 150 + Math.sin(dot.angle) * thinkRadius - 150 + y;
                        }
                        
                        // Apply smooth transition
                        dot.currentX = dot.currentX + (x - dot.currentX) * 0.1;
                        dot.currentY = dot.currentY + (y - dot.currentY) * 0.1;
                        
                        // Don't override scatter transform if active
                        if (!dot.element.classList.contains('scattered')) {
                            dot.element.style.transform =
                                `translate(${dot.currentX - dot.baseX}px, ${dot.currentY - dot.baseY}px)`;
                        }
                        
                        // Dynamic opacity based on mode
                        let baseOpacity, opacityVariation;
                        
                        if (this.mode === 'idle') {
                            baseOpacity = 0.4 + Math.sin(this.time * 0.3 + dot.phaseOffset) * 0.2;
                            opacityVariation = Math.sin(this.time * dot.speed * 1.5 + dot.phaseOffset) * 0.15;
                        } else if (this.mode === 'ai_thinking') {
                            baseOpacity = 0.6 + Math.sin(this.time * 0.8 + dot.phaseOffset) * 0.1;
                            opacityVariation = Math.sin(this.time * dot.speed * 1.2 + dot.phaseOffset) * 0.1;
                        } else {
                            baseOpacity = 0.8;
                            opacityVariation = Math.sin(this.time * dot.speed * 2 + dot.phaseOffset) * 0.2;
                        }
                        
                        dot.element.style.opacity = Math.max(0.2, Math.min(1, baseOpacity + opacityVariation));
                    });
                    
                    this.animationId = requestAnimationFrame(() => this.animate());
                },

                // Simulate audio level for demo
                simulateAudioLevel() {
                    if (this.mode === 'user_speaking') {
                        this.audioLevel = 0.3 + Math.random() * 0.7;
                    } else {
                        this.audioLevel = Math.max(0, this.audioLevel - 0.05);
                    }
                }
            };
            
            voiceSphereSystem.start();
        }

        function toggleLiveRecording() {
            if (!liveVoiceSystem || !liveVoiceSystem.isActive) {
                console.warn('Live voice system not active');
                updateConversationStatus('Error', 'System not ready');
                return;
            }
            
            // Toggle recording state
            if (liveVoiceSystem.isRecording) {
                liveVoiceSystem.stopRecording();
            } else {
                liveVoiceSystem.startRecording();
            }
            
            return; // Early return to skip old implementation
            
            if (isLiveRecording) {
                // Manual stop - process the recording
                console.log('🛑 Manual stop - processing recording');
                stopLiveRecording();
                processAudioForTranscription();
            } else {
                // Manual start
                console.log('🎤 Manual start - beginning recording');
                startLiveRecording();
            }
        }

        async function startLiveRecording() {
            if (isLiveRecording) return;
            
            try {
                // Get microphone access with high-quality settings
                liveMediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000,  // Higher sample rate for better quality
                        channelCount: 1,    // Mono for voice
                        volume: 1.0,        // Full volume
                        latency: 0.01       // Low latency
                    }
                });
                
                // Setup high-quality audio context and analyser
                liveAudioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 48000,
                    latencyHint: 'interactive'
                });
                const source = liveAudioContext.createMediaStreamSource(liveMediaStream);
                liveAnalyser = liveAudioContext.createAnalyser();
                liveAnalyser.fftSize = 2048;  // Higher resolution for better quality
                liveAnalyser.smoothingTimeConstant = 0.8;
                
                // Add echo cancellation filter
                const echoSuppressionGain = liveAudioContext.createGain();
                echoSuppressionGain.gain.value = 0.5;  // Reduce echo
                
                source.connect(echoSuppressionGain);
                echoSuppressionGain.connect(liveAnalyser);
                
                // Setup modern audio processing (fallback to ScriptProcessor if needed)
                audioBuffer = [];
                isLiveRecording = true;
                isListeningForSilence = true;
                
                // Update UI for manual recording mode
                const micBtn = document.getElementById('live-mic-btn');
                if (micBtn) {
                    micBtn.classList.add('recording');
                    micBtn.title = '🔴 Recording - Click to stop and process';
                }
                
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('user_speaking');
                }
                
                updateTranscriptionText('🔴 Recording... Click microphone to stop and process');
                
                // Use MediaRecorder with low-latency settings optimized for speed
                try {
                    const mediaRecorder = new MediaRecorder(liveMediaStream, {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 64000  // Lower bitrate for faster processing
                    });
                    
                    const audioChunks = [];
                    
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        if (audioChunks.length > 0) {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            processAudioBlob(audioBlob);
                            audioChunks.length = 0;
                        }
                    };
                    
                    // Store for cleanup
                    window.currentMediaRecorder = mediaRecorder;
                    
                    // Start recording with smaller chunks for lower latency
                    mediaRecorder.start(50); // Collect data every 50ms for faster processing
                    
                    // Manual mode - no VAD detection
                    console.log('📝 Manual recording mode - user controls start/stop');
                    
                } catch (e) {
                    console.warn('MediaRecorder not available, falling back to ScriptProcessor:', e);
                    // Fallback to ScriptProcessor with smaller buffer for lower latency
                    audioProcessor = liveAudioContext.createScriptProcessor(2048, 1, 1);
                    source.connect(audioProcessor);
                    audioProcessor.connect(liveAudioContext.destination);
                    
                    // Process audio data
                    audioProcessor.onaudioprocess = function(e) {
                        if (!isLiveRecording) return;
                        
                        const inputData = e.inputBuffer.getChannelData(0);
                        audioBuffer.push(new Float32Array(inputData));
                        
                        // Manual mode - no automatic voice detection
                        // Just collect audio data for when user manually stops
                    };
                }
                
                console.log('Live recording started');
                
            } catch (error) {
                console.error('Error starting live recording:', error);
                updateTranscriptionText('❌ Microphone access denied');
            }
        }

        function stopLiveRecording() {
            if (!isLiveRecording) return;
            
            isLiveRecording = false;
            isListeningForSilence = false;
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            
            // Update UI
            const micBtn = document.getElementById('live-mic-btn');
            if (micBtn) {
                micBtn.classList.remove('recording', 'listening');
                micBtn.title = '🎤 Click to start recording';
            }
            
            // Stop audio processing
            if (window.currentMediaRecorder) {
                window.currentMediaRecorder.stop();
                window.currentMediaRecorder = null;
            }
            
            if (audioProcessor) {
                audioProcessor.disconnect();
                audioProcessor = null;
            }
            
            if (liveAudioContext) {
                liveAudioContext.close();
                liveAudioContext = null;
            }
            
            if (liveMediaStream) {
                liveMediaStream.getTracks().forEach(track => track.stop());
                liveMediaStream = null;
            }
            
            if (voiceSphereSystem) {
                voiceSphereSystem.stopAudioAnalysis(); // Stop audio analysis
                voiceSphereSystem.setMode('idle');
            }
            
            // Process recorded audio if we have any
            if (audioBuffer.length > 0) {
                processRecordedAudio();
            } else {
                updateTranscriptionText('🎤 Click microphone to record');
            }
            
            console.log('Live recording stopped');
        }

        function detectVoiceActivity() {
            if (!liveAnalyser || !isLiveRecording) return;
            
            const dataArray = new Uint8Array(liveAnalyser.frequencyBinCount);
            liveAnalyser.getByteFrequencyData(dataArray);
            
            // Calculate average amplitude
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            
            // Voice activity threshold (adjust as needed)
            const voiceThreshold = 25;
            const silenceThreshold = 15;
            
            if (average > voiceThreshold) {
                // Voice detected
                if (!isListeningForSilence) {
                    isListeningForSilence = true;
                    updateTranscriptionText('🎤 Speaking detected...');
                }
                
                // Clear silence timer
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
            } else if (average < silenceThreshold && isListeningForSilence) {
                // Manual mode - no automatic processing on silence
                // Just continue recording until user manually stops
            }
        }

        async function processRecordedAudio() {
            if (audioBuffer.length === 0) return;
            
            try {
                updateTranscriptionText('🔄 Converting speech to text...');
                
                // Convert audio buffer to WAV format
                const audioData = mergeAudioBuffers(audioBuffer);
                const wavBlob = createWavBlob(audioData, 44100);
                
                // Convert to base64 for transmission (chunk-wise to avoid stack overflow)
                const arrayBuffer = await wavBlob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Process in chunks to avoid "Maximum call stack size exceeded"
                let binaryString = '';
                const chunkSize = 8192;
                for (let i = 0; i < uint8Array.length; i += chunkSize) {
                    const chunk = uint8Array.slice(i, i + chunkSize);
                    binaryString += String.fromCharCode.apply(null, chunk);
                }
                const base64Audio = btoa(binaryString);
                
                // Send to STT - check if socket is connected
                if (socket && socket.connected) {
                    socket.emit('live_send_audio', {
                        audio_data: base64Audio,
                        format: 'wav'
                    });
                    console.log('🎵 Audio sent to server for processing');
                } else {
                    console.warn('⚠️ Socket not connected - cannot send audio');
                    updateTranscriptionText('⚠️ Connection lost - please refresh page');
                }
                
                audioBuffer = [];
                
            } catch (error) {
                console.error('Error processing audio:', error);
                updateTranscriptionText('❌ Error processing audio');
            }
        }

        function mergeAudioBuffers(buffers) {
            let totalLength = 0;
            for (let buffer of buffers) {
                totalLength += buffer.length;
            }
            
            const result = new Float32Array(totalLength);
            let offset = 0;
            for (let buffer of buffers) {
                result.set(buffer, offset);
                offset += buffer.length;
            }
            
            return result;
        }

        function createWavBlob(audioData, sampleRate) {
            const length = audioData.length;
            const buffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // Convert float samples to 16-bit PCM
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, audioData[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }

        function updateTranscriptionText(text) {
            const transcriptionElement = document.getElementById('transcription-text');
            if (transcriptionElement) {
                transcriptionElement.textContent = text;
            }
        }

        function startVADDetection() {
            // Start voice activity detection loop
            function checkVAD() {
                if (isLiveRecording) {
                    detectVoiceActivity();
                    setTimeout(checkVAD, 100); // Check every 100ms
                }
            }
            checkVAD();
        }
        
        // Manual processing when user clicks stop
        function processAudioForTranscription() {
            if (audioBuffer.length > 0) {
                console.log('📝 Manual stop - processing audio');
                updateTranscriptionText('🔄 Processing your speech...');
                sendAudioToElevenLabs(audioBuffer);
                audioBuffer = [];
                isUserSpeaking = false;
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('idle');
                }
            } else {
                updateTranscriptionText('🎤 Click microphone to record');
            }
        }

        async function processAudioBlob(audioBlob) {
            try {
                updateTranscriptionText('🔄 Converting speech to text...');
                
                // Convert blob to base64
                const arrayBuffer = await audioBlob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Process in chunks to avoid "Maximum call stack size exceeded"
                let binaryString = '';
                const chunkSize = 8192;
                for (let i = 0; i < uint8Array.length; i += chunkSize) {
                    const chunk = uint8Array.slice(i, i + chunkSize);
                    binaryString += String.fromCharCode.apply(null, chunk);
                }
                const base64Audio = btoa(binaryString);
                
                // Send to STT - check if socket is connected
                if (socket && socket.connected) {
                    socket.emit('live_send_audio', {
                        audio_data: base64Audio,
                        format: 'webm'
                    });
                    console.log('🎵 Audio sent to server for processing');
                } else {
                    console.warn('⚠️ Socket not connected - cannot send audio');
                    updateTranscriptionText('⚠️ Connection lost - please refresh page');
                }
                
            } catch (error) {
                console.error('Error processing audio blob:', error);
                updateTranscriptionText('❌ Error processing audio');
            }
        }

        function playAudioChunk(audioBase64) {
            try {
                // Convert base64 to blob URL
                const byteCharacters = atob(audioBase64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const audioBlob = new Blob([byteArray], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Create and play audio element with quality settings
                const audio = new Audio(audioUrl);
                audio.volume = 0.8;  // Prevent distortion
                audio.preload = 'auto';
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                };
                audio.play().catch(error => {
                    console.error('Error playing audio chunk:', error);
                });
                
            } catch (error) {
                console.error('Error processing audio chunk:', error);
            }
        }

        function toggleHandsFree() {
            isHandsFreeMode = !isHandsFreeMode;
            const toggle = document.getElementById('hands-free-toggle');
            
            if (toggle) {
                if (isHandsFreeMode) {
                    toggle.classList.add('active');
                    updateConversationStatus('Hands-free Active', 'Just start speaking naturally');
                } else {
                    toggle.classList.remove('active');
                    updateConversationStatus('Ready', 'Press and hold microphone to speak');
                }
            }
            
            return isHandsFreeMode;
        }

        function showSources() {
            alert('Sources feature coming soon!\n\nThis will show the references and sources that the AI uses to generate responses.');
        }

        function updateTranscription(text, isListening = false) {
            const transcriptionText = document.getElementById('transcription-text');
            if (transcriptionText) {
                if (isListening) {
                    transcriptionText.style.color = '#c17b47';
                    transcriptionText.style.fontStyle = 'italic';
                } else {
                    transcriptionText.style.color = '#1a1a1a';
                    transcriptionText.style.fontStyle = 'normal';
                }
                transcriptionText.textContent = text;
            }
        }

        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateTranscription('Speech recognition not supported in this browser');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            speechRecognition.onresult = (event) => {
                let transcript = '';
                let isFinal = false;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        isFinal = true;
                    }
                }
                
                updateTranscription(transcript || 'Listening...');
                
                // Send final transcript to ElevenLabs agent
                if (isFinal && transcript.trim() && sessionActive && currentSessionId) {
                    console.log('Sending speech to ElevenLabs:', transcript);
                    socket.emit('live_send_text', {
                        session_id: currentSessionId,
                        message: transcript.trim()
                    });
                }
            };

            speechRecognition.onerror = (event) => {
                updateTranscription('Error: ' + event.error);
            };

            speechRecognition.start();
        }

        function stopSpeechRecognition() {
            if (speechRecognition) {
                speechRecognition.stop();
                speechRecognition = null;
            }
        }

        function initializeParticleSystem() {
            if (!particleCanvas) return;
            
            const ctx = particleCanvas.getContext('2d');
            const canvas = particleCanvas;
            
            // Set canvas size
            canvas.width = 400;
            canvas.height = 400;
            
            // Particle system state
            const particles = [];
            const particleCount = 100;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const baseRadius = 80;
            
            let currentMode = 'idle';
            let audioLevel = 0;
            let animationId;
            let modeTransition = 0; // 0-1 for smooth transitions
            
            // Create particles
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    angle: (i / particleCount) * Math.PI * 2,
                    baseRadius: baseRadius + Math.random() * 20,
                    currentRadius: baseRadius + Math.random() * 20,
                    targetRadius: baseRadius + Math.random() * 20,
                    size: Math.random() * 3 + 1,
                    speed: Math.random() * 0.02 + 0.01,
                    alpha: Math.random() * 0.5 + 0.3,
                    pulseOffset: Math.random() * Math.PI * 2,
                    color: { r: 193, g: 123, b: 71 }
                });
            }
            
            function updateParticleTargets(mode) {
                particles.forEach((particle) => {
                    switch (mode) {
                        case 'user_speaking':
                            // Particles move inward when user speaks
                            particle.targetRadius = particle.baseRadius * 0.6;
                            particle.color = { r: 100, g: 150, b: 200 }; // Cool blue for user
                            break;
                        case 'ai_responding':
                            // Particles expand outward when AI responds
                            particle.targetRadius = particle.baseRadius * 1.4;
                            particle.color = { r: 193, g: 123, b: 71 }; // App primary color
                            break;
                        case 'idle':
                        default:
                            // Gentle breathing motion when idle
                            particle.targetRadius = particle.baseRadius;
                            particle.color = { r: 160, g: 160, b: 160 }; // Subtle gray
                            break;
                    }
                });
            }
            
            function animate() {
                if (!isLiveConversationActive) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Get audio level if analyzer is available
                if (liveAnalyser && !isLiveMuted) {
                    const dataArray = new Uint8Array(liveAnalyser.frequencyBinCount);
                    liveAnalyser.getByteFrequencyData(dataArray);
                    audioLevel = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length / 255;
                }
                
                // Update mode transition for smooth animations
                modeTransition = Math.min(1, modeTransition + 0.05);
                
                // Draw particles
                particles.forEach((particle, index) => {
                    // Smooth transition to target radius
                    const radiusDiff = particle.targetRadius - particle.currentRadius;
                    particle.currentRadius += radiusDiff * 0.1;
                    
                    // Update angle
                    particle.angle += particle.speed;
                    
                    // Calculate position with audio responsiveness
                    let currentRadius = particle.currentRadius;
                    
                    if (currentMode === 'user_speaking' && audioLevel > 0) {
                        // Add audio-reactive scaling for user speech
                        currentRadius *= (0.9 + audioLevel * 0.3);
                    } else if (currentMode === 'ai_responding') {
                        // Gentle pulsing for AI response
                        const pulse = Math.sin(Date.now() * 0.004 + particle.pulseOffset) * 0.15;
                        currentRadius *= (1 + pulse);
                    } else if (currentMode === 'idle') {
                        // Subtle breathing motion when idle
                        const breathe = Math.sin(Date.now() * 0.002 + particle.pulseOffset) * 0.05;
                        currentRadius *= (1 + breathe);
                    }
                    
                    const x = centerX + Math.cos(particle.angle) * currentRadius;
                    const y = centerY + Math.sin(particle.angle) * currentRadius;
                    
                    // Calculate alpha based on mode and audio level
                    let alpha = particle.alpha;
                    if (currentMode === 'user_speaking' && audioLevel > 0) {
                        alpha = Math.min(1, particle.alpha * (1 + audioLevel * 2));
                    } else if (currentMode === 'ai_responding') {
                        alpha = particle.alpha * (0.8 + Math.sin(Date.now() * 0.005 + particle.pulseOffset) * 0.3);
                    }
                    
                    // Interpolate color
                    const r = Math.floor(particle.color.r * modeTransition + 255 * (1 - modeTransition));
                    const g = Math.floor(particle.color.g * modeTransition + 255 * (1 - modeTransition));
                    const b = Math.floor(particle.color.b * modeTransition + 255 * (1 - modeTransition));
                    
                    // Draw particle with glow effect
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    ctx.fill();
                    
                    // Add inner glow
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(x, y, particle.size * 0.6, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${Math.min(255, r + 50)}, ${Math.min(255, g + 50)}, ${Math.min(255, b + 50)}, ${alpha * 0.8})`;
                    ctx.fill();
                    
                    ctx.shadowBlur = 0;
                });
                
                // Draw central core
                const coreSize = currentMode === 'user_speaking' ? 8 + audioLevel * 10 : 
                                currentMode === 'ai_responding' ? 10 + Math.sin(Date.now() * 0.01) * 3 : 
                                6 + Math.sin(Date.now() * 0.003) * 2;
                
                ctx.shadowBlur = 20;
                ctx.shadowColor = currentMode === 'user_speaking' ? 'rgba(100, 150, 200, 0.8)' :
                                 currentMode === 'ai_responding' ? 'rgba(193, 123, 71, 0.8)' :
                                 'rgba(160, 160, 160, 0.6)';
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, coreSize, 0, Math.PI * 2);
                ctx.fillStyle = currentMode === 'user_speaking' ? 'rgba(100, 150, 200, 0.9)' :
                               currentMode === 'ai_responding' ? 'rgba(193, 123, 71, 0.9)' :
                               'rgba(160, 160, 160, 0.8)';
                ctx.fill();
                ctx.shadowBlur = 0;
                
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
            
            // Store particle system for cleanup and mode control
            particleSystem = {
                setMode: (mode) => {
                    if (mode !== currentMode) {
                        currentMode = mode;
                        modeTransition = 0;
                        updateParticleTargets(mode);
                        console.log(`🎨 Particle system mode: ${mode}`);
                    }
                },
                stop: () => {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                },
                getMode: () => currentMode
            };
        }

        // Live conversation variables
        let currentSessionId = null;
        let sessionActive = false;

        // Settings Modal Functions
        function showSettingsModal() {
            const settingsModal = document.getElementById('settings-modal');
            settingsModal.classList.add('active');
        }

        function hideSettingsModal() {
            const settingsModal = document.getElementById('settings-modal');
            settingsModal.classList.remove('active');
        }

        function switchSettingsSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active to selected nav item
            const targetNavItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (targetNavItem) {
                targetNavItem.classList.add('active');
            }
        }

        function updateFontPreview() {
            const fontSelect = document.getElementById('font-family-select');
            const fontPreview = document.getElementById('font-preview');
            const selectedFont = fontSelect.value;
            
            fontPreview.style.fontFamily = selectedFont;
            
            // Apply to body as well
            document.body.style.fontFamily = selectedFont;
        }

        function selectTheme(theme) {
            // Remove active from all theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active to selected theme
            const selectedOption = document.querySelector(`[data-theme="${theme}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            // Apply theme
            applyTheme(theme);
            
            // Store theme preference
            localStorage.setItem('omnix-theme', theme);
        }

        function applyTheme(theme) {
            const body = document.body;
            
            // Remove existing theme classes
            body.classList.remove('theme-light', 'theme-dark', 'theme-system');
            
            if (theme === 'dark') {
                body.classList.add('theme-dark');
                body.style.background = '#2d2d2d';
                body.style.backgroundColor = '#2d2d2d';
                body.style.color = '#ffffff';
                
                // Force all major containers to dark
                const containers = document.querySelectorAll('.main-content, .chat-interface, .welcome-screen, .chat-messages, .chat-input-area, .input-wrapper, .welcome-input-container');
                containers.forEach(container => {
                    container.style.background = '#2d2d2d';
                    container.style.backgroundColor = '#2d2d2d';
                    container.style.color = '#ffffff';
                });
                
            } else if (theme === 'light') {
                body.classList.add('theme-light');
                body.style.background = '#f7f7f5';
                body.style.backgroundColor = '#f7f7f5';
                body.style.color = '#1a1a1a';
                
                // Force all major containers to light
                const containers = document.querySelectorAll('.main-content, .chat-interface, .welcome-screen, .chat-messages, .chat-input-area, .input-wrapper, .welcome-input-container');
                containers.forEach(container => {
                    container.style.background = '#f7f7f5';
                    container.style.backgroundColor = '#f7f7f5';
                    container.style.color = '#1a1a1a';
                });
                
            } else if (theme === 'system') {
                body.classList.add('theme-system');
                // Check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    body.style.background = '#2d2d2d';
                    body.style.backgroundColor = '#2d2d2d';
                    body.style.color = '#ffffff';
                } else {
                    body.style.background = '#f7f7f5';
                    body.style.backgroundColor = '#f7f7f5';
                    body.style.color = '#1a1a1a';
                }
            }
            
            // Update other elements
            updateThemeElements(theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches));
        }

        function updateThemeElements(isDark) {
            const elements = {
                sidebar: document.querySelector('.sidebar'),
                sidebarMini: document.querySelector('.sidebar-mini'),
                mainContent: document.querySelector('.main-content'),
                chatMessages: document.querySelector('.chat-messages'),
                welcomeScreen: document.querySelector('.welcome-screen'),
                chatInterface: document.querySelector('.chat-interface'),
                chatInputArea: document.querySelector('.chat-input-area'),
                chatInput: document.querySelector('#chat-input'),
                welcomeInput: document.querySelector('#welcome-input')
            };

            if (isDark) {
                // Dark theme colors
                if (elements.sidebar) {
                    elements.sidebar.style.background = '#2d2d2d';
                    elements.sidebar.style.borderColor = '#404040';
                    elements.sidebar.style.color = '#ffffff';
                }
                if (elements.sidebarMini) {
                    elements.sidebarMini.style.background = '#2d2d2d';
                }
                if (elements.mainContent) {
                    elements.mainContent.style.background = '#2d2d2d';
                    elements.mainContent.style.color = '#ffffff';
                    elements.mainContent.style.opacity = '1';
                }
                if (elements.chatMessages) {
                    elements.chatMessages.style.background = '#2d2d2d';
                    elements.chatMessages.style.color = '#ffffff';
                    elements.chatMessages.style.opacity = '1';
                }
                if (elements.welcomeScreen) {
                    elements.welcomeScreen.style.background = '#2d2d2d';
                    elements.welcomeScreen.style.color = '#ffffff';
                    elements.welcomeScreen.style.opacity = '1';
                }
                if (elements.chatInterface) {
                    elements.chatInterface.style.background = '#2d2d2d';
                    elements.chatInterface.style.color = '#ffffff';
                    elements.chatInterface.style.opacity = '1';
                }
                if (elements.chatInputArea) {
                    elements.chatInputArea.style.background = '#2d2d2d';
                    elements.chatInputArea.style.borderColor = '#404040';
                    elements.chatInputArea.style.opacity = '1';
                }
                if (elements.chatInput) {
                    elements.chatInput.style.background = '#383838';
                    elements.chatInput.style.color = '#ffffff';
                    elements.chatInput.style.borderColor = '#555555';
                }
                if (elements.welcomeInput) {
                    elements.welcomeInput.style.background = '#383838';
                    elements.welcomeInput.style.color = '#ffffff';
                    elements.welcomeInput.style.borderColor = '#555555';
                }

                // Force update input wrappers
                const inputWrappers = document.querySelectorAll('.input-wrapper');
                inputWrappers.forEach(wrapper => {
                    wrapper.style.background = '#2d2d2d';
                    wrapper.style.borderColor = '#404040';
                });

                // Force update welcome input container
                const welcomeInputContainers = document.querySelectorAll('.welcome-input-container');
                welcomeInputContainers.forEach(container => {
                    container.style.background = '#2d2d2d';
                    container.style.opacity = '1';
                });
                
                // Update all text elements
                updateTextElements('#ffffff');
                
                // Update chat messages
                updateChatMessages(true);
                
                // Update buttons and controls
                updateControlElements(true);
                
            } else {
                // Light theme colors
                if (elements.sidebar) {
                    elements.sidebar.style.background = '#ffffff';
                    elements.sidebar.style.borderColor = '#e5e5e5';
                    elements.sidebar.style.color = '#1a1a1a';
                }
                if (elements.sidebarMini) {
                    elements.sidebarMini.style.background = '#ffffff';
                }
                if (elements.mainContent) {
                    elements.mainContent.style.background = '#f7f7f5';
                    elements.mainContent.style.color = '#1a1a1a';
                }
                if (elements.chatMessages) {
                    elements.chatMessages.style.background = '#f7f7f5';
                    elements.chatMessages.style.color = '#1a1a1a';
                }
                if (elements.welcomeScreen) {
                    elements.welcomeScreen.style.background = '#f7f7f5';
                    elements.welcomeScreen.style.color = '#1a1a1a';
                }
                if (elements.chatInterface) {
                    elements.chatInterface.style.background = '#f7f7f5';
                    elements.chatInterface.style.color = '#1a1a1a';
                }
                if (elements.chatInputArea) {
                    elements.chatInputArea.style.background = '#ffffff';
                    elements.chatInputArea.style.borderColor = '#e5e5e5';
                }
                if (elements.chatInput) {
                    elements.chatInput.style.background = '#ffffff';
                    elements.chatInput.style.color = '#1a1a1a';
                    elements.chatInput.style.borderColor = '#e5e5e5';
                }
                if (elements.welcomeInput) {
                    elements.welcomeInput.style.background = '#ffffff';
                    elements.welcomeInput.style.color = '#1a1a1a';
                    elements.welcomeInput.style.borderColor = '#e5e5e5';
                }

                // Force update input wrappers
                const inputWrappers = document.querySelectorAll('.input-wrapper');
                inputWrappers.forEach(wrapper => {
                    wrapper.style.background = '#ffffff';
                    wrapper.style.borderColor = '#e5e5e5';
                });

                // Force update welcome input container
                const welcomeInputContainers = document.querySelectorAll('.welcome-input-container');
                welcomeInputContainers.forEach(container => {
                    container.style.background = '#f7f7f5';
                });
                
                // Update all text elements
                updateTextElements('#1a1a1a');
                
                // Update chat messages
                updateChatMessages(false);
                
                // Update buttons and controls
                updateControlElements(false);
            }
        }

        function updateTextElements(color) {
            // Update all text elements aggressively with full opacity
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label, button, .mode-btn, .welcome-title');
            textElements.forEach(element => {
                // Skip elements that should keep their specific colors (like brand elements)
                if (!element.classList.contains('omnix-icon') && 
                    !element.classList.contains('user-message') && 
                    !element.classList.contains('new-chat-btn')) {
                    element.style.color = color + ' !important';
                    element.style.opacity = '1 !important';
                }
            });

            // Specifically target chat area elements
            const chatElements = document.querySelectorAll('.chat-messages *, .welcome-screen *, .chat-interface *');
            chatElements.forEach(element => {
                if (!element.classList.contains('omnix-icon') && 
                    !element.classList.contains('user-message')) {
                    element.style.color = color + ' !important';
                    element.style.opacity = '1 !important';
                }
            });

            // Target mode buttons specifically
            const modeButtons = document.querySelectorAll('.mode-btn, .mode-btn span, .mode-btn i');
            modeButtons.forEach(element => {
                element.style.color = color + ' !important';
                element.style.opacity = '1 !important';
            });
        }

        function updateChatMessages(isDark) {
            const chatMessages = document.querySelectorAll('.message');
            chatMessages.forEach(message => {
                if (isDark) {
                    message.style.background = '#2d2d2d';
                    message.style.color = '#ffffff';
                    message.style.borderColor = '#404040';
                } else {
                    message.style.background = '#ffffff';
                    message.style.color = '#1a1a1a';
                    message.style.borderColor = '#e5e5e5';
                }
            });

            // Update user messages
            const userMessages = document.querySelectorAll('.user-message');
            userMessages.forEach(message => {
                if (isDark) {
                    message.style.background = '#c17b47';
                    message.style.color = '#ffffff';
                } else {
                    message.style.background = '#c17b47';
                    message.style.color = '#ffffff';
                }
            });
        }

        function updateControlElements(isDark) {
            // Update control buttons
            const controlButtons = document.querySelectorAll('.input-control-btn, .welcome-control-btn');
            controlButtons.forEach(button => {
                if (isDark) {
                    button.style.background = '#383838';
                    button.style.color = '#ffffff';
                    button.style.borderColor = '#555555';
                } else {
                    button.style.background = '#f8f8f8';
                    button.style.color = '#666666';
                    button.style.borderColor = '#e5e5e5';
                }
            });

            // Update dropdowns and menus
            const dropdowns = document.querySelectorAll('.model-dropdown, .plus-menu, .slider-popup');
            dropdowns.forEach(dropdown => {
                if (isDark) {
                    dropdown.style.background = '#2d2d2d';
                    dropdown.style.color = '#ffffff';
                    dropdown.style.borderColor = '#404040';
                } else {
                    dropdown.style.background = '#ffffff';
                    dropdown.style.color = '#1a1a1a';
                    dropdown.style.borderColor = '#e5e5e5';
                }
            });
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('omnix-theme') || 'light';
            selectTheme(savedTheme);
        }
        
        function loadSavedVoice() {
            const savedVoice = localStorage.getItem('selectedVoiceId');
            if (savedVoice) {
                selectVoice(savedVoice);
            }
        }

        function selectVoice(voiceId) {
            // Remove active from all voice options
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active to selected voice
            const selectedOption = document.querySelector(`[data-voice="${voiceId}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            // Store the selected voice ID
            localStorage.setItem('selectedVoiceId', voiceId);
            
            console.log('Voice selected:', voiceId);
        }
        
        function getSelectedVoice() {
            // Get from localStorage or default to first voice
            const storedVoice = localStorage.getItem('selectedVoiceId');
            if (storedVoice) {
                return storedVoice;
            }
            
            // Default to the first active voice option
            const activeOption = document.querySelector('.voice-option.active');
            if (activeOption) {
                return activeOption.getAttribute('data-voice');
            }
            
            // Fallback to Tala voice (the default)
            return 'Hybl6rg76ZOcgqZqN5WN';
        }

        // Global variable to track currently playing audio and button
        let currentPreviewAudio = null;
        let currentPreviewButton = null;

        function previewVoice(voiceId) {
            console.log('Preview voice:', voiceId);
            
            // Stop any currently playing preview
            if (currentPreviewAudio) {
                currentPreviewAudio.pause();
                currentPreviewAudio = null;
            }
            
            // Reset any previously active button to play icon
            if (currentPreviewButton) {
                const icon = currentPreviewButton.querySelector('i');
                icon.className = 'fas fa-play';
                currentPreviewButton = null;
            }
            
            // Find the button for this voice
            const previewButton = document.querySelector(`[data-voice-id="${voiceId}"]`);
            if (previewButton) {
                const icon = previewButton.querySelector('i');
                icon.className = 'fas fa-pause'; // Change to pause icon
                currentPreviewButton = previewButton;
            }
            
            // Sample text for voice preview
            const previewText = "Hello! I'm Omnix AI. This is how I sound in live conversation mode.";
            
            // Send preview request to backend
            fetch('/api/voice-preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    voice_id: voiceId,
                    text: previewText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.audio_data) {
                    // Play the preview audio with quality settings
                    const audio = new Audio(`data:audio/mpeg;base64,${data.audio_data}`);
                    audio.volume = 0.8;  // Prevent distortion
                    audio.preload = 'auto';
                    audio.crossOrigin = 'anonymous';
                    
                    // Set up audio event listeners
                    audio.addEventListener('ended', () => {
                        // Reset button to play icon when audio ends
                        if (currentPreviewButton) {
                            const icon = currentPreviewButton.querySelector('i');
                            icon.className = 'fas fa-play';
                            currentPreviewButton = null;
                        }
                        currentPreviewAudio = null;
                    });
                    
                    audio.addEventListener('error', () => {
                        // Reset button to play icon on error
                        if (currentPreviewButton) {
                            const icon = currentPreviewButton.querySelector('i');
                            icon.className = 'fas fa-play';
                            currentPreviewButton = null;
                        }
                        currentPreviewAudio = null;
                    });
                    
                    currentPreviewAudio = audio;
                    audio.play().catch(error => {
                        console.error('Failed to play voice preview:', error);
                        // Reset button to play icon on play error
                        if (currentPreviewButton) {
                            const icon = currentPreviewButton.querySelector('i');
                            icon.className = 'fas fa-play';
                            currentPreviewButton = null;
                        }
                        currentPreviewAudio = null;
                    });
                } else {
                    console.error('Voice preview failed:', data.error);
                    // Reset button to play icon on API error
                    if (currentPreviewButton) {
                        const icon = currentPreviewButton.querySelector('i');
                        icon.className = 'fas fa-play';
                        currentPreviewButton = null;
                    }
                }
            })
            .catch(error => {
                console.error('Voice preview request failed:', error);
                // Reset button to play icon on request error
                if (currentPreviewButton) {
                    const icon = currentPreviewButton.querySelector('i');
                    icon.className = 'fas fa-play';
                    currentPreviewButton = null;
                }
            });
        }

        function applySuggestion(suggestionType) {
            const liveModePrompt = document.getElementById('live-mode-prompt');
            
            const suggestions = {
                'personal-assistant': 'You are a helpful personal assistant. Be professional, efficient, and proactive in helping with tasks.',
                'emotional-partner': 'You are a caring and empathetic companion. Listen actively, provide emotional support, and respond with warmth.',
                'mindfulness': 'You are a mindfulness guide. Help with meditation, breathing exercises, and promoting mental well-being with a calm, peaceful tone.',
                'creative-companion': 'You are a creative partner. Encourage imagination, provide inspiration, and help brainstorm innovative ideas.',
                'study-buddy': 'You are a study companion. Help with learning, provide explanations, quiz knowledge, and motivate academic progress.'
            };
            
            if (suggestions[suggestionType]) {
                liveModePrompt.value = suggestions[suggestionType];
            }
        }

        function updateCreativitySlider() {
            const slider = document.getElementById('creativity-slider');
            const value = slider.value;
            
            // Update any model temperature settings based on checked models
            const liveVoiceModel = document.getElementById('live-voice-model').checked;
            const omnixFlash = document.getElementById('omnix-flash').checked;
            const omnixMaxima = document.getElementById('omnix-maxima').checked;
            
            console.log('Creativity level:', value, {
                liveVoiceModel,
                omnixFlash,
                omnixMaxima
            });
        }

        // Initialize Settings Modal Event Listeners
        function initializeSettingsModal() {
            const settingsModal = document.getElementById('settings-modal');
            const settingsCloseBtn = document.getElementById('settings-close-btn');
            const fontFamilySelect = document.getElementById('font-family-select');
            const creativitySlider = document.getElementById('creativity-slider');
            
            // Close modal event listeners
            settingsCloseBtn.addEventListener('click', hideSettingsModal);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    hideSettingsModal();
                }
            });
            
            // Navigation event listeners
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    switchSettingsSection(section);
                });
            });
            
            // Font selection
            fontFamilySelect.addEventListener('change', updateFontPreview);
            
            // Theme selection
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-theme');
                    selectTheme(theme);
                });
            });
            
            // Voice selection
            document.querySelectorAll('.voice-option').forEach(option => {
                option.addEventListener('click', () => {
                    const voice = option.getAttribute('data-voice');
                    selectVoice(voice);
                });
            });
            
            // Voice preview buttons
            document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const voiceId = btn.getAttribute('data-voice-id');
                    previewVoice(voiceId);
                });
            });
            
            // Suggestion buttons
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const suggestion = btn.getAttribute('data-suggestion');
                    applySuggestion(suggestion);
                });
            });
            
            // Creativity slider
            creativitySlider.addEventListener('input', updateCreativitySlider);
            
            // Model toggles
            document.querySelectorAll('.model-toggle input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateCreativitySlider);
            });
        }

        // Removed Socket.IO initialization - now using server-side processing
        function initializeSocket() {
            // Always connect to the Flask server on port 8003
            const serverUrl = 'http://localhost:8003';
            console.log('Connecting to Socket.IO server at:', serverUrl);
            
            // Check if io is available
            if (typeof io === 'undefined') {
                console.error('Socket.IO library not loaded!');
                throw new Error('Socket.IO library not loaded');
            }
            
            window.socket = socket = io(serverUrl, {
                transports: ['websocket', 'polling'], // Prioritize websocket
                upgrade: true, // Allow upgrading to websocket
                rememberUpgrade: true, // Remember the upgrade
                timeout: 5000, // Faster connection timeout
                forceNew: true, // Force new connection for better performance
                compression: false, // Disable compression for speed
                autoConnect: true
            });
            
            socket.on('connect', function() {
                console.log('Connected to server');
                console.log('Socket ID:', socket.id);
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                if (sessionActive) {
                    updateConversationStatus('Connection Lost', 'Attempting to reconnect...');
                }
            });

            // Live session events
            socket.on('live_session_created', function(data) {
                console.log('Live session created:', data);
                currentSessionId = data.session_id;
                updateConversationStatus('Session Starting...', 'Initializing ElevenLabs conversational AI');
            });

            socket.on('live_session_started', function(data) {
                console.log('Live session started:', data);
                sessionActive = true;
                updateConversationStatus('Ready', 'ElevenLabs AI agent is listening');
            });

            socket.on('live_transcript', function(data) {
                console.log('Received transcript:', data);
                if (data.type === 'user') {
                    updateTranscription('You: ' + data.text);
                }
            });
            
            socket.on('live_text_response', function(data) {
                console.log('Received AI text response:', data);
                // Update transcription with AI response
                updateTranscription('AI: ' + data.text);
                
                // Set voice sphere to AI speaking mode
                if (voiceSphereSystem) {
                    voiceSphereSystem.stopAudioAnalysis(); // Stop user audio analysis
                    voiceSphereSystem.setMode('ai_speaking');
                    setTimeout(() => voiceSphereSystem.setMode('idle'), 3000);
                }
            });

            socket.on('live_audio_response', function(data) {
                console.log('Received TTS audio response');
                // Play ElevenLabs TTS audio response
                if (data.audio_data) {
                    playElevenLabsAudio(data.audio_data);
                }
                if (voiceSphereSystem) {
                    voiceSphereSystem.stopAudioAnalysis(); // Stop user audio analysis
                    voiceSphereSystem.setMode('ai_speaking');
                }
                
                updateConversationStatus('Speaking', 'AI is responding');
            });

            socket.on('live_text_sent', function(data) {
                console.log('Text sent confirmation:', data);
                updateConversationStatus('Processing', 'Getting AI response...');
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('user_speaking');
                    setTimeout(() => voiceSphereSystem.setMode('idle'), 1000);
                }
            });

            socket.on('live_session_created', function(data) {
                console.log('Live session created:', data);
                updateConversationStatus('Connecting...', 'Session created, establishing connection');
            });
            
            socket.on('live_session_started', function(data) {
                console.log('Live session started:', data);
                
                // Clear timeout
                if (sessionStartTimeout) {
                    clearTimeout(sessionStartTimeout);
                    sessionStartTimeout = null;
                }
                
                updateConversationStatus('Connected', 'Ready to chat! Start speaking or send a text message');
                isLiveSessionActive = true;
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('idle');
                }
            });

            socket.on('live_session_ended', function(data) {
                console.log('Live session ended:', data);
                isLiveSessionActive = false;
                liveSessionId = null;
                updateConversationStatus('Session Ended', 'Thank you for the conversation');
                if (voiceSphereSystem) {
                    voiceSphereSystem.stopAudioAnalysis(); // Clean up audio analysis
                    voiceSphereSystem.setMode('idle');
                }
                resetSessionState();
            });

            // New streaming events for STT/TTS system
            socket.on('live_transcript_update', function(data) {
                console.log('Transcript update:', data);
                updateTranscriptionText('🎤 You: ' + data.transcript);
            });
            
            socket.on('live_ai_thinking', function(data) {
                console.log('AI thinking:', data);
                updateTranscriptionText('🤔 AI thinking...');
                if (voiceSphereSystem) {
                    // Keep listening even while AI is thinking - don't stop audio analysis
                    voiceSphereSystem.setMode('ai_thinking');
                }
            });
            
            socket.on('live_ai_speaking', function(data) {
                console.log('AI speaking:', data);
                updateTranscriptionText('🤖 AI speaking...');
                if (voiceSphereSystem) {
                    // Continue listening even while AI is speaking for interruptions
                    voiceSphereSystem.setMode('ai_speaking');
                }
            });
            
            socket.on('live_text_chunk', function(data) {
                console.log('Text chunk:', data);
                // Update transcription with streaming text
                updateTranscriptionText('🤖 AI: ' + data.full_text);
            });
            
            socket.on('live_audio_chunk', function(data) {
                console.log('Audio chunk received:', data.text);
                // Play TTS audio chunk immediately
                playAudioChunk(data.audio);
                
                // Make voice sphere react to audio
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('ai_speaking');
                    // Trigger audio reaction animation
                    voiceSphereSystem.triggerAudioReaction();
                }
            });
            
            socket.on('live_audio_received', function(data) {
                console.log('Audio received by server:', data);
                updateTranscriptionText('🔄 Processing audio...');
            });

            socket.on('live_response_complete', function(data) {
                console.log('Response complete:', data);
                
                // Manual mode - don't auto-restart, wait for user to click
                updateTranscriptionText('🎤 Click microphone to record your response');
                
                if (voiceSphereSystem) {
                    voiceSphereSystem.setMode('idle');
                }
            });

            socket.on('live_session_error', function(data) {
                console.error('Live session error:', data);
                
                let errorMessage = data.error || 'Connection issue occurred';
                let errorDetail = data.message || '';
                
                // Specific handling for ElevenLabs API issues
                if (errorMessage.includes('ElevenLabs') || errorMessage.includes('API key')) {
                    errorMessage = 'ElevenLabs Not Configured';
                    errorDetail = 'Please set your ELEVENLABS_API_KEY environment variable';
                }
                
                updateConversationStatus(errorMessage, errorDetail);
                isLiveSessionActive = false;
                resetSessionState();
            });
        }

        // New Live Control Functions
        function startLiveSession() {
            console.log('Starting live session...');
            updateConversationStatus('Initializing...', 'Please wait while we establish connection');
            
            // Show/hide appropriate buttons
            // liveStartBtn removed - using mic button only
            if (liveStopBtn) {
                liveStopBtn.style.display = 'flex';
                liveStopBtn.classList.add('active');
            }
            
            // Generate session ID and start ElevenLabs session
            liveSessionId = 'session_' + Date.now();
            
            // Set timeout for session start
            sessionStartTimeout = setTimeout(() => {
                if (!isLiveSessionActive) {
                    console.error('Session start timeout');
                    updateConversationStatus('Connection Timeout', 'Failed to establish connection. Check your ElevenLabs API key.');
                    resetSessionState();
                }
            }, 30000); // 30 second timeout
            
            // Start ElevenLabs session
            const selectedVoice = getSelectedVoice();
            socket.emit('live_session_start', { 
                session_id: liveSessionId, 
                agent_id: 'default',
                voice_id: selectedVoice
            });
            
            // Don't set isLiveSessionActive here - wait for live_session_started event
        }
        
        function stopLiveSession() {
            console.log('Stopping live session...');
            updateConversationStatus('Disconnecting...', 'Ending conversation');
            
            // Show/hide appropriate buttons
            // liveStartBtn removed - using mic button only
            if (liveStopBtn) liveStopBtn.style.display = 'none';
            // liveStartBtn removed - using mic button only
            if (liveStopBtn) liveStopBtn.classList.remove('active');
            
            // End ElevenLabs session
            if (liveSessionId) {
                socket.emit('live_session_end', { session_id: liveSessionId });
                liveSessionId = null;
            }
            
            isLiveSessionActive = false;
            updateConversationStatus('Ready', 'Click Start to begin a new conversation');
        }
        
        function toggleAudioMute() {
            isAudioMuted = !isAudioMuted;
            
            if (isAudioMuted) {
                if (liveMuteBtn) {
                    liveMuteBtn.classList.add('muted');
                    const icon = liveMuteBtn.querySelector('i');
                    const span = liveMuteBtn.querySelector('span');
                    if (icon) icon.className = 'fas fa-volume-mute';
                    if (span) span.textContent = 'Unmute';
                }
                updateConversationStatus('Audio Muted', 'You won\'t hear AI responses');
            } else {
                if (liveMuteBtn) {
                    liveMuteBtn.classList.remove('muted');
                    const icon = liveMuteBtn.querySelector('i');
                    const span = liveMuteBtn.querySelector('span');
                    if (icon) icon.className = 'fas fa-volume-up';
                    if (span) span.textContent = 'Mute';
                }
                updateConversationStatus('Audio Enabled', 'You\'ll hear AI responses');
            }
            
            console.log('Audio muted:', isAudioMuted);
        }
        
        function toggleTextInput() {
            if (liveTextInputContainer && liveTextInput && liveSendTextBtn) {
                if (liveTextInputContainer.style.display === 'none' || !liveTextInputContainer.style.display) {
                    liveTextInputContainer.style.display = 'flex';
                    liveTextInput.focus();
                    liveSendTextBtn.classList.add('active');
                } else {
                    liveTextInputContainer.style.display = 'none';
                    liveSendTextBtn.classList.remove('active');
                }
            }
        }
        
        function sendTextMessage() {
            if (!liveTextInput) return;
            
            const message = liveTextInput.value.trim();
            if (!message || !isLiveSessionActive || !liveSessionId) {
                if (!isLiveSessionActive) {
                    updateConversationStatus('Error', 'Please start a session first');
                }
                return;
            }
            
            console.log('Sending text message:', message);
            
            // Send to ElevenLabs
            socket.emit('live_send_text', {
                session_id: liveSessionId,
                message: message
            });
            
            // Clear input and hide
            liveTextInput.value = '';
            if (liveTextInputContainer) liveTextInputContainer.style.display = 'none';
            if (liveSendTextBtn) liveSendTextBtn.classList.remove('active');
            
            // Update transcription to show what user sent
            updateTranscription('You: ' + message);
        }
        
        function resetSessionState() {
            console.log('Resetting session state');
            isLiveSessionActive = false;
            liveSessionId = null;
            
            // Clear any timeouts
            if (sessionStartTimeout) {
                clearTimeout(sessionStartTimeout);
                sessionStartTimeout = null;
            }
            
            // Reset button states
            // liveStartBtn removed - using mic button only
            if (liveStopBtn) {
                liveStopBtn.style.display = 'none';
                liveStopBtn.classList.remove('active');
            }
            if (liveMuteBtn) {
                liveMuteBtn.classList.remove('muted');
                const icon = liveMuteBtn.querySelector('i');
                const span = liveMuteBtn.querySelector('span');
                if (icon) icon.className = 'fas fa-volume-up';
                if (span) span.textContent = 'Mute';
            }
            if (liveTextInputContainer) {
                liveTextInputContainer.style.display = 'none';
            }
            
            isAudioMuted = false;
        }

        // Initialize socket when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize socket after other initializations
            setTimeout(initializeSocket, 1000);
            
            // Initialize model dropdown
            initializeModelDropdown();
        });

        // Global variable to track current model
        let currentModel = 'flash'; // Default to Omnix Flash

        function initializeModelDropdown() {
            // Get elements for both welcome and chat dropdowns
            const welcomeSelector = document.getElementById('welcome-model-selector');
            const welcomeDropdown = document.getElementById('welcome-model-dropdown');
            const welcomeSelectedModel = document.getElementById('welcome-selected-model');
            
            const chatSelector = document.getElementById('chat-model-selector');
            const chatDropdown = document.getElementById('chat-model-dropdown');
            const chatSelectedModel = document.getElementById('chat-selected-model');

            // Set up welcome dropdown
            if (welcomeSelector && welcomeDropdown) {
                setupDropdown(welcomeSelector, welcomeDropdown, welcomeSelectedModel, 'welcome');
            }

            // Set up chat dropdown
            if (chatSelector && chatDropdown) {
                setupDropdown(chatSelector, chatDropdown, chatSelectedModel, 'chat');
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.model-selector-wrapper')) {
                    document.querySelectorAll('.model-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                    document.querySelectorAll('.model-selector-btn').forEach(btn => {
                        btn.classList.remove('open');
                    });
                }
            });

            // Set initial selected state for flash option
            updateModelSelection('flash');
        }

        function setupDropdown(selectorBtn, dropdown, selectedModelSpan, type) {
            // Toggle dropdown
            selectorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Close other dropdowns
                document.querySelectorAll('.model-dropdown').forEach(dd => {
                    if (dd !== dropdown) dd.classList.remove('show');
                });
                document.querySelectorAll('.model-selector-btn').forEach(btn => {
                    if (btn !== selectorBtn) btn.classList.remove('open');
                });

                // Toggle current dropdown
                dropdown.classList.toggle('show');
                selectorBtn.classList.toggle('open');
            });

            // Handle option selection
            dropdown.querySelectorAll('.model-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const model = option.dataset.model;
                    
                    if (model !== currentModel) {
                        selectModel(model);
                    }
                    
                    dropdown.classList.remove('show');
                    selectorBtn.classList.remove('open');
                });
            });
        }

        function selectModel(model) {
            currentModel = model;
            
            // Update UI
            updateModelSelection(model);
            
            // Handle mode switching
            if (model === 'maxima') {
                currentMode = 'complex';
            } else {
                currentMode = 'research'; // Default mode for Flash
            }
        }

        function updateModelSelection(model) {
            const modelNames = {
                'flash': 'Omnix Flash',
                'maxima': 'Omnix Maxima'
            };

            // Update dropdown buttons text
            document.querySelectorAll('[id$="-selected-model"]').forEach(span => {
                span.textContent = modelNames[model];
            });

            // Update selected state in dropdowns
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.model === model) {
                    option.classList.add('selected');
                }
            });
        }


        // Logo loading functionality
        async function loadOmnixLogo() {
            try {
                const response = await fetch('/api/logos');
                const data = await response.json();
                
                if (data.status === 'success' && data.omnix_logo) {
                    const welcomeLogo = document.getElementById('omnix-welcome-logo');
                    if (welcomeLogo) {
                        const img = welcomeLogo.querySelector('img');
                        if (img) {
                            img.src = data.omnix_logo;
                        }
                    }
                }
            } catch (error) {
                console.log('Using fallback logo - Supabase not configured:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize socket after other initializations
            setTimeout(initializeSocket, 1000);
            
            // Initialize settings modal
            initializeSettingsModal();
            
            // Load saved theme
            loadSavedTheme();
            
            // Load saved voice selection
            loadSavedVoice();
            
            // Load Omnix logo
            loadOmnixLogo();
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const currentTheme = localStorage.getItem('omnix-theme');
                if (currentTheme === 'system') {
                    applyTheme('system');
                }
            });
        });

    </script>
    
    <!-- Code Canvas -->
    <div class="code-canvas" id="codeCanvas">
        <div class="code-canvas-header">
            <div class="code-canvas-title" id="codeCanvasTitle">Code Canvas</div>
            <div class="code-canvas-tabs">
                <button class="code-canvas-tab active" data-tab="editor">Code</button>
                <button class="code-canvas-tab" data-tab="preview">Preview</button>
                <button class="code-canvas-tab" data-tab="output">Output</button>
            </div>
            <div class="code-canvas-controls">
                <button class="code-canvas-btn primary" id="runCodeBtn">
                    <i class="fas fa-play"></i> Run
                </button>
                <button class="code-canvas-btn" id="downloadCodeBtn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="code-canvas-btn" id="shareCodeBtn">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
            <button class="code-canvas-close" id="codeCanvasClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="code-canvas-content">
            <div class="code-editor-panel" id="editorPanel">
                <div class="code-editor" id="codeEditor"></div>
            </div>
            <div class="code-preview-panel" id="previewPanel" style="display: none;">
                <div class="code-preview-header">
                    <div class="code-preview-url" id="previewUrl">Preview</div>
                    <button class="code-canvas-btn" id="openInNewTab">
                        <i class="fas fa-external-link-alt"></i> New Tab
                    </button>
                </div>
                <iframe class="code-preview-iframe" id="previewFrame"></iframe>
            </div>
            <div class="code-output" id="outputPanel" style="display: none;"></div>
        </div>
        <div class="code-canvas-loading" id="codeCanvasLoading" style="display: none;">
            <i class="fas fa-spinner"></i>
            <span>Running code...</span>
        </div>
    </div>

    <!-- Socket.IO Client -->
<script>
class CodeCanvas {
    constructor() {
        this.canvas = document.getElementById('codeCanvas');
        this.editor = null;
        this.code = '';
        this.currentLanguage = 'html';
        this.currentTab = 'editor';
        this.bindEvents();
    }

    bindEvents() {
        // Tab switching
        document.querySelectorAll('.code-canvas-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                this.switchTab(e.target.dataset.tab);
            });
        });

        // Control buttons
        document.getElementById('runCodeBtn').addEventListener('click', () => this.runCode());
        document.getElementById('downloadCodeBtn').addEventListener('click', () => this.downloadCode());
        document.getElementById('shareCodeBtn').addEventListener('click', () => this.shareCode());
        document.getElementById('openInNewTab').addEventListener('click', () => this.openInNewTab());
        document.getElementById('codeCanvasClose').addEventListener('click', () => this.close());
    }

    switchTab(tabName) {
        // Update active tab
        document.querySelectorAll('.code-canvas-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Show/hide panels
        document.getElementById('editorPanel').style.display = tabName === 'editor' ? 'flex' : 'none';
        document.getElementById('previewPanel').style.display = tabName === 'preview' ? 'flex' : 'none';
        document.getElementById('outputPanel').style.display = tabName === 'output' ? 'block' : 'none';

        this.currentTab = tabName;

        if (tabName === 'preview' && this.currentLanguage === 'html') {
            this.updatePreview();
        }
    }

    updatePreview() {
        const previewFrame = document.getElementById('previewFrame');
        const code = this.editor ? this.editor.getValue() : this.code;
        const blob = new Blob([code], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        previewFrame.src = url;
    }

    runCode() {
        const code = this.editor ? this.editor.getValue() : this.code;
        const outputPanel = document.getElementById('outputPanel');

        if (this.currentLanguage === 'html') {
            this.switchTab('preview');
            this.updatePreview();
        } else if (this.currentLanguage === 'python') {
            // For Python, we'd need a backend service
            outputPanel.textContent = 'Python execution requires backend service...';
            this.switchTab('output');
        } else if (this.currentLanguage === 'javascript') {
            // Execute JavaScript more safely using Function constructor
            try {
                const func = new Function(code);
                const result = func();
                outputPanel.textContent = `Output: ${result}`;
            } catch (error) {
                outputPanel.textContent = `Error: ${error.message}`;
            }
            this.switchTab('output');
        }
    }

    downloadCode() {
        const code = this.editor ? this.editor.getValue() : this.code;
        const filename = this.getFilename();
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    shareCode() {
        const code = this.editor ? this.editor.getValue() : this.code;
        // For now, copy to clipboard
        navigator.clipboard.writeText(code).then(() => {
            alert('Code copied to clipboard!');
        }).catch(() => {
            // Fallback
            const textArea = document.createElement('textarea');
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Code copied to clipboard!');
        });
    }

    openInNewTab() {
        if (this.currentLanguage === 'html') {
            const code = this.editor ? this.editor.getValue() : this.code;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
    }

    getFilename() {
        const extensions = { html: 'html', javascript: 'js', python: 'py', css: 'css' };
        return `code-canvas.${extensions[this.currentLanguage] || 'txt'}`;
    }

    open(code, language = 'html', title = 'Code Canvas') {
        this.canvas.classList.add('open');
        document.getElementById('codeCanvasTitle').textContent = title;

        if (code && this.editor) {
            this.editor.setValue(code);
            this.editor.setModelLanguage(this.editor.getModel(), language);
        }

        this.currentLanguage = language;
        this.code = code || this.getDefaultCode();

        // Auto-switch to preview for HTML
        if (language === 'html') {
            setTimeout(() => this.switchTab('preview'), 500);
        }
    }

    close() {
        this.canvas.classList.remove('open');
    }
}

// Function to extract and open code from AI responses
function openCodeInCanvas(codeText, language = 'html', title = 'AI Generated Code') {
    // Extract code from markdown code blocks
    const htmlBlockRegex = /```html\s*([\s\S]*?)```/i;
    const jsBlockRegex = /```(?:javascript|js)\s*([\s\S]*?)```/i;
    const pyBlockRegex = /```python\s*([\s\S]*?)```/i;

    let extractedCode = codeText;
    let detectedLanguage = language;

    if (htmlBlockRegex.test(codeText)) {
        extractedCode = codeText.match(htmlBlockRegex)[1].trim();
        detectedLanguage = 'html';
    } else if (jsBlockRegex.test(codeText)) {
        extractedCode = codeText.match(jsBlockRegex)[1].trim();
        detectedLanguage = 'javascript';
    } else if (pyBlockRegex.test(codeText)) {
        extractedCode = codeText.match(pyBlockRegex)[1].trim();
        detectedLanguage = 'python';
    }

    window.codeCanvas.open(extractedCode, detectedLanguage, title);
}

// Add code canvas trigger buttons to messages with code
function addCodeCanvasTriggers() {
    const messages = document.querySelectorAll('.message');
    if (!messages || messages.length === 0) return; // Add this check

    messages.forEach(message => {
        const codeBlocks = message.querySelectorAll('pre code');
        if (codeBlocks.length > 0 && !message.querySelector('.code-canvas-trigger')) {
            message.classList.add('has-code');
            const trigger = document.createElement('button');
            trigger.className = 'code-canvas-trigger';
            trigger.innerHTML = '📝 Open in Canvas';
            trigger.onclick = (e) => {
                e.stopPropagation();
                const messageText = message.textContent || message.innerText;
                openCodeInCanvas(messageText, 'html', 'AI Generated Code');
            };
            message.style.position = 'relative';
            message.appendChild(trigger);
        }
    });
}

// Ensure DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (typeof CodeCanvas !== 'undefined') {
            window.codeCanvas = new CodeCanvas();
        }
        addCodeCanvasTriggers();

        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            const observer = new MutationObserver(() => {
                addCodeCanvasTriggers();
            });
            observer.observe(messagesContainer, { childList: true, subtree: true });
        }
    }, 100);
});
</script>
</body>
</html>